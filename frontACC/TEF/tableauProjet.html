<!DOCTYPE html>
<html lang="fr">
<head>
  	<meta charset="utf-8">
  	<title>Popup</title>
  	<script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
	<!-- <script language="javascript" src="Tools/ToolsCommon80.js"></script> -->
    <script src="popupFormation.html"></script>
    <link rel="stylesheet" href="css/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="css/tableau.css">
</head>
<body>
    <input type="text" name="sauvegarde" id="sauvegarde" placeholder="Nom de sauvegarde">
    <button id="sauvegarder">Sauvegarder</button>
    <p id="Savetips"><i>Rentrez un nom pour sauvegarder le projet</i></p>
    <hr style="margin-bottom: 0;">

    <script>
        function filtres() {
            var foo = document.getElementById("filtres");
            if (foo.style.display === "block") {
                foo.style.display = "none";
                $("#titre-filtres").html("Filtrer &#11205;"); // Flèche vers le bas
            } else {
                foo.style.display = "block";
                $("#titre-filtres").html("Filtrer &#11206;"); // Flèche vers le haut
            }
        }
    </script>
    <div id="div-titre-filtres">
        <button id="btn-filtres" onclick="filtres()">
            <h2 id="titre-filtres">Filtrer &#11205;</h2>
        </button>
    </div>
    <div id="filtres" style="display: none;">
        <div id="bloc-select">
            <div class="selects">
                <label for="owner-select">Propriétaire</label>
                <select name="owner-select" id="owner-select" multiple></select>
                <p><i>Utilisez CTRL + clic pour sélectionner/désélectionner plusieurs éléments</i></p>
            </div>

            <div class="selects">
                <label for="tarif-select">Tarif</label>
                <select name="tarif-select" id="tarif-select" multiple></select>
                <p><i>Utilisez CTRL + clic pour sélectionner/désélectionner plusieurs éléments</i></p>
            </div>
        </div>

        <div id="bloc-slider">
            <div class="sliders">
                <p>
                    <label for="amount">Conso 2023 : </label>
                    <input type="number" id="conso-annee-prec-amount-min" style="width:60px; color:#5d0f6d; font-weight:bold;"> -
                    <input type="number" id="conso-annee-prec-amount-max" style="width:60px; color:#5d0f6d; font-weight:bold;">
                </p>
                <div id="slider-range-conso-annee-prec"></div>
            </div>

            <div class="sliders">
                <p>
                    <label for="amount">Puissance Souscrite Réduite : </label>
                    <input type="number" id="psr-amount-min" style="width:60px; color:#5d0f6d; font-weight:bold;"> -
                    <input type="number" id="psr-amount-max" style="width:60px; color:#5d0f6d; font-weight:bold;">
                </p>
                <div id="slider-range-psr"></div>
            </div>
        </div>
        <div id="div-tout">
            <button id="tout">Tout</button>
        </div>
    </div>
    
    <hr>
    <h2>Compteurs dans le périmètre</h2>
    <table id="table-data">
        <thead id="thead-data"></thead>
        <tbody id="data"></tbody>
    </table>
    
    <hr>
    <h2>Compteurs exclus du projet</h2>
    <table id="table-deprecie">
        <thead id="thead-deprecie"></thead>
        <tbody id="deprecie"></tbody>
    </table>
	
    <script>
        $("#thead-data").empty();
        $("#thead-deprecie").empty();
        $("#data").empty();
        $("#deprecie").empty();
        $("#owner-select").empty();
        $("#tarif-select").empty();

        var currentTriData = null;
        var currentTriDeprecie = null;

        function moveRow(checkbox) {
            // Fonction pour déplacer une ligne entre les tableaux
            
            const row = checkbox.closest('tr');
            const currentTable = row.closest('table').id;
            const targetTableId = currentTable === 'table-data' ? 'table-deprecie' : 'table-data';
            const targetTable = document.getElementById(targetTableId).querySelector('tbody');
            row.remove();
            targetTable.appendChild(row);
            checkbox.checked = targetTableId === 'table-data';
        }

        function addItem(dict) {
            // Fonction pour ajouter les noms de champs aux tableaux

            $("#thead-data").empty();
            $("#thead-deprecie").empty();
            $("#data").empty();
            $("#deprecie").empty();
            $("#owner-select").empty();
            $("#tarif-select").empty();

            // Année en cours
            const current_year = new Date().getFullYear();

            let lignes = `<tr>
                <td></td>
                <td class="htitre">ID</td>
                <td class="htitre">Nom</td>
                <td class="htitre">Propriétaire</td>
                <td class="htitre">
                    Conso ${current_year - 1}
                    <span class="tri desactive" data-index="4" >⇅</span>
                </td>
                <td class="htitre">
                    Conso ${current_year - 2}
                    <span class="tri desactive" data-index="5" >⇅</span>
                </td>
                <td class="htitre">
                    Conso ${current_year - 3}
                    <span class="tri desactive" data-index="6" >⇅</span>
                </td>
                <td class="htitre">
                    Conso ${current_year - 4}
                    <span class="tri desactive" data-index="7" >⇅</span>
                </td>
                <td class="htitre">
                    PSR 
                    <span class="tooltip" data-tooltip="Puissance Souscrite Réduite">
                        &#128712
                    </span>
                </td>
                <td class="htitre">Num. RAE PCE</td>
                <td class="htitre">Nom tarif</td>
                <td class="htitre">Invariant</td>
            </tr>`;

            $("#thead-data").append(lignes);
            $("#thead-deprecie").append(lignes);

            // 1. Récupérer tous les propriétaires et tarifs uniques
            let allOwners = new Set();
            let allTarifs = new Set();


            if (dict.data && Array.isArray(dict.data)) {
                dict.data.forEach(item => {
                    if (item.owner) allOwners.add(item.owner);
                    if (item.nomTarif) allTarifs.add(item.nomTarif);
                });
            }
            if (dict.deprecie && Array.isArray(dict.deprecie)) {
                dict.deprecie.forEach(item => {
                    if (item.owner) allOwners.add(item.owner);
                    if (item.nomTarif) allTarifs.add(item.nomTarif);
                });
            }

            // 2. Remplir les selects avec toutes les valeurs uniques
            allOwners.forEach(owner => {
                $("#owner-select").append(`<option value="${owner}">${owner}</option>`);
            });
            allTarifs.forEach(tarif => {
                $("#tarif-select").append(`<option value="${tarif}">${tarif}</option>`);
            });

            // 3. Charger toutes les données dans les tableaux (dans #data par défaut)
            let allItems = [];
            if (dict.data && Array.isArray(dict.data)) allItems = allItems.concat(dict.data);
            if (dict.deprecie && Array.isArray(dict.deprecie)) allItems = allItems.concat(dict.deprecie);

            console.log(allItems);

            // Ajoute tout dans #data pour appliquer les filtres
            $("#data").empty();
            allItems.forEach(function(item) {
                let font = item.producteur ? "bold" : "normal";
                console.log(item);
                $("#data").append(
                    `<tr>
                        <td class="value checkbox-arrow">
                            <input type="checkbox" class="test" name="test" checked onchange="moveRow(this)" />
                            <span class="arrow"></span>
                        </td>
                        <td class="value" style="font-weight: ${font}">${item.id}</td>
                        <td class="value" style="font-weight: ${font}">${item.nom}</td>
                        <td class="value" style="font-weight: ${font}">${item.owner}</td>
                        <td class="value" style="font-weight: ${font}">${item.consoNmoins1}</td>
                        <td class="value" style="font-weight: ${font}">${item.consoNmoins2}</td>
                        <td class="value" style="font-weight: ${font}">${item.consoNmoins3}</td>
                        <td class="value" style="font-weight: ${font}">${item.consoNmoins4}</td>
                        <td class="value" style="font-weight: ${font}">${item.psr}</td>
                        <td class="value" style="font-weight: ${font}">${item.numRaePce}</td>
                        <td class="value" style="font-weight: ${font}">${item.nomTarif}</td>
                        <td class="value" style="font-weight: ${font}">${item.invariant}</td>
                    </tr>`
                );
            });

            updateMaxConsoAnneePrecedente();
            updateMaxPSR();

            // 4. Appliquer les filtres (répartit dans #data et #deprecie)
            appliquerFiltresDepuisDonnees(dict.filters);
            applyAllFilters();

            // 5. Répartir selon le JSON (priorité à la sauvegarde)
            // On va déplacer les lignes selon leur id
            let idsData = new Set((dict.data || []).map(item => item.id));
            let idsDeprecie = new Set((dict.deprecie || []).map(item => item.id));

            // Déplacer dans #data ceux du JSON data
            $("#data tr").each(function() {
                let id = $(this).find("td").eq(1).text().trim();
                if (!idsData.has(id)) {
                    $("#deprecie").append($(this));
                    $(this).find('input[type="checkbox"]').prop('checked', false);
                } else {
                    $(this).find('input[type="checkbox"]').prop('checked', true);
                }
            });
            // Déplacer dans #deprecie ceux du JSON deprecie
            $("#deprecie tr").each(function() {
                let id = $(this).find("td").eq(1).text().trim();
                if (idsData.has(id)) {
                    $("#data").append($(this));
                    $(this).find('input[type="checkbox"]').prop('checked', true);
                } else if (!idsDeprecie.has(id)) {
                    // Si l'id n'est dans aucun des deux, on le retire (optionnel)
                    $(this).remove();
                }
            });

            appliquerTriDepuisDonnees(dict.tri_data, "#thead-data", "#data");
            appliquerTriDepuisDonnees(dict.tri_deprecie, "#thead-deprecie", "#deprecie");
            currentTriData = dict.tri_data || null;
            currentTriDeprecie = dict.tri_deprecie || null;
	    }

        // async function chargerDonnees(donnees) {
        //     // Fonction pour charger les données dans les tableaux

        //     if (donnees.data && Array.isArray(donnees.data)) {
        //         donnees.data.forEach(function(item) {
        //             let font = item.producteur ? "bold" : "normal";
        //             $("#data").append(
        //                 `<tr onclick="
        //                         console.log('Ligne cliquée');
        //                         let SGWorld = parent.SGWorld;
        //                         let pos = SGWorld.Creator.CreatePosition(${x}, ${y}, 0, 2, 0, -75, 0, 1000);
		//                         SGWorld.Navigate.FlyTo(pos, 0);
        //                         "
        //                     title="Cliquez sur la ligne pour zoomer sur le compteur">
        //                     <td class="value checkbox-arrow">
        //                         <input type="checkbox" class="test" name="test" checked onchange="moveRow(this)" />
        //                         <span class="arrow"></span>
        //                     </td>
        //                     <td class="value" style="font-weight: ${font}">${item.id}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.nom}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.owner}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins1}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins2}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins3}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins4}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.psr}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.numRaePce}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.nomTarif}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.invariant}</td>
        //                 </tr>`
        //             );
        //         });
        //     }
        //     // Ajoute les lignes dans #deprecie
        //     if (donnees.deprecie && Array.isArray(donnees.deprecie)) {
        //         donnees.deprecie.forEach(function(item) {
        //             let font = item.producteur ? "bold" : "normal";
        //             $("#deprecie").append(
        //                 `<tr onclick="
        //                         console.log('Ligne cliquée');
        //                         let SGWorld = parent.SGWorld;
        //                         let pos = SGWorld.Creator.CreatePosition(${x}, ${y}, 0, 2, 0, -75, 0, 1000);
		//                         SGWorld.Navigate.FlyTo(pos, 0);
        //                         "
        //                     title="Cliquez sur la ligne pour zoomer sur le compteur">
        //                     <td class="value checkbox-arrow">
        //                         <input type="checkbox" class="test" name="test" onchange="moveRow(this)" />
        //                         <span class="arrow"></span>
        //                     </td>
        //                     <td class="value" style="font-weight: ${font}">${item.id}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.nom}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.owner}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins1}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins2}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins3}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.consoNmoins4}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.psr}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.numRaePce}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.nomTarif}</td>
        //                     <td class="value" style="font-weight: ${font}">${item.invariant}</td>
        //                 </tr>`
        //             );
        //         });
        //     }
        //     updateMaxConsoAnneePrecedente();
        //     updateMaxPSR();
        // }

        var turn = 0;
        function updateMaxConsoAnneePrecedente() {
            // Fonction pour mettre à jour le maximum du slider de consommation 2023

            let nbData = $("#data tr").length - 1;      // -1 pour ignorer l'en-tête
            let nbDeprecie = $("#deprecie tr").length - 1;
            let total = nbData + nbDeprecie;
            let max = 0;
            // Parcourt toutes les lignes des deux tableaux (sauf l'en-tête)
            $("#data tr, #deprecie tr").each(function(index) {
                if (index === 0) return; // Ignore l'en-tête
                let conso = $(this).find("td").eq(4).text().replace(" kWh", "").replace("-", "").trim();
                let val = parseInt(conso);
                if (!isNaN(val) && val > max) max = val;
                max += 1000; // Ajoute 1000 pour avoir une marge de sécurité
            });
            // Met à jour le slider et l'input max
            $("#slider-range-conso-annee-prec").slider("option", "max", max);
            if (turn <= total) {
                $("#conso-annee-prec-amount-max").attr("max", max).val(max);
                turn++;
            }
            // Met à jour les valeurs du slider pour couvrir toute la plage
            // $("#slider-range-conso-annee-prec").slider("values", [0, 50000]);
            // $("#conso-annee-prec-amount-min").val(0);
            let currentMin = parseInt($("#conso-annee-prec-amount-min").val()) || 0;
            let currentMax = parseInt($("#conso-annee-prec-amount-max").val()) || 0;
            if (currentMax > max) {
                //$("#conso-annee-prec-amount-max").val(max);
                $("#slider-range-conso-annee-prec").slider("values", [currentMin, max]);
            } else {
                $("#conso-annee-prec-amount-min").val(currentMin);
                $("#conso-annee-prec-amount-max").val(currentMax);
                $("#slider-range-conso-annee-prec").slider("values", [currentMin, currentMax]);
            }
        }

        var turn2 = 0;
        function updateMaxPSR() {
            // Fonction pour mettre à jour le maximum du slider de Puissance Souscrite Réduite (PSR)

            let nbData = $("#data tr").length - 1;      // -1 pour ignorer l'en-tête
            let nbDeprecie = $("#deprecie tr").length - 1;
            let total = nbData + nbDeprecie;
            let max = 0;
            // Parcourt toutes les lignes des deux tableaux (sauf l'en-tête)
            $("#data tr, #deprecie tr").each(function(index) {
                if (index === 0) return; // Ignore l'en-tête
                let psr = $(this).find("td").eq(8).text().replace(" kWh", "").replace("-", "").trim();
                let val = parseInt(psr);
                if (!isNaN(val) && val > max) max = val;
                max += 10; // Ajoute 10 pour avoir une marge de sécurité
            });
            // Met à jour le slider et l'input max
            $("#slider-range-psr").slider("option", "max", max);
            if (turn2 <= total) {
                $("#psr-amount-max").attr("max", max).val(max);
                turn2++;
            }
            // Met à jour les valeurs du slider pour couvrir toute la plage
            // $("#slider-range-psr").slider("values", [0, 50000]);
            // $("#conso-annee-prec-amount-min").val(0);
            let currentMin = parseInt($("#psr-amount-min").val()) || 0;
            let currentMax = parseInt($("#psr-amount-max").val()) || 0;
            if (currentMax > max) {
                //$("#conso-annee-prec-amount-max").val(max);
                $("#slider-range-psr").slider("values", [currentMin, max]);
            } else {
                $("#psr-amount-min").val(currentMin);
                $("#psr-amount-max").val(currentMax);
                $("#slider-range-psr").slider("values", [currentMin, currentMax]);
            }
        }

        // Initialisation des sliders pour la consommation 2023
        $(function() {
            $("#slider-range-conso-annee-prec").slider({
                range: true,
                min: 0,
                max: 1,
                values: [0, 1],
                slide: function(event, ui) {
                    $("#conso-annee-prec-amount-min").val(ui.values[0]);
                    $("#conso-annee-prec-amount-max").val(ui.values[1]);
                }
            });
            $("#conso-annee-prec-amount-min").val($("#slider-range-conso-annee-prec").slider("values", 0));
            $("#conso-annee-prec-amount-max").val($("#slider-range-conso-annee-prec").slider("values", 1));
            $("#conso-annee-prec-amount-min, #conso-annee-prec-amount-max").on("input change", function() {
                let min = parseInt($("#conso-annee-prec-amount-min").val()) || 0;
                let max = parseInt($("#conso-annee-prec-amount-max").val()) || 0;
                if (min > max) min = max;
                $("#slider-range-conso-annee-prec").slider("values", [min, max]);
            });

            // function filterBySlider() {
            //     let min = parseInt($("#conso-annee-prec-amount-min").val()) || 0;
            //     let max = parseInt($("#conso-annee-prec-amount-max").val()) || 0;
            //     $("#data tr").each(function(index) {
            //         if (index === 0) return; // Ignore l'en-tête
            //         let conso = $(this).find("td").eq(4).text().replace(" kWh", "").replace("-", "").trim();
            //         let consoVal = parseInt(conso) || 0;
            //         if (consoVal < min || consoVal > max) {
            //             $("#deprecie").append($(this));
            //             $(this).find('input[type="checkbox"]').prop('checked', false);
            //         }
            //     });

            //     $("#deprecie tr").each(function(index) {
            //         if (index === 0) return; // Ignore l'en-tête
            //         let conso = $(this).find("td").eq(4).text().replace(" kWh", "").replace("-", "").trim();
            //         let consoText = $(this).find("td").eq(4).text().trim();
            //         let consoVal = parseInt(conso) || 0;
            //         if (consoVal >= min && consoVal <= max && consoText !== "0 kWh" && consoText !== "-") {
            //             $("#data").append($(this));
            //             $(this).find('input[type="checkbox"]').prop('checked', true);
            //         }
            //     });
            //     updateMaxConsoAnneePrecedente();
            // }

            // // Appelle le filtre à chaque changement du slider ou des inputs
            // $("#slider-range-conso-annee-prec").on("slide", filterBySlider);
            // $("#conso-annee-prec-amount-min, #conso-annee-prec-amount-max").on("input change", filterBySlider);
        });

        // Initialisation des sliders pour PSR
        $(function() {
            $("#slider-range-psr").slider({
                range: true,
                min: 0,
                max: 1,
                values: [0, 1],
                slide: function(event, ui) {
                    $("#psr-amount-min").val(ui.values[0]);
                    $("#psr-amount-max").val(ui.values[1]);
                }
            });
            $("#psr-amount-min").val($("#slider-range-psr").slider("values", 0));
            $("#psr-amount-max").val($("#slider-range-psr").slider("values", 1));
            $("#psr-amount-min, #psr-amount-max").on("input change", function() {
                let min = parseInt($("#psr-amount-min").val()) || 0;
                let max = parseInt($("#psr-amount-max").val()) || 0;
                if (min > max) min = max;
                $("#slider-range-psr").slider("values", [min, max]);
            });
        });


        window.addEventListener("message", function(event) {
            if (event.data.type === "sauvegarde") {
                let donnees = event.data.donnees;
                donnees = JSON.parse(donnees);
                if (donnees) {
                    $("#sauvegarde").val(event.data.nom);
                    addItem(donnees);
                } else {
                    console.error("Les données reçues ne sont pas valides ou sont vides.");
                }
            }
        });

        var etat = 0; // 0 - désactivé; 1 - activé bas; 2 - activé haut
        $(document).on("click", ".tri", function() {
            let $this = $(this);
            let colIndex = parseInt($this.data("index")); // Récupérer l'index de la colonne à trier

            // Remettre tous les autres .tri du même tableau à l'état 0
            $this.closest("table").find(".tri").not($this).each(function() {
                $(this)
                    .data("etat", 0)
                    .removeClass("active-bas active-haut")
                    .addClass("desactive")
                    .html("⇅");
            });

            let etat = $this.data("etat") || 0; // Récupérer l'état actuel ou initialiser à 0

            $this.html("");
            if (etat === 0) {
                $this.removeClass("desactive").addClass("active-bas").html("↓");
                etat = 1;
            } else if (etat === 1) {
                $this.removeClass("active-bas").addClass("active-haut").html("↑");
                etat = 2;
            } else {
                $this.removeClass("active-haut").addClass("desactive").html("⇅");
                etat = 0;
            }
            $this.data("etat", etat); // Mettre à jour l'état dans l'élément cliqué

            let tbody = $this.closest("table").find("tbody");
            let rows = tbody.find("tr").get();
            rows.sort(function(a, b) {
                let keyA = $(a).find(".value").eq(colIndex).text();
                let keyB = $(b).find(".value").eq(colIndex).text();
                let keyNomA = $(a).find(".value").eq(2).text().toLowerCase(); // Nom
                let keyNomB = $(b).find(".value").eq(2).text().toLowerCase(); // Nom

                if (etat === 1 || etat === 2) {
                    if (keyA === "-") return 1;
                    if (keyB === "-") return -1;
                }
                
                if (etat === 1) {
                    // Tri croissant conso 2023, tri alphabétique sur Nom si égalité
                    let diff = parseFloat(keyA) - parseFloat(keyB); // Tri croissant
                    if (diff === 0) {
                        return keyNomA.localeCompare(keyNomB);
                    }
                    return diff;
                } else if (etat === 2) {
                    // Tri décroissant conso 2023, tri alphabétique sur Nom si égalité
                    let diff = parseFloat(keyB) - parseFloat(keyA); // Tri croissant
                    if (diff === 0) {
                        return keyNomA.localeCompare(keyNomB);
                    }
                    return diff;
                } else {
                    return keyNomA.localeCompare(keyNomB);
                }
            });
            $.each(rows, function(index, row) {
                tbody.append(row);
            });

            if ($this.closest("table").attr("id") === "table-data") {
                currentTriData = { colIndex: colIndex, etat: etat };
                appliquerTriDepuisDonnees(currentTriData, "#thead-data", "#data");
            } else {
                currentTriDeprecie = { colIndex: colIndex, etat: etat };
                appliquerTriDepuisDonnees(currentTriDeprecie, "#thead-deprecie", "#deprecie");
            }
        });

        // Filtrage dynamique selon la sélection du propriétaire
        //$("#owner-select").on("change", function() {
            // let selectedOwners = $(this).val() || [];

            // // Parcourt chaque ligne du tableau #data (sauf l'en-tête)
            // $("#data tr").each(function(index) {
            //     if (index === 0) return; // Ignore l'en-tête
            //     let owner = $(this).find("td").eq(3).text().trim();
            //     if (!selectedOwners.includes(owner)) {
            //         $("#deprecie").append($(this));
            //         // décoche la case si besoin
            //         $(this).find('input[type="checkbox"]').prop('checked', false);
            //     }
            // });

            // $("#deprecie tr").each(function(index) {
            //     if (index === 0) return; // Ignore l'en-tête
            //     let owner = $(this).find("td").eq(3).text().trim();
            //     let consoNmoins1 = $(this).find("td").eq(4).text().trim();
            //     if (selectedOwners.includes(owner) && consoNmoins1 !== "0 kWh" && consoNmoins1 !== "-") {
            //         $("#data").append($(this));
            //         // coche la case si besoin
            //         $(this).find('input[type="checkbox"]').prop('checked', true);
            //     }
            // });
        //     updateMaxConsoAnneePrecedente();
        // });

        // Filtrage dynamique selon la sélection du propriétaire
        // $("#tarif-select").on("change", function() {
            // let selectedTarifs = $(this).val() || [];

            // // Parcourt chaque ligne du tableau #data (sauf l'en-tête)
            // $("#data tr").each(function(index) {
            //     if (index === 0) return; // Ignore l'en-tête
            //     let tarif = $(this).find("td").eq(10).text().trim();
            //     if (!selectedTarifs.includes(tarif)) {
            //         $("#deprecie").append($(this));
            //         // décoche la case si besoin
            //         $(this).find('input[type="checkbox"]').prop('checked', false);
            //     }
            // });

            // $("#deprecie tr").each(function(index) {
            //     if (index === 0) return; // Ignore l'en-tête
            //     let tarif = $(this).find("td").eq(10).text().trim();
            //     let consoNmoins1 = $(this).find("td").eq(4).text().trim();
            //     if (selectedTarifs.includes(tarif) && consoNmoins1 !== "0 kWh" && consoNmoins1 !== "-") {
            //         $("#data").append($(this));
            //         // coche la case si besoin
            //         $(this).find('input[type="checkbox"]').prop('checked', true);
            //     }
            // });
        //     updateMaxConsoAnneePrecedente();
        // });

        // Pour appliquer le filtre après ajout de lignes (optionnel)
        function applyOwnerFilter() {
            $("#owner-select").trigger("change");
        }
        applyOwnerFilter();

        // Sélectionner toutes les options quand le bouton "Tout" est cliqué
        $("#tout").on("click", function() {
            $("#owner-select option").prop("selected", true);
            $("#owner-select").trigger("change");
            $("#tarif-select option").prop("selected", true);
            $("#tarif-select").trigger("change");
            $("#conso-annee-prec-amount-min").val(0);
            $("#conso-annee-prec-amount-max").val($("#slider-range-conso-annee-prec").slider("option", "max"));
            $("#slider-range-conso-annee-prec").slider("values", [0, $("#slider-range-conso-annee-prec").slider("option", "max")]);
            $("#psr-amount-min").val(0);
            $("#psr-amount-max").val($("#slider-range-psr").slider("option", "max"));
            $("#slider-range-psr").slider("values", [0, $("#slider-range-psr").slider("option", "max")]);
        });

        function triggerZoom() {
            // J'ai aucune idée de ce que ça fait mais dans le doute touchez y pas svp
            element.classList.remove('zoom'); // reset animation
            void element.offsetWidth; // force reflow
            element.classList.add('zoom');
            count++;
            if (count < maxRepeats) {
                setTimeout(triggerZoom, 1000); // durée de l'animation
            }
        }


        $("#sauvegarder").on("click", function() {
            // Sauvegarde du projet

            let nomSauvegarde = $("#sauvegarde").val().trim();
            if (nomSauvegarde != "") { // Si un nom de sauvegarde est entré
                // 1. Sauvegarde des tableaux
                let data = [];
                $("#data tr").each(function(index) {
                    let row = $(this);
                    let firstTd = row.find("td").eq(1);
                    let fontWeight = firstTd.css("font-weight");
                    let producteur = false;
                    if (fontWeight === "700") {
                        producteur = true; // Si la première cellule est en gras, c'est un producteur
                    }
                    data.push({
                        id: row.find("td").eq(1).text().trim(),
                        nom: row.find("td").eq(2).text().trim(),
                        owner: row.find("td").eq(3).text().trim(),
                        consoNmoins1: row.find("td").eq(4).text().trim(),
                        consoNmoins2: row.find("td").eq(5).text().trim(),
                        consoNmoins3: row.find("td").eq(6).text().trim(),
                        consoNmoins4: row.find("td").eq(7).text().trim(),
                        psr: row.find("td").eq(8).text().trim(),
                        numRaePce: row.find("td").eq(9).text().trim(),
                        nomTarif: row.find("td").eq(10).text().trim(),
                        invariant: row.find("td").eq(11).text().trim(),
                        producteur: producteur
                    });
                });
                let deprecie = [];
                $("#deprecie tr").each(function(index) {
                    let row = $(this);
                    let firstTd = row.find("td").eq(1);
                    let fontWeight = firstTd.css("font-weight");
                    let producteur = false;
                    if (fontWeight === "700") {
                        producteur = true; // Si la première cellule est en gras, c'est un producteur
                    }
                    deprecie.push({
                        id: row.find("td").eq(1).text().trim(),
                        nom: row.find("td").eq(2).text().trim(),
                        owner: row.find("td").eq(3).text().trim(),
                        consoNmoins1: row.find("td").eq(4).text().trim(),
                        consoNmoins2: row.find("td").eq(5).text().trim(),
                        consoNmoins3: row.find("td").eq(6).text().trim(),
                        consoNmoins4: row.find("td").eq(7).text().trim(),
                        psr: row.find("td").eq(8).text().trim(),
                        numRaePce: row.find("td").eq(9).text().trim(),
                        nomTarif: row.find("td").eq(10).text().trim(),
                        invariant: row.find("td").eq(11).text().trim(),
                        producteur: producteur
                    });
                });

                // 2. Sauvegarde des filtres
                let filters = {
                    owners: $("#owner-select").val() || [],
                    tarifs: $("#tarif-select").val() || [],
                    consoMin: $("#conso-annee-prec-amount-min").val(),
                    consoMax: $("#conso-annee-prec-amount-max").val(),
                    psrMin: $("#psr-amount-min").val(),
                    psrMax: $("#psr-amount-max").val()
                };

                // 3. Sauvegarde des tris
                function getTriData() {
                    let tri_data = null;
                    $("#thead-data .tri").each(function() {
                        let etat = $(this).data("etat") || 0;
                        if (etat && etat !== 0) {
                            tri_data = {
                                colIndex: $(this).data("index"),
                                etat: etat
                            };
                        }
                    });
                    return tri_data;
                }

                function getTriDeprecie() {
                    let tri_deprecie = null;
                    $("#thead-deprecie .tri").each(function() {
                        let etat = $(this).data("etat") || 0;
                        if (etat && etat !== 0) {
                            tri_deprecie = {
                                colIndex: $(this).data("index"),
                                etat: etat
                            };
                        }
                    });
                    return tri_deprecie;
                }
                let tri_data = getTriData();
                let tri_deprecie = getTriDeprecie();

                // 4. Stockage dans le localStorage
                let sauvegarde = {
                    data: data,
                    deprecie: deprecie,
                    filters: filters,
                    tri_data: tri_data,
                    tri_deprecie: tri_deprecie
                };
                // Vérifie si une sauvegarde avec le même nom existe déjà
                if (localStorage.getItem("sauvegarde_" + nomSauvegarde)) {
                    localStorage.removeItem("sauvegarde_" + nomSauvegarde);
                }
                localStorage.setItem("sauvegarde_" + nomSauvegarde, JSON.stringify(sauvegarde));

                alert("Projet sauvegardé sous le nom : " + nomSauvegarde);
                window.parent.postMessage({
                    url: "popupFormation.html"
                }, "*");
                return;
            } else {
                const element = document.getElementById("Savetips");
                element.classList.add('zoom');
                setTimeout(function() {
                    element.classList.remove('zoom');
                }, 500); // durée de l'animation
                return;
            }
        });

        function applyAllFilters() {
            // Applique tous les filtres en fonction des sélections et des valeurs des sliders
            let selectedOwners = $("#owner-select").val() || [];
            let selectedTarifs = $("#tarif-select").val() || [];
            let min = parseInt($("#conso-annee-prec-amount-min").val()) || 0;
            let max = parseInt($("#conso-annee-prec-amount-max").val()) || 0;
            let psrMin = parseInt($("#psr-amount-min").val()) || 0;
            let psrMax = parseInt($("#psr-amount-max").val()) || 0;

            // Récupère toutes les lignes (hors en-tête)
            let allRows = [];
            $("#data tr, #deprecie tr").each(function() {
                let $row = $(this);
                // Ignore l'en-tête (pas de checkbox dans l'en-tête)
                if ($row.find("input[type='checkbox']").length) {
                    allRows.push($row);
                }
            });

            // Vide les deux tableaux
            $("#data").empty();
            $("#deprecie").empty();

            // Répartit les lignes selon les filtres
            allRows.forEach(function($row) {
                let owner = $row.find("td").eq(3).text().trim();
                let tarif = $row.find("td").eq(10).text().trim();
                let consoText = $row.find("td").eq(4).text().trim();
                let conso = consoText.replace(" kWh", "").replace("-", "").trim();
                let consoVal = parseInt(conso) || 0;
                let psrText = $row.find("td").eq(8).text().trim();
                let psrVal = parseInt(psrText) || 0;

                let ownerOk = selectedOwners.length === 0 || selectedOwners.includes(owner);
                let tarifOk = selectedTarifs.length === 0 || selectedTarifs.includes(tarif);
                let consoOk = consoVal >= min && consoVal <= max && consoText !== "0 kWh" && consoText !== "-";
                let psrOk = psrVal >= psrMin && psrVal <= psrMax;

                if (ownerOk && tarifOk && consoOk && psrOk) {
                    $("#data").append($row);
                    $row.find('input[type="checkbox"]').prop('checked', true);
                } else {
                    $("#deprecie").append($row);
                    $row.find('input[type="checkbox"]').prop('checked', false);
                }
            });

            updateMaxConsoAnneePrecedente();
            updateMaxPSR();

            // ...fin de la fonction applyAllFilters...
            if (currentTriData) {
                appliquerTriDepuisDonnees(currentTriData, "#thead-data", "#data");
            }
            if (currentTriDeprecie) {
                appliquerTriDepuisDonnees(currentTriDeprecie, "#thead-deprecie", "#deprecie");
            }
            
        }

        function appliquerFiltresDepuisDonnees(filters) {
            // Sélectionne les propriétaires
            if (filters.owners && Array.isArray(filters.owners)) {
                $("#owner-select option").each(function() {
                    $(this).prop("selected", filters.owners.includes($(this).val()));
                });
                $("#owner-select").trigger("change");
            }

            // Sélectionne les tarifs
            if (filters.tarifs && Array.isArray(filters.tarifs)) {
                $("#tarif-select option").each(function() {
                    $(this).prop("selected", filters.tarifs.includes($(this).val()));
                });
                $("#tarif-select").trigger("change");
            }

            // Conso 2023 min/max
            if (filters.consoMin !== undefined) {
                $("#conso-annee-prec-amount-min").val(filters.consoMin);
            }
            if (filters.consoMax !== undefined) {
                $("#conso-annee-prec-amount-max").val(filters.consoMax);
            }
            $("#slider-range-conso-annee-prec").slider("values", [
                parseInt(filters.consoMin) || 0,
                parseInt(filters.consoMax) || 0
            ]);

            // PSR min/max
            if (filters.psrMin !== undefined) {
                $("#psr-amount-min").val(filters.psrMin);
            }
            if (filters.psrMax !== undefined) {
                $("#psr-amount-max").val(filters.psrMax);
            }
            $("#slider-range-psr").slider("values", [
                parseInt(filters.psrMin) || 0,
                parseInt(filters.psrMax) || 0
            ]);
        }

        function appliquerTriDepuisDonnees(tri, theadSelector, tbodySelector) {
            // Applique le tri sur les données du tableau
            
            if (!tri || tri.colIndex === undefined || tri.etat === 0) return;

            // Met à jour l'état visuel du tri dans l'en-tête
            $(theadSelector + " .tri").each(function () {
                let $this = $(this);
                if (parseInt($this.data("index")) === tri.colIndex) {
                    $this.data("etat", tri.etat);
                    if (tri.etat === 1) $this.removeClass("desactive active-haut").addClass("active-bas").html("↓");
                    else if (tri.etat === 2) $this.removeClass("desactive active-bas").addClass("active-haut").html("↑");
                } else {
                    $this.data("etat", 0).removeClass("active-bas active-haut").addClass("desactive").html("⇅");
                }
            });

            // Trie les lignes du tbody
            let tbody = $(tbodySelector);
            let rows = tbody.find("tr").get();
            rows.sort(function (a, b) {
                let keyA = $(a).find(".value").eq(tri.colIndex).text();
                let keyB = $(b).find(".value").eq(tri.colIndex).text();
                let keyNomA = $(a).find(".value").eq(2).text().toLowerCase();
                let keyNomB = $(b).find(".value").eq(2).text().toLowerCase();

                if (tri.etat === 1 || tri.etat === 2) {
                    if (keyA === "-") return 1;
                    if (keyB === "-") return -1;
                }

                if (tri.etat === 1) {
                    // Tri croissant, alphabétique sur Nom si égalité
                    let diff = parseFloat(keyA) - parseFloat(keyB);
                    if (diff === 0) return keyNomA.localeCompare(keyNomB);
                    return diff;
                } else if (tri.etat === 2) {
                    // Tri décroissant, alphabétique sur Nom si égalité
                    let diff = parseFloat(keyB) - parseFloat(keyA);
                    if (diff === 0) return keyNomA.localeCompare(keyNomB);
                    return diff;
                } else {
                    return keyNomA.localeCompare(keyNomB);
                }
            });
            $.each(rows, function (index, row) {
                tbody.append(row);
            });
        }

        $("#owner-select, #tarif-select").on("change", applyAllFilters);
        $("#slider-range-conso-annee-prec").on("slide", applyAllFilters);
        $("#slider-range-psr").on("slide", applyAllFilters);
        $("#conso-annee-prec-amount-min, #conso-annee-prec-amount-max").on("input change", applyAllFilters);
        $("#psr-amount-min, #psr-amount-max").on("input change", applyAllFilters);
    </script>
</body>
</html>

