var services={GetPhotoParams:function(feature){var photoStruct={};photoStruct.visible=feature.FeatureAttributes.GetFeatureAttribute("visible").Value;var uidArr=feature.FeatureAttributes.GetFeatureAttribute("Uid").Value.split("\\");return photoStruct.Uid=uidArr[0]+"/"+uidArr[1],photoStruct.photo=null,application.photosLayer.DataSourceInfo.Attributes.IsAttributeExist("das_userfilename")?(photoStruct.photo=String(feature.GetProperty("UserFileName")),photoStruct.photo&&-1==photoStruct.photo.indexOf("http")&&(uidArr=(uidArr=application.photosLayer.DataSourceInfo.ConnectionString.split("Photos.gpkg")[0]).split("FileName=")[1],photoStruct.photo=uidArr+photoStruct.photo,photoStruct.photo=photoStruct.photo.split(".\\")[1],uidArr=SGWorld.Project.Name.lastIndexOf("\\"),uidArr=SGWorld.Project.Name.slice(0,uidArr),photoStruct.photo=uidArr+"\\"+photoStruct.photo)):0==settings.params.TileStreaming?photoStruct.photo=feature.FeatureAttributes.GetFeatureAttribute("path").Value:(uidArr=settings.params.SMPTAlternativePath,photoStruct.photo=uidArr+"\\"+photoStruct.Uid+".smpt"),photoStruct.photoName=String(photoStruct.photo.substring(photoStruct.photo.lastIndexOf("\\")+1)),photoStruct.focalNormilized=Number(feature.FeatureAttributes.GetFeatureAttribute("focallengthnormalized").Value),photoStruct.width=Number(feature.FeatureAttributes.GetFeatureAttribute("width").Value),photoStruct.height=Number(feature.FeatureAttributes.GetFeatureAttribute("height").Value),photoStruct.x=Number(feature.Geometry.X),photoStruct.y=Number(feature.Geometry.Y),photoStruct.z=Number(feature.Geometry.Z),photoStruct.LLx=Number(feature.FeatureAttributes.GetFeatureAttribute("x").Value),photoStruct.LLy=Number(feature.FeatureAttributes.GetFeatureAttribute("y").Value),photoStruct.LLz=Number(feature.FeatureAttributes.GetFeatureAttribute("altitude").Value),photoStruct.at_x=Number(feature.FeatureAttributes.GetFeatureAttribute("at_x").Value),photoStruct.at_y=Number(feature.FeatureAttributes.GetFeatureAttribute("at_y").Value),photoStruct.at_z=Number(feature.FeatureAttributes.GetFeatureAttribute("at_altitude").Value),photoStruct.k=[Number(feature.FeatureAttributes.GetFeatureAttribute("k1").Value),Number(feature.FeatureAttributes.GetFeatureAttribute("k2").Value),Number(feature.FeatureAttributes.GetFeatureAttribute("k3").Value)],photoStruct.p=[Number(feature.FeatureAttributes.GetFeatureAttribute("p1").Value),Number(feature.FeatureAttributes.GetFeatureAttribute("p2").Value)],photoStruct.omega=Number(feature.FeatureAttributes.GetFeatureAttribute("omega").Value),photoStruct.phi=Number(feature.FeatureAttributes.GetFeatureAttribute("phi").Value),photoStruct.kappa=Number(feature.FeatureAttributes.GetFeatureAttribute("kappa").Value),photoStruct.at_omega=Number(feature.FeatureAttributes.GetFeatureAttribute("at_omega").Value),photoStruct.at_phi=Number(feature.FeatureAttributes.GetFeatureAttribute("at_phi").Value),photoStruct.at_kappa=Number(feature.FeatureAttributes.GetFeatureAttribute("at_kappa").Value),photoStruct.yaw=Number(feature.FeatureAttributes.GetFeatureAttribute("te_yaw").Value),photoStruct.pitch=Number(feature.FeatureAttributes.GetFeatureAttribute("te_pitch").Value),photoStruct.roll=Number(feature.FeatureAttributes.GetFeatureAttribute("te_roll").Value),photoStruct.principalX=Number(feature.FeatureAttributes.GetFeatureAttribute("principal_x").Value),photoStruct.principalY=Number(feature.FeatureAttributes.GetFeatureAttribute("principal_y").Value),photoStruct.bands=feature.FeatureAttributes.GetFeatureAttribute("Bands").Value,photoStruct.at_result=Number(feature.FeatureAttributes.GetFeatureAttribute("at_result").Value),photoStruct.featureID=feature.ID,photoStruct.fieldOfView=2*Math.atan(.5/photoStruct.focalNormilized)*(180/Math.PI),photoStruct.fieldOfViewY=2*Math.atan(.5*photoStruct.height/photoStruct.width/photoStruct.focalNormilized)*(180/Math.PI),photoStruct.photoPos=SGWorld.Creator.CreatePosition(photoStruct.x,photoStruct.y,photoStruct.z,3,photoStruct.yaw,photoStruct.pitch,photoStruct.roll,0),photoStruct},PointToPixel:function(photoStruct,markerPosition){try{var pixelDistort,CSTerrain=SGWorld.Terrain.CoordinateSystem,CSLL=SGWorld.CoordServices.CreateCoordinateSystem('GEOGCS["WGS84 Coordinate System",DATUM["WGS 1984",SPHEROID["WGS 1984",6378137,298.257223563],TOWGS84[0,0,0,0,0,0,0],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"],AUTHORITY["SBMG","LAT-LONG,LAT-LONG,WGS84,METERS"]]]'),photoCoordLL=SGWorld.CoordServices.ReprojectEx(CSTerrain,CSLL,photoStruct.x,photoStruct.y,photoStruct.z),CS=this.CreateEcefProjectionWithMatrix(photoCoordLL.X,photoCoordLL.Y,photoCoordLL.Z),photoCoord=SGWorld.CoordServices.ReprojectEx(CSTerrain,CS,photoStruct.x,photoStruct.y,photoStruct.z),markerCoord=SGWorld.CoordServices.ReprojectEx(CSTerrain,CS,markerPosition.X,markerPosition.Y,markerPosition.Altitude),mopk=this.FromYPRToOPKMatrix(photoStruct.yaw,photoStruct.pitch,photoStruct.roll),photoPos=[photoCoord.X,photoCoord.Y,photoCoord.Z],myt=this.matrix_product(3,3,3,1,mopk,photoPos),myt=this.matrix_scale(3,1,myt,-1),focal=photoStruct.focalNormilized*Math.max(photoStruct.width,photoStruct.height),K=[-focal,0,photoStruct.principalX,0,focal,photoStruct.principalY,0,0,1],Ptmp=[mopk[0],mopk[1],mopk[2],myt[0],mopk[3],mopk[4],mopk[5],myt[1],mopk[6],mopk[7],mopk[8],myt[2]],ProjMatrix=this.matrix_product(3,3,3,4,K,Ptmp),ProjMatrix=this.matrix_scale(3,4,ProjMatrix,-1),pnt=[markerCoord.X,markerCoord.Y,markerCoord.Z,1],pixel=this.matrix_product(3,4,4,1,ProjMatrix,pnt);return pixel[0]/=pixel[2],pixel[1]/=pixel[2],pixel[0]<0||pixel[1]<0||pixel[0]>photoStruct.width||pixel[1]>photoStruct.height?pixel:[(pixelDistort=this.UndistortToDistortPixel(photoStruct,pixel[0],pixel[1]))[0],pixelDistort[1],pixel[2],pixel[3]]}catch(e){application.debug&&alert("PointToPixel error: "+e.message)}},PointToPixelOld:function(photoStruct,markerPosition){var CSTerrain=SGWorld.Terrain.CoordinateSystem,CSLL=SGWorld.CoordServices.CreateCoordinateSystem('COMPD_CS["WGS84 Coordinate System + EGM96 geoid height",GEOGCS["WGS84 Coordinate System",DATUM["WGS 1984",SPHEROID["WGS 1984",6378137,298.257223563],TOWGS84[0,0,0,0,0,0,0],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"],AUTHORITY["SBMG","LAT-LONG,LAT-LONG,WGS84,METERS"]],VERT_CS["EGM96 geoid height",VERT_DATUM["EGM96 geoid",2005,AUTHORITY["EPSG","5171"],EXTENSION["PROJ4_GRIDS","egm96_15.gtx"]],UNIT["m",1.0],AXIS["Up",UP],AUTHORITY["EPSG","5773"]]]'),CS=this.CreateEcefProjectionWithMatrix(photoStruct.LLx,photoStruct.LLy,photoStruct.LLz),CSLL=SGWorld.CoordServices.ReprojectEx(CSLL,CS,photoStruct.LLx,photoStruct.LLy,photoStruct.LLz),CSTerrain=SGWorld.CoordServices.ReprojectEx(CSTerrain,CS,markerPosition.X,markerPosition.Y,markerPosition.Altitude),CS=this.RotationMatrixOPK(photoStruct.omega,photoStruct.phi,photoStruct.kappa),markerPosition=[CSLL.X,CSLL.Y,CSLL.Z],CSLL=this.matrix_product(3,3,3,1,CS,markerPosition),CSLL=this.matrix_scale(3,1,CSLL,-1),markerPosition=photoStruct.focalNormilized*Math.max(photoStruct.width,photoStruct.height),markerPosition=[-markerPosition,0,photoStruct.principalX,0,markerPosition,photoStruct.principalY,0,0,1],CS=[CS[0],CS[1],CS[2],CSLL[0],CS[3],CS[4],CS[5],CSLL[1],CS[6],CS[7],CS[8],CSLL[2]],CSLL=this.matrix_product(3,3,3,4,markerPosition,CS),CSLL=this.matrix_scale(3,4,CSLL,-1),markerPosition=[CSTerrain.X,CSTerrain.Y,CSTerrain.Z,1],CS=this.matrix_product(3,4,4,1,CSLL,markerPosition),CSTerrain=(CS[0]/=CS[2],CS[1]/=CS[2],services.UndistortToDistortPixel(photoStruct,CS[0],CS[1]));return[CSTerrain[0],CSTerrain[1],CS[2]]},CountFeaturesInLayer:function(featureLayer){featureLayer=(1==featureLayer.GeometryType?featureLayer.FeatureGroups.Polyline:featureLayer.FeatureGroups.Polygon).GetCurrentFeatures();return featureLayer.Count},LL2ECEF_WGS84:function(long,lat,alt){var ECEF=[],clat=Math.cos(lat),lat=Math.sin(lat),clon=Math.cos(long),long=Math.sin(long),WGS84_E=Math.sqrt(1-Math.pow(.9966471893352525,2)),N=6378137/Math.sqrt(1-WGS84_E*WGS84_E*lat*lat);return ECEF[0]=(N+alt)*clat*clon,ECEF[1]=(N*(1-WGS84_E*WGS84_E)+alt)*lat,ECEF[2]=(N+alt)*clat*long,ECEF},LLCS:function(){return null==this._LLCS&&(this._LLCS=SGWorld.CoordServices.CreateCoordinateSystem('COMPD_CS["WGS84 Coordinate System + EGM96 geoid height",GEOGCS["WGS84 Coordinate System",DATUM["WGS 1984",SPHEROID["WGS 1984",6378137,298.257223563],TOWGS84[0,0,0,0,0,0,0],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"],AUTHORITY["SBMG","LAT-LONG,LAT-LONG,WGS84,METERS"]],VERT_CS["EGM96 geoid height",VERT_DATUM["EGM96 geoid",2005,AUTHORITY["EPSG","5171"],EXTENSION["PROJ4_GRIDS","egm96_15.gtx"]],UNIT["m",1.0],AXIS["Up",UP],AUTHORITY["EPSG","5773"]]]')),this._LLCS},EcefCS:function(){return null==this._EcefCS&&(this._EcefCS=SGWorld.CoordServices.CreateCoordinateSystem('GEOCCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Geocentric X",OTHER],AXIS["Geocentric Y",OTHER],AXIS["Geocentric Z",NORTH],AUTHORITY["EPSG","4978"]]')),this._EcefCS},Deg2Rad:function(angle){return Math.PI/180*angle},CreateEcefRotMatrixFromLatLon:function(centerLon,centerLat,altitude){var clat=Math.cos(this.Deg2Rad(centerLat)),centerLat=Math.sin(this.Deg2Rad(centerLat)),clon=Math.cos(this.Deg2Rad(centerLon)),centerLon=Math.sin(this.Deg2Rad(centerLon));return[-centerLon,clon,0,0,-centerLat*clon,-centerLat*centerLon,clat,0,clon*clat,centerLon*clat,centerLat,0,0,0,0,1]},CreateEcefProjectionWithMatrix:function(xLL,yLL,zLL){var xyzRes=SGWorld.CoordServices.ReprojectEx(this.LLCS(),this.EcefCS(),xLL,yLL,zLL),xyzRes=[xyzRes.X,xyzRes.Y,xyzRes.Z],xLL=this.CreateEcefRotMatrixFromLatLon(xLL,yLL,zLL),yLL=(xLL[12]=xyzRes[0],xLL[13]=xyzRes[1],xLL[14]=xyzRes[2],this.CreateProjectionMatrix(xLL));return SGWorld.CoordServices.CreateCoordinateSystem(yLL)},CreateProjectionMatrix:function(rotMat,wkt){return wkt=(wkt=(wkt=null==wkt?this.EcefCS().WellKnownText:wkt).trim(" ","\t","\r","\n")).substring(0,wkt.lastIndexOf("]"))+',SlMatrix["'+rotMat.toString()+'"]]'},RotationMatrixOPK:function(omega,phi,kappa){omega*=Math.PI/180,phi*=Math.PI/180,kappa*=Math.PI/180;var so=Math.sin(omega),omega=Math.cos(omega),sp=Math.sin(phi),phi=Math.cos(phi),sk=Math.sin(kappa),kappa=Math.cos(kappa);return[phi*kappa,so*sp*kappa+omega*sk,-omega*sp*kappa+so*sk,-phi*sk,-so*sp*sk+omega*kappa,omega*sp*sk+so*kappa,sp,-so*phi,omega*phi]},matrix_product:function(Am,An,Bm,Bn,A,B){var i,j,k,R=[],r=Am,c=Bn,m=An;if(An==Bm){for(i=0;i<r;i++)for(j=0;j<c;j++)for(k=R[i*c+j]=0;k<m;k++)R[i*c+j]+=A[i*An+k]*B[k*Bn+j];return R}alert("[this.matrix_product] Error: the number of columns of A and the number of rows of B must be equal")},matrix_scale:function(m,n,A,s){for(var R=[],entries=m*n,i=0;i<entries;i++)R[i]=A[i]*s;return R},rotfromLL:function(centerLon,centerLat){var d=100/111111,o=this.LL2ECEF_WGS84(centerLon,centerLat,0),x=this.LL2ECEF_WGS84(centerLon+d,centerLat,0),d=this.LL2ECEF_WGS84(centerLon,centerLat+d,0),centerLon=this.LL2ECEF_WGS84(centerLon,centerLat,100),centerLat=[],dy=[],dz=[],l=[],mat=[];return centerLat[0]=x[0]-o[0],centerLat[1]=x[1]-o[1],centerLat[2]=x[2]-o[2],dy[0]=d[0]-o[0],dy[1]=d[1]-o[1],dy[2]=d[2]-o[2],dz[0]=centerLon[0]-o[0],dz[1]=centerLon[1]-o[1],dz[2]=centerLon[2]-o[2],l[0]=Math.sqrt(centerLat[0]*centerLat[0]+centerLat[1]*centerLat[1]+centerLat[2]*centerLat[2]),l[1]=Math.sqrt(dy[0]*dy[0]+dy[1]*dy[1]+dy[2]*dy[2]),l[2]=Math.sqrt(dz[0]*dz[0]+dz[1]*dz[1]+dz[2]*dz[2]),centerLat[0]/=l[0],centerLat[1]/=l[0],centerLat[2]/=l[0],dy[0]/=l[1],dy[1]/=l[1],dy[2]/=l[1],dz[0]/=l[2],dz[1]/=l[2],dz[2]/=l[2],mat[0]=centerLat[0],mat[1]=centerLat[1],mat[2]=centerLat[2],mat[3]=dy[0],mat[4]=dy[1],mat[5]=dy[2],mat[6]=dz[0],mat[7]=dz[1],mat[8]=dz[2],mat},rotfromLL2:function(centerLon,centerLat){var mat=[],clat=Math.cos(centerLat),centerLat=Math.sin(centerLat),clon=Math.cos(centerLon),centerLon=Math.sin(centerLon);return mat[0]=-centerLon,mat[1]=clon,mat[2]=0,mat[3]=-centerLat*clon,mat[4]=-centerLat*centerLon,mat[5]=clat,mat[6]=clon*clat,mat[7]=centerLon*clat,mat[8]=centerLat,mat},rotfromLLT:function(centerLon,centerLat){var mat=[],clat=Math.cos(centerLat),centerLat=Math.sin(centerLat),clon=Math.cos(centerLon),centerLon=Math.sin(centerLon);return mat[0]=-centerLon,mat[3]=clon,mat[6]=0,mat[1]=-centerLat*clon,mat[4]=-centerLat*centerLon,mat[7]=clat,mat[2]=clon*clat,mat[5]=centerLon*clat,mat[8]=centerLat,mat},FromYPRToOPKMatrix:function(heading,pitch,roll){var matrixYPR_TO_OPKmatrix=this.RotationMatrixOPK(90,0,0),heading=this.RotationMatrixOPK(0,0,-heading),roll=this.RotationMatrixOPK(0,roll,0),pitch=this.RotationMatrixOPK(pitch,0,0),matrixYPR_TO_OPKmatrix=this.matrix_product(3,3,3,3,matrixYPR_TO_OPKmatrix,roll),matrixYPR_TO_OPKmatrix=this.matrix_product(3,3,3,3,matrixYPR_TO_OPKmatrix,pitch);return this.matrix_product(3,3,3,3,matrixYPR_TO_OPKmatrix,heading)},RotationMatrixYPR:function(yaw,pitch,roll){var yaw=Deg2Rad(yaw),pitch=Deg2Rad(pitch),roll=Deg2Rad(roll),su=Math.sin(roll),sv=Math.sin(pitch),sw=Math.sin(yaw),roll=Math.cos(roll),pitch=Math.cos(pitch),yaw=Math.cos(yaw);return[pitch*yaw,su*sv*yaw-roll*sw,su*sw+roll*sv*yaw,pitch*sw,roll*yaw+su*sv*sw,roll*sv*sw-su*yaw,-sv,su*pitch,roll*pitch]},AngleDistance:function(angle1,angle2){angle2=Math.abs(angle2-angle1)%360;return 180<angle2?360-angle2:angle2},GetDateString:function(){var dateObj=new Date;return["January","February","March","April","May","June","July","August","September","October","November","December"][dateObj.getMonth()]+"\n"+String(dateObj.getDate())+","+dateObj.getFullYear()},PixelToPoint:function(photoStruct,pixel){try{var undistortedPixel=services.DistortToUndistortPixel(photoStruct,pixel.x,pixel.y),photoPos=SGWorld.Creator.CreatePosition(photoStruct.x,photoStruct.y,photoStruct.z,3,photoStruct.yaw,photoStruct.pitch,-photoStruct.roll,1),focal=photoStruct.focalNormilized*Math.max(photoStruct.width,photoStruct.height),newPos=(newPos=photoPos.Copy()).MoveByOrientation(focal,undistortedPixel[0]-photoStruct.principalX,photoStruct.principalY-undistortedPixel[1]),photoPos=photoPos.AimTo(newPos);return services.pickRay(photoPos)}catch(err){return null}},DistortToUndistortPixel:function(photo,x,y){for(var ox=x,oy=y,i=0;i<100;i++){var bxyfxy=services.UndistortDerivative(photo,ox,oy),deltax=(bxyfxy[0]-x)/bxyfxy[2],bxyfxy=(bxyfxy[1]-y)/bxyfxy[3];if(ox-=deltax,oy-=bxyfxy,deltax<.01&&bxyfxy<.01)break}return[ox,oy]},UndistortDerivative:function(photo,x,y){var oxy=services.UndistortToDistortPixel(photo,x,y),d=1e-6,b2x=services.UndistortToDistortPixel(photo,x+d,y),photo=services.UndistortToDistortPixel(photo,x,y+d);return dox=(b2x[0]-oxy[0])/d,doy=(photo[1]-oxy[1])/d,[oxy[0],oxy[1],dox,doy]},UndistortToDistortPixel:function(photo,x,y){var dist_focal=Math.max(photo.width,photo.height)*photo.focalNormilized,PrincipalPointX=photo.principalX,PrincipalPointY=photo.principalY,dist_k0=photo.k[0],dist_k1=photo.k[1],dist_k2=photo.k[2],dist_p1=photo.p[0],photo=photo.p[1],r2=((x=x-PrincipalPointX)*x+(y=y-PrincipalPointY)*y)*(1/(dist_focal*dist_focal)),dist_k0=1+dist_k0*r2+dist_k1*r2*r2+dist_k2*r2*r2*r2,dist_k1=x/dist_focal,dist_k2=y/dist_focal,x=dist_focal*(dist_k1*dist_k0+2*dist_p1*dist_k1*dist_k2+photo*(r2+2*dist_k1*dist_k1)),y=dist_focal*(dist_k2*dist_k0+2*photo*dist_k1*dist_k2+dist_p1*(r2+2*dist_k2*dist_k2));return[x+=PrincipalPointX,y+=PrincipalPointY]},pickRay:function(pos1){try{pos1.Distance=1e4,SGWorld.SetParam(8300,pos1);var distance=SGWorld.GetParam(8312);return pos1.Move(distance,pos1.Yaw,pos1.Pitch)}catch(err){return null}},GetCenterScreenPoint:function(){try{return SGWorld.Window.PixelToWorld(SGWorld.Window.Rect.Width/2,SGWorld.Window.Rect.Height/2,8256).Position}catch(err){return null}},CameraDistanceToModel:function(){try{var centerScreenPoint=SGWorld.Window.PixelToWorld(SGWorld.Window.Rect.Width/2,SGWorld.Window.Rect.Height/2,8256).Position;return SGWorld.Navigate.GetPosition(3).DistanceTo(centerScreenPoint)}catch(err){return null}},DistortToUndistortPixel2:function(photo,x,y){var f_scale=Math.max(photo.width,photo.height)*photo.focalNormilized,x=(x-photo.principalX)/f_scale,y=(y-photo.principalY)/f_scale,k=photo.k,p=photo.p,x2y2=x*x+y*y,k=1+k[0]*x2y2+k[1]*x2y2*x2y2+k[2]*x2y2*x2y2*x2y2*x2y2;return[photo.principalX+f_scale*(p[1]*(3*x*x+y*y)+x*k+2*p[0]*x*y),photo.principalY+f_scale*(p[0]*(x*x+3*y*y)+y*k+2*p[1]*x*y)]},GetYPRTEInternal:function(m){var yaw,pitch,roll,m_11=m[0],m_12=m[1],m_21=m[3],m_22=m[4],m_31=m[6],m_32=m[7],m=m[8];return.9999999999<m_32?(roll=-Math.atan2(m_11,m_21)-Math.PI/2,pitch=Math.PI/2,yaw=-Math.PI):m_32<-.9999999999?(roll=-Math.atan2(m_11,m_21)-Math.PI/2,pitch=-Math.PI/2,yaw=-Math.PI):(pitch=Math.asin(m_32),yaw=Math.atan2(m_31,m),roll=Math.atan2(-m_12,m_22)),[180*yaw/Math.PI,180*pitch/Math.PI,180*roll/Math.PI]},GetYPRTE:function(mat){mat=[mat[0],mat[2],mat[1],mat[3],mat[5],mat[4],-mat[6],-mat[8],-mat[7]];return this.GetYPRTEInternal(mat)},dummy:null};