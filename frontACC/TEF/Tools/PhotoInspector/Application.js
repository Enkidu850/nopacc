var SGWorld=null,application={photosLayerID:null,photosLayer:null,PointLabel:null,DrawMode:0,Projector:null,Marker:null,VirtualCursor:null,MarkerPosition:null,MarkerSurface:0,Directions:["Front","Top","Left","Behind","Right"],viewerAngles:[0,0,90,180,270],viewerList:["Main","Secondary"],viewers:[],bestPhoto:[],keyShortcuts:[77,68,190,188],actionFunctions:["application.SelectPoint()","inspections.Draw(true,0)","application.PrevNextPhoto(1)","application.PrevNextPhoto(-1)"],zIndex:100,isShowLoadFailed:!1,lastCursorPosition:null,mouseOverTool:!1,photoInspectorViewer:!1,debug:!1,init:function(){try{SGWorld=initSGWorld();try{if(!TEF&&(2==SGWorld.Version.Type||-1==SGWorld.Version.Type))return alert(SGLang.i18n("TextTEViewer")),this.exit(),$("#toolboxDiv").hide(),$("#QuickGuideDiv").hide(),!1}catch(err){return!1}var that;window.ondragstart=function(){return!1},application.HideTEDFeaturesInFusion(),this.photosLayerID=GetParamValue("photosLayer",""),this.photosLayerID?(this.inspectionLayerID=GetParamValue("inspectionLayer",""),application.photosLayer=SGWorld.Creator.GetObject(this.photosLayerID),settings.Init(),this.SetToolboxTooltips(),SGWorld.AttachEvent("OnSGWorldMessage",application.OnSGWorldMessage),SGWorld.AttachEvent("OnKeyboard",application.OnKeyboard),SGWorld.AttachEvent("OnObjectAction",application.OnObjectAction),SGWorld.AttachEvent("OnProjectTreeAction",application.OnProjectTreeAction),$("#PhotoViewersDiv").keydown(function(e){try{e.ctrlKey||eval(application.actionFunctions[application.keyShortcuts.indexOf(e.keyCode)]),$("#PhotoViewersDiv").focus()}catch(err){application.debug&&alert("Application.js -> init keydown: "+err.message)}}),this.SetToolboxSize(),$(window).resize(function(){application.SetToolboxSize()}),that=this,this.viewerList.forEach(function(val,index){that.viewers[val]=new PhotoViewer(val,SGLang.i18n("TextFilter"+val),index)}),$(document).on("mouseover",function(){application.mouseOverTool=!0}).on("mouseout",function(){application.mouseOverTool=!1}),inspections.Init(this.inspectionLayerID),application.stylePhotosLayer(this.photosLayerID)):alert(SGLang.i18n("TextErrorInPhotoLayer"))}catch(err){application.debug&&alert("Application.js -> init: "+err.message)}},HideTEDFeaturesInFusion:function(){TEF&&$(".hiddenInTEF").hide()},OnObjectAction:function(objectID,action){31==action.Code&&(action=SGWorld.Creator.GetObject(objectID),objectID=GetParamValue("inspectionLayerID",""),action)&&action.ParentGroupID&&action.ParentGroupID==objectID&&SGWorld.Creator.GetObject(objectID).SaveAsync().OnResolve(function(){application.RedrawInspectionsOnPhotos()}).OnReject(function(err){application.debug&&alert("Application.js -> OnObjectAction OnReject: "+err.message)})},OnProjectTreeAction:function(treeItemID,action){19==action.Code&&0==application.DrawMode&&setTimeout(function(){application.RedrawInspectionsOnPhotos()},10)},exit:function(){this.Reset(),inspections.Exit()},getDefaultSMPTFolderPath:function(){try{var lastSlashIndex,photoLayerPath=(photoLayerPath=application.photosLayer.DataSourceInfo.ConnectionString.split(";LayerName")[0]).split("FileName=")[1],path="";return photoLayerPath&&(lastSlashIndex=photoLayerPath.lastIndexOf("\\"),lastSlashIndex=(path=photoLayerPath.slice(0,lastSlashIndex)).lastIndexOf("\\"),path=path.slice(0,lastSlashIndex),path+="\\smpt"),path}catch(err){application.debug&&alert("Application.js -> getDefaultSMPTFolderPath: "+err.message)}},stylePhotosLayer:function(photosLayerID){iconSize=settings.params.cameraSymbolSize,application.photosLayer=SGWorld.Creator.GetObject(photosLayerID),application.photosLayer.FeatureGroups.Point.DisplayAs=ObjectTypeCode.OT_MODEL,application.photosLayer.Streaming=!0,application.photosLayer.RefreshAsync().OnResolve(function(){application.photosLayer.FeatureGroups.Point.SetProperty("File Name",abspath()+"/resources/pyramid.xpl2"),application.photosLayer.FeatureGroups.Point.SetProperty("Yaw","[te_yaw]"),application.photosLayer.FeatureGroups.Point.SetProperty("Pitch","[te_pitch]"),application.photosLayer.FeatureGroups.Point.SetProperty("Roll","[te_roll]"),application.photosLayer.FeatureGroups.Point.SetProperty("Scale X",iconSize),application.photosLayer.FeatureGroups.Point.SetProperty("Scale Y",1.5*iconSize),application.photosLayer.FeatureGroups.Point.SetProperty("Scale Z",iconSize),application.photosLayer.FeatureGroups.Point.SetProperty("Tint Opacity",20),application.photosLayer.FeatureGroups.Point.SetProperty("Tint Color","#00ff00"),application.photosLayer.FeatureGroups.Point.SetClassification("Visibility","<Class><Condition SQL='1'><SQL_EXPR>visible = 1</SQL_EXPR></Condition></Class>"),application.photosLayer.FeatureGroups.Point.SetProperty("Tool Tip",SGLang.i18n("TextClickToView")),application.photosLayer.FeatureGroups.Point.SetProperty("Ground Object",!1);var TEMes=SGWorld.Creator.CreateMessage(5,'<script type = "javascript"> SGWorld.Window.ShowMessageBarText("#OBLIQUE#"+This81.ID);<\/script>',3);application.photosLayer.FeatureGroups.Point.SetProperty("Message",TEMes.ID),application.showAllPhotos(1)}).OnReject(function(error){application.debug&&alert("Application.js -> stylePhotosLayer OnReject: "+err.message)})},showAllPhotos:function(visible){try{var nullGeo=SGWorld.Creator.GeometryCreator.CreatePolygonGeometry(null);application.photosLayer.ExecuteQueryAsync("",-1,"",nullGeo).OnResolve(function(totalPhotos){for(i=0;i<totalPhotos.Count;i++)totalPhotos.Item(i).FeatureAttributes.GetFeatureAttribute("visible").Value=visible}).OnReject(function(error){application.debug&&alert("Application.js -> showAllPhotos OnReject: "+err.message)})}catch(err){application.debug&&alert("Application.js -> showAllPhotos: "+err.message)}},refreshPhotosLayerList:function(photoListID,selectFirst){var layerList=[],found=(BuildObjectsList(SGWorld.ProjectTree.RootID,layerList,36),photoListID.html(""),!1);return photoListID.append("<option value=-1> "+SGLang.i18n("TextSelect")+"</option>"),layerList.forEach(function(val){var parent,name,layer=SGWorld.Creator.GetObject(val);if(0==layer.GeometryType)try{layer.DataSourceInfo.Attributes.IsAttributeExist("te_yaw")&&(parent=SGWorld.ProjectTree.GetNextItem(val,15),name=(parentName=parent==SGWorld.ProjectTree.RootID?"":SGWorld.ProjectTree.GetItemName(parent))+"/"+SGWorld.ProjectTree.GetItemName(val),photoListID.append("<option value="+val+">"+name+"</option>"),found=!0)}catch(e){}}),selectFirst&&found&&(photoListID.children()[1].selected=!0),found},startPhotoInspector:function(photoListID,inspectionListID){"-1"==photoListID?alert(SGLang.i18n("TextSelectPhotosLayer")):(photoListID=abspath()+"/Photo.html?photosLayer="+photoListID,application.photoInspectorViewer||(photoListID+="&inspectionLayer="+inspectionListID),photoListID+="&lang="+SGLang.getCode()+"&photoInspectorViewer="+application.photoInspectorViewer,TEF?location.href=photoListID:(SGWorld.Application.Containers.AddContainer(SGLang.i18n("ToolName")+" - "+$("#PhotosListID option:selected").text(),"file://"+photoListID,1),this.closePhotoInspectorPopup()))},UIToViewerMode:function(){var isViewerModeString=GetParamValue("photoInspectorViewer",!1);application.photoInspectorViewer="true"==isViewerModeString,1!=application.photoInspectorViewer&&1!=application.photoInspectorViewer||$(".hideInViewerMode").hide()},closePhotoInspectorPopup:function(){TEF?parent.panel.back():SGWorld.Window.RemovePopupByCaption(SGLang.i18n("StartToolName"))},Reset:function(FirstTime,FromMouseInputMode){1==application.DrawMode&&(SGWorld.DetachEvent("OnLButtonClicked",application.OnLButtonClicked),SGWorld.DetachEvent("OnRButtonUp",application.OnRButtonUp),SGWorld.DetachEvent("OnInputModeChanged",application.OnInputModeChanged)),application.DrawMode=0,$("#toolBoxSelectPoint").removeClass("toolboxIconHighlight");try{null!=application.Projector&&SGWorld.ProjectTree.DeleteItem(application.Projector)}catch(err){}try{null!=application.Marker&&SGWorld.ProjectTree.DeleteItem(application.Marker.ID)}catch(err){}try{null!=application.VirtualCursor&&SGWorld.ProjectTree.DeleteItem(application.VirtualCursor.ID)}catch(err){}application.Projector,application.Marker=null,application.MarkerPosition=null,application.VirtualCursor=null;try{1!=FirstTime&&0==FromMouseInputMode&&(SGWorld.Window.SetInputMode(0),$(".PhotoWindowOpenSeaDragon").css("cursor","move"))}catch(e){}},ResetPhotos:function(){1!=inspections.DrawMode&&2!=inspections.DrawMode&&(application.Reset(!1,!1),application.ResetPhotoViewers(),application.showAllPhotos(1),this.ShowPhotoViewers(!1))},SelectPoint:function(){if(1==application.DrawMode)application.Reset(!1,!1);else if(1!=inspections.DrawMode&&2!=inspections.DrawMode){try{null!=application.PointLabel&&SGWorld.Creator.DeleteObject(application.PointLabel.ID)}catch(err){}application.Reset(!1,!1),application.DrawMode=1,SGWorld.Window.SetInputMode(0),SGWorld.Window.SetInputMode(1,abspath()+"/resources/cursor_x.cur",!0),$(".PhotoWindowOpenSeaDragon").css("cursor","default"),$("#toolBoxSelectPoint").addClass("toolboxIconHighlight"),SGWorld.Window.ShowMessageBarText(SGLang.i18n("TextClickPoint"),1,3e3),SGWorld.AttachEvent("OnLButtonClicked",application.OnLButtonClicked),SGWorld.AttachEvent("OnRButtonUp",application.OnRButtonUp),SGWorld.AttachEvent("OnInputModeChanged",application.OnInputModeChanged)}},OnLButtonClicked:function(flags,X,Y){0!=application.DrawMode&&application.SetMarker(X,Y)},OnRButtonUp:function(Flags,X,Y){0!=application.DrawMode&&application.Reset(!1,!1)},OnKeyboard:function(Message,Char,KeyState){var keyIndex=application.keyShortcuts.indexOf(Char);return 256==Message&&0==KeyState&&-1<keyIndex?(eval(application.actionFunctions[keyIndex]),$("#PhotoViewersDiv").focus(),!0):!1},OnInputModeChanged:function(Flags,X,Y){0!=application.DrawMode&&application.Reset(!1,!0)},RefreshViewers:function(){null!=application.MarkerPosition&&this.SetMarkerPos(application.MarkerPosition)},SetMarker:function(X,Y){var CursorCoord=SGWorld.Window.PixelToWorld(X,Y,8401);if(null==CursorCoord)return!1;this.lastCursorPosition=CursorCoord.Position,application.MarkerSurface=application.CalcMarkerSurface(X,Y),this.SetMarkerPos(CursorCoord.Position)},SetMarkerPos:function(MarkerPos){try{var labelStyle;MarkerPos&&(application.Reset(!1,!1),application.MarkerPosition=MarkerPos.Copy(),(labelStyle=SGWorld.Creator.CreateLabelStyle(0)).PivotAlignment="Center, Center",application.Marker=SGWorld.Creator.CreateLabel(application.MarkerPosition," ",abspath()+"/images/marker.png",labelStyle,SGWorld.ProjectTree.HiddenGroupID,SGLang.i18n("TextMarker")),application.Marker.SaveInFlyFile=!1,application.showPhotosInPoint(application.MarkerPosition,!1))}catch(err){application.debug&&alert("Application.js -> SetMarkerPos: "+err.message)}},CalcMarkerSurface:function(X,Y){var CursorCoord=SGWorld.Window.PixelToWorld(X,Y,8401);if(null==CursorCoord)return 0;for(var avrPitch=0,i=0;i<10;i++){var checkCoord=SGWorld.Window.PixelToWorld(X,Y-50+10*i,8401);null!=CursorCoord&&(avrPitch+=Math.abs(CursorCoord.Position.AimTo(checkCoord.Position).Pitch))}return avrPitch/10<45?0:1},showPhotosInPoint:function(markerPos,getBestPhoto){try{var found=!1,geometry=SGWorld.Creator.GeometryCreator.CreatePointGeometry("POINT ("+markerPos.X+" "+markerPos.Y+" "+markerPos.Altitude+")"),CameraPos=SGWorld.Navigate.GetPosition(3),CameraDistance=CameraPos.DistanceTo(markerPos),cameraVec=[],searchDistance=(cameraVec[0]=111111.111*(CameraPos.X-markerPos.X),cameraVec[1]=111111.111*(CameraPos.Y-markerPos.Y),cameraVec[2]=CameraPos.Altitude-markerPos.Altitude,settings.params.searchDistance),edbgeBuffer=settings.params.edgeBuffer,geometry1=(getBestPhoto?application.BestPhoto=[]:(application.ResetPhotoViewers(),application.ShowPhotoViewers(!0)),geometry.SpatialOperator.Buffer(searchDistance));application.photosLayer.ExecuteQueryAsync("",-1,"",geometry1).OnResolve(function(features){for(i=0;i<features.Count;i++){var photoStruct=services.GetPhotoParams(features.Item(i)),pixel=services.PointToPixel(photoStruct,markerPos);if(0==photoStruct.at_result&&0<pixel[2]&&pixel[0]>edbgeBuffer&&pixel[1]>edbgeBuffer&&pixel[0]<photoStruct.width-edbgeBuffer&&pixel[1]<photoStruct.height-edbgeBuffer){found=!0,photoStruct.distance=photoStruct.photoPos.DistanceTo(markerPos),photoStruct.featureID=features.Item(i).ID,photoStruct.feature=features.Item(i);var pixel=[],pixel=(pixel[0]=111111.111*(photoStruct.photoPos.X-markerPos.X),pixel[1]=111111.111*(photoStruct.photoPos.Y-markerPos.Y),pixel[2]=photoStruct.photoPos.Altitude-markerPos.Altitude,photoStruct.DirectionDiff=(cameraVec[0]*pixel[0]+cameraVec[1]*pixel[1]+cameraVec[2]*pixel[2])/(photoStruct.distance*CameraDistance),0==application.MarkerSurface&&(photoStruct.DirectionDiff/=4),photoStruct.searchScore=(2-photoStruct.DirectionDiff)*photoStruct.distance,CameraPos.AimTo(markerPos).Yaw),photoYaw=photoStruct.photoPos.AimTo(markerPos).Yaw;if(photoStruct.YawDifference=photoYaw,photoStruct.DirectionCode=0,photoStruct.pitch<-65?photoStruct.DirectionCode=1:services.AngleDistance(pixel,photoYaw)<=55?photoStruct.DirectionCode=0:services.AngleDistance(pixel+90,photoYaw)<=35?photoStruct.DirectionCode=2:services.AngleDistance(pixel+180,photoYaw)<=55?photoStruct.DirectionCode=3:services.AngleDistance(pixel+270,photoYaw)<=35&&(photoStruct.DirectionCode=4),getBestPhoto)application.BestPhoto.push(photoStruct);else for(viewer in application.viewers)application.viewers[viewer].photoCandidatesList.push(photoStruct)}}if(getBestPhoto)return application.BestPhoto.sort(function(a,b){return a.searchScore<b.searchScore?-1:a.searchScore>b.searchScore?1:0}),application.BestPhoto;for(viewer in application.viewers)if(application.viewers[viewer].InitViewer(),!settings.params.multipleViewers)break;found||alert(SGLang.i18n("TextPhotosNotFound"))}).OnReject(function(err){application.debug&&alert("Application.js -> showPhotosInPoint: "+err.message)})}catch(err){application.debug&&alert("Application.js -> showPhotosInPoint: "+err.message)}},CalculateScore:function(viewerYaw,photoYaw,distance){return distance+services.AngleDistance(viewerYaw,photoYaw)/90*distance},ZoomToArea:function(){SGWorld.Navigate.FlyTo(application.photosLayer.ID)},GetInitialFlyToPosition:function(photoStruct){return application.photosLayer.FeatureGroups.Point.GetFeatureByObjectID(photoStruct.featureID).Show=!1,photoStruct.photoPos},ResetPhotoViewers:function(viewerName){this.showAllPhotos(0);var that=this;this.viewerList.forEach(function(val){that.viewers[val].Reset()})},ShowPhotoViewers:function(show){show?(this.viewerList.forEach(function(val){settings.params.multipleViewers?$("#PhotoViewerSecondaryTR").show():$("#PhotoViewerSecondaryTR").hide(),settings.params.multipleViewers||"Main"==val?$("#PhotoViewerDiv-"+val).show():$("#PhotoViewerDiv-"+val).hide()}),$("#PhotoViewersDiv").show(),application.zIndex++,$("#PhotoViewersDiv").css("z-index",application.zIndex)):$("#PhotoViewersDiv").hide()},OnSGWorldMessage:function(TEMessageID,SourceObjectID){var messageArray=TEMessageID.split("#");return"OBLIQUE"==messageArray[1]&&(application.viewerList.forEach(function(val){application.viewers[val].userClickedPhotoIcon(messageArray[2])}),!0)},SetToolboxTooltips:function(){$("#toolBoxSelectPoint").prop("title",SGLang.i18n("TextToolboxSetMarker")),$("#toolReset").prop("title",SGLang.i18n("TextToolboxReset")),$("#toolMultipleViewers").prop("title",SGLang.i18n("TextToolboxMultipleViewers")),$("#toolInspectionDraw0").prop("title",SGLang.i18n("TextToolboxDrawLine")),$("#toolInspectionDraw1").prop("title",SGLang.i18n("TextToolboxDrawPoint")),$("#toolInspectionDraw2").prop("title",SGLang.i18n("TextToolboxDistance")),$("#toolInspectionSelect").prop("title",SGLang.i18n("TextToolboxSelectInspection")),$("#toolInspectionShowList").prop("title",SGLang.i18n("TextToolboxShowList")),$("#toolSettings").prop("title",SGLang.i18n("TextToolboxSettings"))},SetToolboxSize:function(){var pad=Math.min(5,$(window).width()/100),size=Math.max(16,Math.min(32,($(window).width()-2*pad*10-50)/10));$(".toolboxIcon").attr("style","height:"+size+"px !important;width:"+size+"px !important;padding-left:"+pad+"px;padding-right:"+pad+"px")},ShowLoadFailed:function(){var show=!this.isShowLoadFailed;this.isShowLoadFailed=!0,show&&alert(SGLang.i18n("TextLoadPhotoFail"))},PrevNextPhoto:function(direction){$("#ViewerTD-0").children(":first-child").attr("id");application.viewers[this.viewerList[0]].PrevNextPhoto(direction)},RedrawInspectionsOnPhotos:function(){for(viewer in this.viewers)if(this.viewers[viewer].DrawOverlays(),!settings.params.multipleViewers)break},AttachSecondaryViewer:function(pos,zoom){settings.params.multipleViewers&&application.viewers[this.viewerList[1]].PanToPos(pos,zoom)},ShowVirtualCursor:function(position){try{var cursorSize,camera=SGWorld.Navigate.GetPosition(3),left=(cursorSize=null==position?(position=SGWorld.Creator.CreatePosition(0,0,-999,3,0,0,0),1):Math.max(camera.DistanceTo(position)/30,.1),position.Move(cursorSize,camera.Yaw+135,0)),right=position.Move(cursorSize,camera.Yaw-45,0),front=position.Move(cursorSize,camera.Yaw+45,0),back=position.Move(cursorSize,camera.Yaw+225,0),array="LineString ("+left.X+" "+left.Y+" "+left.Altitude+","+right.X+" "+right.Y+" "+right.Altitude+", "+position.X+" "+position.Y+" "+position.Altitude+", "+front.X+" "+front.Y+" "+front.Altitude+","+back.X+" "+back.Y+" "+back.Altitude+", "+position.X+" "+position.Y+" "+position.Altitude+", "+position.X+" "+position.Y+" "+(position.Altitude+cursorSize)+","+position.X+" "+position.Y+" "+(position.Altitude-cursorSize)+")",geometry=SGWorld.Creator.GeometryCreator.CreateGeometryFromWKT(array);null==this.VirtualCursor?(this.VirtualCursor=SGWorld.Creator.CreatePolyline(geometry,SGWorld.Creator.CreateColor(255,255,255,255),3,SGWorld.ProjectTree.HiddenGroupID,"cursor"),this.VirtualCursor.SaveInFlyFile=!1,this.VirtualCursor.LineStyle.Width=-3,this.VirtualCursor.Visibility.ShowThroughDistance=5e3):this.VirtualCursor.Geometry=geometry}catch(err){application.debug&&alert(err.message)}},PublishProjectToSGS:function(){if(0!=SGWorld.Version.Type)alert(SGLang.i18n("TextPublishNoPro"));else if(-1!=application.photosLayer.DataSourceInfo.ConnectionString.indexOf("Server="))alert(SGLang.i18n("TextAlreadyPublished"));else if(application.photosLayer.DataSourceInfo.Attributes.IsAttributeExist("das_userfilename"))alert(SGLang.i18n("TextPublishToServerFromOfflineKit"));else{if(1==settings.params.TileStreaming){var path,index;if(SGWorld.SGServer.GetVersion().split(".")[0]<8)return void alert(SGLang.i18n("TextPublishOldSGSVersion"));settings.params.SMPTAlternativePath?path=settings.params.SMPTAlternativePath:(index=(path=(path=application.photosLayer.DataSourceInfo.ConnectionString.split("FileName=")[1]).split(";LayerName")[0]).lastIndexOf("\\"),index=(path=path.slice(0,index)).lastIndexOf("\\"),path=path.slice(0,index),path+="\\smpt\\"),application.photosLayer.FeatureGroups.Point.SetProperty("UserFileName",path+"[Uid].smpt")}else application.photosLayer.FeatureGroups.Point.SetProperty("UserFileName","[path]");SGWorld.Command.Execute(2314,0)}},ExtractAndPublishAreaAsOfflineKit:function(){var path,index;0!=SGWorld.Version.Type?alert(SGLang.i18n("TextPublishNoPro")):-1!=application.photosLayer.DataSourceInfo.ConnectionString.indexOf("Server=")?alert(SGLang.i18n("TextPublishOfflineKitFromServer")):(1==settings.params.TileStreaming?(index=(path=(path=application.photosLayer.DataSourceInfo.ConnectionString.split("FileName=")[1]).split(";LayerName")[0]).lastIndexOf("\\"),index=(path=path.slice(0,index)).lastIndexOf("\\"),path=path.slice(0,index),application.photosLayer.FeatureGroups.Point.SetProperty("UserFileName",(path+="\\smpt\\")+"[Uid].smpt")):application.photosLayer.FeatureGroups.Point.SetProperty("UserFileName","[path]"),SGWorld.Command.Execute(1028,0))},dummy:null};