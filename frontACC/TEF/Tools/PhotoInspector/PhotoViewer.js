function PhotoViewer(name,title,containerIndex){this.numberOfFlyToPerformed,this.frameCounterForFlyTo,this.flyToPosition,this.inspectionIDToPointToPixelAndBackDistance,this.photoCandidatesList=[],this.photosList=[],this.DirectionCodes=[],this.viewer=null,this.overlay=null,this.viewerName=name,this.photoIndex=0,this.centerPoint=null,this.containerIndex=containerIndex,this.lastPhotoURL="",this.TopListCount=3,this.inspectionFeatures=[],this.CanvasOverlay=null;var that=this,viewerHTML="<div id='PhotoViewerDiv-"+name+"' class='PhotoWindowWrapper' >                     <table class='PhotoWindowHeader'> <tr><td>                        <span id='photoViewerTitle-"+name+"' class='s9b i18n photoViewerTitle'></span>                         <select id='PhotoViewerSelect-"+name+"' class='selectNew selectNewLong' ></select>                         <button class='MenuButtonSmallRoundOutline' onclick='application.viewers[\""+name+"\"].PrevNextPhoto(-1)'><img src='images/PrevPhoto.png'></button>                         <button class='MenuButtonSmallRoundOutline' onclick='application.viewers[\""+name+"\"].PrevNextPhoto(1)'><img src='images/NextPhoto.png'></button>                         </td><td align='right'>                        <span class='s18 link2' style='margin-left:auto;margin-right:0;display:"+(0==containerIndex?"inline":"none")+"' id='closeViewersButton-"+name+"' onclick='application.ShowPhotoViewers(false)'>X</span>                       </td></tr></table>                       <div class='PhotoWindowOpenSeaDragon' >                         <div id='openseadragon-"+name+"' class='PhotoWindow' ></div>                       </div>                     </div> ";$("#ViewerTD-"+containerIndex).html(viewerHTML);try{$("#PhotoViewerSelect-"+name).change(function(){that.photoIndex=$("#PhotoViewerSelect-"+that.viewerName)[0].selectedIndex,that.ShowPhoto(!1)}),$("#photoViewerTitle-"+name).html(title+":")}catch(err){application.debug&&alert(err.message)}}PhotoViewer.prototype.Reset=function(){this.photosList=[],this.photoCandidatesList=[]},PhotoViewer.prototype.InitViewer=function(){var singleViewer=!settings.params.multipleViewers,filterByBands=1==settings.params.secondaryViewerType,that=(this.DirectionCodes=[],filterByBands?(this.filterByBand(0==this.containerIndex),this.DirectionCodes=[0,1,2,3,4,5]):0==this.containerIndex?this.DirectionCodes=singleViewer?[0,1,2,3,4,5]:[0,1]:this.DirectionCodes=[2,3,4,5],this.sortAndSliceByDirections(this.DirectionCodes),this.showPhotosInTE(),$("#PhotoViewerSelect-"+this.viewerName).html(""),this);this.photosList.forEach(function(val,index){var shortPhotoName=val.photo.match(/([^\\\/]+)[\\\/]?$/);$("#PhotoViewerSelect-"+that.viewerName).append("<option value="+index+"> "+shortPhotoName[1]+" ["+val.distance.toFixed(1)+" "+SGLang.i18n("TextMeter")+" , "+application.Directions[val.DirectionCode]+"] </option>")}),this.photoIndex=0,this.ShowPhoto(!0)},PhotoViewer.prototype.ShowPhoto=function(fromInit){var photoStruct,newPhoto,that=this,showNavigator=!settings.params.multipleViewers;(newPhoto=0==this.photosList.length?abspath()+"/images/noPhoto.jpg":(fromInit&&(this.photoIndex=that.CheckIfInTopList(this.photoIndex)),(photoStruct=this.photosList[this.photoIndex]).photo))==this.lastPhotoURL?0<that.photosList.length?that.ZoomToPixel(!1):that.viewer.viewport.goHome():(null!=this.viewer&&(this.viewer.clearOverlays(),this.viewer.destroy(),this.overlay=null),fromInit={},fromInit=0<=(this.lastPhotoURL=newPhoto).indexOf("http")?0<=newPhoto.indexOf(".smpt")||0<=newPhoto.indexOf(".SMPT")?{height:photoStruct.height,width:photoStruct.width,tileSize:256,minLevel:8,getTileUrl:function(level,x,y){return photoStruct.photo+"?level="+level+"&x="+x+"&y="+y}}:{type:"image",url:newPhoto,buildPyramid:!1}:0<=newPhoto.indexOf(".smpt")||0<=newPhoto.indexOf(".SMPT")?{height:photoStruct.height,width:photoStruct.width,tileSize:256,minLevel:0,getTileUrl:function(level,x,y){return"skyline:smpt."+newPhoto+"?level="+level+"&x="+x+"&y="+y}}:{type:"image",url:newPhoto,buildPyramid:!1},this.viewer=OpenSeadragon({id:"openseadragon-"+this.viewerName,prefixUrl:"../jquery/openseadragon-bin-2.4.2/images/",tileSources:fromInit,maxZoomPixelRatio:4,showRotationControl:!0,showNavigator:showNavigator,visibilityRatio:1,constrainDuringPan:!0,minZoomLevel:1}),this.viewer.addHandler("open",function(){0<that.photosList.length?that.ZoomToPixel(!0):that.viewer.viewport.goHome()}),this.viewer.addHandler("open-failed",function(){application.ShowLoadFailed()}),this.viewer.addHandler("pre-full-page",function(EventArgs){EventArgs.preventDefaultAction=!0}),this.viewer.addHandler("canvas-click",function(EventArgs){EventArgs.quick&&(EventArgs.preventDefaultAction=!0,0==inspections.DrawMode&&0==application.DrawMode||that.IsPointOnPhoto(EventArgs.position.x,EventArgs.position.y,photoStruct.width,photoStruct.height)&&that.ClickOnPhoto(EventArgs.position.x,EventArgs.position.y))}),this.viewer.addHandler("canvas-nonprimary-press",function(EventArgs){2===EventArgs.button&&that.RightClickOnPhoto()}),this.viewer.addHandler("canvas-drag",function(EventArgs){1!=inspections.DrawMode&&2!=inspections.DrawMode||1!=inspections.DrawingStyle||(EventArgs.preventDefaultAction=!0,0<EventArgs.position.x&&0<EventArgs.position.y&&EventArgs.position.x<that.viewer.canvas.offsetWidth&&EventArgs.position.y<that.viewer.canvas.offsetHeight&&(1==inspections.DrawMode&&inspections.CreateFeature(that.PositionFromPixel(EventArgs.position.x,EventArgs.position.y)),2==inspections.DrawMode)&&setTimeout(function(){inspections.AddWaypoint(that.PositionFromPixel(EventArgs.position.x,EventArgs.position.y))},5))}),this.viewer.addHandler("canvas-drag-end",function(EventArgs){1!=inspections.DrawMode&&2!=inspections.DrawMode||1!=inspections.DrawingStyle||(EventArgs.preventDefaultAction=!0,inspections.FinishDrawFeature(0,0,0,!1))}),this.viewer.addHandler("animation-finish",function(EventArgs){this.photosList&&0!=this.photosList.length&&settings.params.secondaryAttach&&0==that.containerIndex&&application.AttachSecondaryViewer(that.PositionFromPixel(that.viewer.viewport.getContainerSize().x/2,that.viewer.viewport.getContainerSize().y/2),that.viewer.viewport.getZoom(!0))}),new OpenSeadragon.MouseTracker({element:this.viewer.container,moveHandler:function(EventArgs){if(photoStruct)if(that.IsPointOnPhoto(EventArgs.position.x,EventArgs.position.y,photoStruct.width,photoStruct.height)){var position=that.PositionFromPixel(EventArgs.position.x,EventArgs.position.y);if(position){if(1==inspections.DrawMode||2==inspections.DrawMode){var flyToPos,screenPointInfo=SGWorld.Window.PixelFromWorld(position);if(!screenPointInfo.InsideScreenRect)return flyToPos=application.GetInitialFlyToPosition(photoStruct),void(this.outOfScreen?(this.outOfScreenFlyTo=this.outOfScreenFlyTo.MoveByOrientation(-10,0,0),SGWorld.Navigate.JumpTo(this.outOfScreenFlyTo)):(this.outOfScreen=!0,this.outOfScreenFlyTo=flyToPos.Copy(),SGWorld.Navigate.JumpTo(flyToPos)));SGWorld.Window.PixelToWorld(screenPointInfo.X,screenPointInfo.Y,-1)}0<EventArgs.position.x&&0<EventArgs.position.y&&EventArgs.position.x<that.viewer.canvas.offsetWidth&&EventArgs.position.y<that.viewer.canvas.offsetHeight&&application.ShowVirtualCursor(position),2!=inspections.DrawMode||0!=inspections.DrawingStyle&&3!=inspections.DrawingStyle||setTimeout(function(){inspections.HandleWaypointOnFrame(position)},5)}}else application.ShowVirtualCursor(null)},exitHandler:function(EventArgs){application.ShowVirtualCursor(null),this.numberOfFlyToPerformed=0,this.frameCounterForFlyTo=0,this.outOfScreen=!1}}))},PhotoViewer.prototype.IsPointOnPhoto=function(x,y,width,height){try{var newPoint=new OpenSeadragon.Point(x,y),viewportPoint=this.viewer.viewport.pointFromPixel(newPoint),imagePoint=this.viewer.viewport.viewportToImageCoordinates(viewportPoint);return imagePoint.x<0||imagePoint.x>width||imagePoint.y<0||imagePoint.y>height?!1:!0}catch(err){application.debug&&alert("PhotoViewer.js -> CheckIfInTopList: "+err.message)}},PhotoViewer.prototype.CheckIfInTopList=function(index){var newIndex=index,len=Math.min(this.photosList.length,this.TopListCount);for(i=0;i<len;i++)this.lastPhotoURL==this.photosList[i].photo&&(newIndex=i);return $("#PhotoViewerSelect-"+this.viewerName).val(newIndex),newIndex},PhotoViewer.prototype.ClickOnPhoto=function(X,Y,context){var context=context||this,photoStruct=context.photosList[context.photoIndex],point=context.PositionFromPixel(X,Y);if(null!=point){SGWorld.Creator.CreatePosition(photoStruct.x,photoStruct.y,photoStruct.z,3,photoStruct.yaw,photoStruct.pitch,photoStruct.roll);if(point.X<=photoStruct.x+1e-6&&point.X>=photoStruct.x-1e-6&&point.Y<=photoStruct.y+1e-6&&point.Y>=photoStruct.y-1e-6&&point.Altitude<=photoStruct.z+1e-6&&point.Altitude>=photoStruct.z-1e-6)return null;if(2==inspections.DrawMode&&inspections.HandleWaypointOnFrame(point),1==inspections.DrawMode||2==inspections.DrawMode)if(!SGWorld.Window.PixelFromWorld(point).InsideScreenRect)return null;1==inspections.DrawMode?(inspections.NewFeatureMode=!0,inspections.CreateFeature(point,!0)):2==inspections.DrawMode?inspections.AddWaypoint(point):0!=application.DrawMode&&(context=SGWorld.Navigate.GetPosition(3),point.Yaw=180-context.Yaw,point.Pitch=180-context.Pitch,point.Roll=0,point.Distance=services.CameraDistanceToModel(),SGWorld.Navigate.JumpTo(point),setTimeout(function(){application.SetMarkerPos(point)},10))}},PhotoViewer.prototype.RightClickOnPhoto=function(){application.OnRButtonUp(0,0,0),inspections.OnRButtonUp(0,0,0)},PhotoViewer.prototype.PositionFromPixel=function(X,Y){try{var newPoint=new OpenSeadragon.Point(X,Y),viewportPoint=this.viewer.viewport.pointFromPixel(newPoint),imagePoint=this.viewer.viewport.viewportToImageCoordinates(viewportPoint),photoStruct=this.photosList[this.photoIndex];return services.PixelToPoint(photoStruct,imagePoint)}catch(err){application.debug&&alert("PhotoViewer.js -> PositionFromPixel: "+err.message)}},PhotoViewer.prototype.ZoomToPixel=function(zoom){try{var pixel,pixelX,pixelY,photoStruct=this.photosList[this.photoIndex];photoStruct&&application.MarkerPosition&&(pixelX=(pixel=services.PointToPixel(photoStruct,application.MarkerPosition))[0],pixelY=pixel[1],-1!=pixelX&&-1!=pixelY&&(this.centerPoint=this.viewer.viewport.imageToViewportCoordinates(pixelX,pixelY),zoom&&this.viewer.viewport.zoomTo(7),this.viewer.viewport.panTo(this.centerPoint,!0),this.DrawOverlays(!0)),0)}catch(err){application.debug&&alert(err.message)}},PhotoViewer.prototype.PanToPos=function(pos,zoom){try{var photoStruct=this.photosList[this.photoIndex],pixel=services.PointToPixel(photoStruct,pos),pixelX=pixel[0],pixelY=pixel[1];-1!=pixelX&&-1!=pixelY&&(this.centerPoint=this.viewer.viewport.imageToViewportCoordinates(pixelX,pixelY),this.viewer.viewport.zoomTo(Math.round(zoom)),this.viewer.viewport.panTo(this.centerPoint,!0))}catch(err){application.debug&&alert(err.message)}},PhotoViewer.prototype.DrawOverlays=function(fromZoomToPixel,context){try{var that=context||this;if(0!=that.photosList.length){var photoStruct=that.photosList[that.photoIndex];if(null!=photoStruct&&null!=that.viewer&&application.MarkerPosition&&(fromZoomToPixel&&(that.inspectionIDToPointToPixelAndBackDistance={}),that.viewer.clearOverlays(),$("#PhotoViewerDiv-"+that.viewerName).append('<div id="imageRuler-'+that.viewerName+'" class="image-ruler">  </div>'),that.overlay=that.viewer.addOverlay("imageRuler-"+that.viewerName,that.centerPoint,OpenSeadragon.Placement.CENTER),null!=inspections.inspectionLayer))if(1==inspections.inspectionLayer.GeometryType?that.features=inspections.inspectionLayer.FeatureGroups.Polyline.GetCurrentFeatures():that.features=inspections.inspectionLayer.FeatureGroups.Polygon.GetCurrentFeatures(),that.features.Count<inspections.featureCountBeforeSave&&1!=inspections.DrawMode&&2!=inspections.DrawMode)that.inspectionFeatures=[],setTimeout(that.DrawOverlays,250,fromZoomToPixel,that);else if(0==that.features.Count)that.inspectionFeatures=[];else if(inspections.inspectionLayer.Visibility.Show){that.inspectionFeatures=[];for(var i=0;i<that.features.Count;i++){var featureStruct={};featureStruct.feature=that.features.Item(i),3!=featureStruct.feature.State&&that.CalculateScore(that,featureStruct)}that.inspectionFeatures.sort(that.compareScore),that.inspectionFeatures=that.inspectionFeatures.slice(0,settings.params.maxInspectionsOnPhoto);for(i=0;i<that.inspectionFeatures.length;i++)that.inspectionIDToPointToPixelAndBackDistance[that.inspectionFeatures[i].feature.ID]||(that.inspectionIDToPointToPixelAndBackDistance[that.inspectionFeatures[i].feature.ID]=that.IsOneOfFeaturesVerticesNotBehindTheTerrain(that.inspectionFeatures[i].feature));for(i=0;i<that.inspectionFeatures.length;i++){var p2pAndBackDistance,opacity,severity,inspectionPixel=services.PointToPixel(photoStruct,that.inspectionFeatures[i].annotationPosition),inspectionPoint=that.viewer.viewport.imageToViewportCoordinates(inspectionPixel[0],inspectionPixel[1]),drawID="inspectionDraw-"+Math.floor(1e4*Math.random()+1).toString();inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Severity")?(p2pAndBackDistance=that.inspectionIDToPointToPixelAndBackDistance[that.inspectionFeatures[i].feature.ID],opacity=that.MapPointToPixelAndBackDistanceToOpacity(p2pAndBackDistance),0==(severity=that.inspectionFeatures[i].feature.FeatureAttributes.Item(2).Value)?$("#PhotoViewerDiv-"+that.viewerName).append('<div style="opacity:'+opacity+';" id="'+drawID+"\"> <span class='distance'>"+that.inspectionFeatures[i].feature.FeatureAttributes.Item(1).Value+"</span></div>"):$("#PhotoViewerDiv-"+that.viewerName).append('<div style="opacity:'+opacity+';position:relative" id="'+drawID+"\"> <img src='images/Severity"+severity+".png' ><span class='annotation' style='position:absolute; left:0px; top:0px;left:50%;top:50%;transform: translate(-50%,-75%);'>"+that.inspectionFeatures[i].feature.FeatureAttributes.Item(0).Value+"</span> </div>")):$("#PhotoViewerDiv-"+that.viewerName).append('<div id="'+drawID+"\"> <span class='distance'></span></div>"),that.overlay=that.viewer.addOverlay(drawID,inspectionPoint,OpenSeadragon.Placement.BOTTOM)}(that=that).CanvasOverlay=that.viewer.canvasOverlay({onRedraw:function(){try{0!=that.photosList.length&&(1==inspections.inspectionLayer.GeometryType?that.DrawOverlaysPolylineAndMultipolyline():that.DrawOverlaysPolygonAndMultipolygon())}catch(err){application.debug&&alert("PhotoViewer.js -> onRedraw "+err.message)}}}),$(window).resize(function(){null!=that.CanvasOverlay&&that.CanvasOverlay.resize()}),that.overlay=that.CanvasOverlay}else that.inspectionFeatures=[]}}catch(err){application.debug&&alert("PhotoViewer.js -> DrawOverlays: "+err.message)}},PhotoViewer.prototype.CalculateScore=function(that,featureStruct){try{featureStruct.annotationPosition=inspections.CalcAnnotationPosition(featureStruct.feature),featureStruct.searchScore=featureStruct.annotationPosition.DistanceTo(application.MarkerPosition),that.inspectionFeatures.push(featureStruct)}catch(err){application.debug&&alert("PhotoViewer.js -> CalculateScore: "+err.message)}},PhotoViewer.prototype.IsOneOfFeaturesVerticesNotBehindTheTerrain=function(feature){try{var photoStruct=this.photosList[this.photoIndex],pointToPixelAndBackHighestDistance=100;if(5==feature.Geometry.GeometryType)for(var k=0;k<feature.Geometry.NumGeometries;k++){var polylineGeometry=feature.Geometry.Geometry(k),numOfPoints=polylineGeometry.Points.Count;for(j=0;j<numOfPoints;j++){var waypointPos=SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(j).X,polylineGeometry.Points.Item(j).Y,polylineGeometry.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(photoStruct,waypointPos),waypointGeoPosition=services.PixelToPoint(photoStruct,{x:waypointPixel[0],y:waypointPixel[1]});(distance=waypointPos.DistanceTo(waypointGeoPosition))<pointToPixelAndBackHighestDistance&&(pointToPixelAndBackHighestDistance=distance)}}else if(1==inspections.inspectionLayer.GeometryType){numOfPoints=feature.Geometry.NumPoints;for(j=0;j<numOfPoints;j++){waypointPos=SGWorld.Creator.CreatePosition(feature.Geometry.Points.Item(j).X,feature.Geometry.Points.Item(j).Y,feature.Geometry.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(photoStruct,waypointPos),waypointGeoPosition=services.PixelToPoint(photoStruct,{x:waypointPixel[0],y:waypointPixel[1]});(distance=waypointPos.DistanceTo(waypointGeoPosition))<pointToPixelAndBackHighestDistance&&(pointToPixelAndBackHighestDistance=distance)}}else if(6==feature.Geometry.GeometryType)for(k=0;k<feature.Geometry.NumGeometries;k++){var polygonGeometry=feature.Geometry.Geometry(k),numOfPoints=polygonGeometry.ExteriorRing.Points.Count;for(j=0;j<numOfPoints;j++){waypointPos=SGWorld.Creator.CreatePosition(polygonGeometry.ExteriorRing.Points.Item(j).X,polygonGeometry.ExteriorRing.Points.Item(j).Y,polygonGeometry.ExteriorRing.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(photoStruct,waypointPos),waypointGeoPosition=services.PixelToPoint(photoStruct,{x:waypointPixel[0],y:waypointPixel[1]});(distance=waypointPos.DistanceTo(waypointGeoPosition))<pointToPixelAndBackHighestDistance&&(pointToPixelAndBackHighestDistance=distance)}}else{numOfPoints=feature.Geometry.ExteriorRing.NumPoints;for(j=0;j<numOfPoints;j++){var distance,waypointPos=SGWorld.Creator.CreatePosition(feature.Geometry.ExteriorRing.Points.Item(j).X,feature.Geometry.ExteriorRing.Points.Item(j).Y,feature.Geometry.ExteriorRing.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(photoStruct,waypointPos),waypointGeoPosition=services.PixelToPoint(photoStruct,{x:waypointPixel[0],y:waypointPixel[1]});(distance=waypointPos.DistanceTo(waypointGeoPosition))<pointToPixelAndBackHighestDistance&&(pointToPixelAndBackHighestDistance=distance)}}return pointToPixelAndBackHighestDistance}catch(err){application.debug&&alert("PhotoViewer.js -> IsOneOfFeaturesVerticesNotBehindTheTerrain: "+err.message)}},PhotoViewer.prototype.DrawOverlaysPolylineAndMultipolyline=function(){for(i=0;i<this.inspectionFeatures.length;i++){var ctx=this.CanvasOverlay.context2d(),feature=(ctx.lineWidth=settings.params.lineWidth,ctx.beginPath(),this.inspectionFeatures[i].feature);if(5==feature.Geometry.GeometryType)for(var k=0;k<feature.Geometry.NumGeometries;k++){var polylineGeometry=feature.Geometry.Geometry(k),numOfPoints=polylineGeometry.Points.Count;for(j=0;j<numOfPoints;j++){var waypointPos=SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(j).X,polylineGeometry.Points.Item(j).Y,polylineGeometry.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(this.photosList[this.photoIndex],waypointPos),waypointPoint=this.viewer.viewport.imageToViewportCoordinates(waypointPixel[0],waypointPixel[1]);0==j?ctx.moveTo(waypointPoint.x,waypointPoint.y):ctx.lineTo(waypointPoint.x,waypointPoint.y)}ctx.strokeStyle=this.GetRBGHexLineColor(this.inspectionIDToPointToPixelAndBackDistance[feature.ID],feature),ctx.fillStyle="transparent",ctx.stroke()}else{numOfPoints=this.inspectionFeatures[i].feature.Geometry.NumPoints;for(j=0;j<numOfPoints;j++){waypointPos=SGWorld.Creator.CreatePosition(this.inspectionFeatures[i].feature.Geometry.Points.Item(j).X,this.inspectionFeatures[i].feature.Geometry.Points.Item(j).Y,this.inspectionFeatures[i].feature.Geometry.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(this.photosList[this.photoIndex],waypointPos),waypointPoint=this.viewer.viewport.imageToViewportCoordinates(waypointPixel[0],waypointPixel[1]);0==j?ctx.moveTo(waypointPoint.x,waypointPoint.y):ctx.lineTo(waypointPoint.x,waypointPoint.y)}ctx.strokeStyle=this.GetRBGHexLineColor(this.inspectionIDToPointToPixelAndBackDistance[feature.ID],feature),ctx.fillStyle="transparent",ctx.stroke()}}},PhotoViewer.prototype.DrawOverlaysPolygonAndMultipolygon=function(){for(i=0;i<this.inspectionFeatures.length;i++){var ctx=this.CanvasOverlay.context2d(),feature=(ctx.lineWidth=settings.params.lineWidth,ctx.beginPath(),this.inspectionFeatures[i].feature);if(6==feature.Geometry.GeometryType)for(var k=0;k<feature.Geometry.NumGeometries;k++){var polygonGeometry=feature.Geometry.Geometry(k),numOfPoints=polygonGeometry.ExteriorRing.Points.Count;for(j=0;j<numOfPoints;j++){var waypointPos=SGWorld.Creator.CreatePosition(polygonGeometry.ExteriorRing.Points.Item(j).X,polygonGeometry.ExteriorRing.Points.Item(j).Y,polygonGeometry.ExteriorRing.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(this.photosList[this.photoIndex],waypointPos),waypointPoint=this.viewer.viewport.imageToViewportCoordinates(waypointPixel[0],waypointPixel[1]);0==j?ctx.moveTo((firstPoint=waypointPoint).x,waypointPoint.y):ctx.lineTo(waypointPoint.x,waypointPoint.y)}ctx.lineTo(firstPoint.x,firstPoint.y)}else{var firstPoint,numOfPoints=feature.Geometry.ExteriorRing.NumPoints;for(j=0;j<numOfPoints;j++){waypointPos=SGWorld.Creator.CreatePosition(feature.Geometry.ExteriorRing.Points.Item(j).X,feature.Geometry.ExteriorRing.Points.Item(j).Y,feature.Geometry.ExteriorRing.Points.Item(j).Z,3),waypointPixel=services.PointToPixel(this.photosList[this.photoIndex],waypointPos),waypointPoint=this.viewer.viewport.imageToViewportCoordinates(waypointPixel[0],waypointPixel[1]);0==j?ctx.moveTo((firstPoint=waypointPoint).x,waypointPoint.y):ctx.lineTo(waypointPoint.x,waypointPoint.y)}ctx.lineTo(firstPoint.x,firstPoint.y)}ctx.strokeStyle=this.GetRBGHexLineColor(this.inspectionIDToPointToPixelAndBackDistance[feature.ID],feature),ctx.fillStyle="transparent",ctx.stroke()}},PhotoViewer.prototype.GetRBGHexLineColor=function(pointToPixelAndBackDistance,feature){try{var lineColorGBRDecString;if(inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Severity"))rgbaString=inspections.SeverityColors[feature.FeatureAttributes.Item(2).Value];else{lineColorGBRDecString=1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline.GetProperty("Line Color"):2==inspections.inspectionLayer.FeatureGroups.Polygon.GetProperty("Classification Mode")?inspections.inspectionLayer.FeatureGroups.Polygon.GetProperty("Fill Color"):inspections.inspectionLayer.FeatureGroups.Polygon.GetProperty("Line Color");for(var lineColorGBRHexString=parseInt(lineColorGBRDecString,10).toString(16);lineColorGBRHexString.length<6;)lineColorGBRHexString="0"+lineColorGBRHexString;var greenHex=lineColorGBRHexString.substring(0,2),greenDec=parseInt(greenHex,16),redHex=lineColorGBRHexString.slice(-2),redDec=parseInt(redHex,16),blueHex=lineColorGBRHexString.slice(2,lineColorGBRHexString.length-2),rgbaString="rgba("+redDec+","+parseInt(blueHex,16)+","+greenDec+","}return rgbaString+=this.MapPointToPixelAndBackDistanceToOpacity(pointToPixelAndBackDistance)+")"}catch(err){application.debug&&alert(err.message)}},PhotoViewer.prototype.MapPointToPixelAndBackDistanceToOpacity=function(pointToPixelAndBackDistance){try{return 5<=pointToPixelAndBackDistance?0:1.6<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<5?.25:1.2<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<1.6?.5:.8<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<1.2?1:.3<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<.8?1:.1<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<.3?1:.05<=pointToPixelAndBackDistance&&pointToPixelAndBackDistance<.1?1:1}catch(err){application.debug&&alert(err.message)}},PhotoViewer.prototype.showPhotosInTE=function(){this.photosList.forEach(function(val,index){val.feature.FeatureAttributes.GetFeatureAttribute("visible").Value=1})},PhotoViewer.prototype.filterByBand=function(RGB){try{this.photoCandidatesList=this.photoCandidatesList.filter(function(item){return RGB?"Red,Green,Blue"==item.bands:"Red,Green,Blue"!==item.bands})}catch(err){}},PhotoViewer.prototype.sortAndSliceByDirections=function(codes){var that=this;this.photosList=[],this.photoCandidatesList.forEach(function(val,index){-1<codes.indexOf(val.DirectionCode)&&that.photosList.push(val)}),this.photosList.sort(this.compareScore),this.photosList=this.photosList.slice(0,settings.params.maxResultPerSide)},PhotoViewer.prototype.compareScore=function(a,b){return a.searchScore<b.searchScore?-1:a.searchScore>b.searchScore?1:0},PhotoViewer.prototype.userClickedPhotoIcon=function(featureID){try{var that=this;this.photosList.forEach(function(val,index){val.featureID==featureID&&($("#PhotoViewerSelect-"+that.viewerName).val(index),that.photoIndex=index,that.ShowPhoto(!1))})}catch(err){}},PhotoViewer.prototype.PrevNextPhoto=function(delta){try{var index;0!=this.photosList.length&&(index=Math.min(Math.max(this.photoIndex+delta,0),this.photosList.length-1))!=this.photoIndex&&($("#PhotoViewerSelect-"+this.viewerName).val(index),this.photoIndex=index,this.ShowPhoto(!1))}catch(err){}};