var inspections={featureCountBeforeSave:0,inspectionLayerID:null,inspectionLayer:null,DrawMode:0,DrawingStyle:0,FeatureType:0,CurrentFeature:null,CreateBy:"",NewFeatureMode:!1,eventAttached:!1,highlightedFeature:null,LastCursorPos:null,InspectionListTable:null,LastPointTimer:0,SeverityColors:["rgba(255,233,159,","rgba(76,209,47,","rgba(211,232,0,","rgba(255,106,0,","rgba(255,68,68,","rgba(149,60,193,"],attributeTemplate:[{name:"Index",type:1,manadatory:!0},{name:"Title",type:0,manadatory:!0},{name:"Severity",type:1,manadatory:!0},{name:"CreateBy",type:0,manadatory:!0},{name:"Description",type:0,manadatory:!1},{name:"",type:0,manadatory:!1},{name:"",type:0,manadatory:!1},{name:"",type:0,manadatory:!1},{name:"",type:0,manadatory:!1},{name:"",type:0,manadatory:!1}],toolboxButtonsEnabled:!0,featureCreated:!1,Init:function(LayerID){try{this.inspectionLayerID=LayerID,this.populateInspectionLayerList($("#InspectionListID"),!1),null==this.inspectionLayerID||""==this.inspectionLayerID?(this.EnableToolboxButtons(!1),this.toolboxButtonsEnabled=!1):(this.EnableToolboxButtons(!0),this.toolboxButtonsEnabled=!0,this.inspectionLayer=SGWorld.Creator.GetObject(this.inspectionLayerID),SGWorld.ProjectTree.SetVisibility(this.inspectionLayerID,!0),settings.MatchUIWithInspectionLayerType(),this.featureCountBeforeSave=services.CountFeaturesInLayer(this.inspectionLayer),this.SaveLayer(this.inspectionLayer)),TEF&&($("#openListInTE").hide(),$("#generateReportBtn").hide())}catch(err){application.debug&&alert("inspections.js -> Init: "+err.message),this.EnableToolboxButtons(!1)}},SaveLayer:function(inspectionLayer){try{SGWorld.ProjectTree.GetLayerAsync(inspectionLayer.ID).OnResolve(function(latesInspectionLayer){latesInspectionLayer.Editable||(inspections.EnableToolboxButtons(!1),alert(SGLang.i18n("TextNoPermissions")))}).OnReject(function(error){application.debug&&alert("inspections.js -> SaveLayer OnReject: "+err.message)})}catch(err){application.debug&&alert("inspections.js -> SaveLayer: "+err.message)}},OpenLayerPS:function(){try{null!=this.inspectionLayer&&(SGWorld.ProjectTree.SelectItem(this.inspectionLayerID,0,0),SGWorld.Command.Execute(1158,0))}catch(err){application.debug&&alert("inspections.js -> OpenLayerPS: "+err.message),this.EnableToolboxButtons(!1)}},StyleInspectionLayer:function(fromCreate){try{null==this.inspectionLayer||!fromCreate&&0==confirm(SGLang.i18n("TextResetStyleConfirm"))||(this.inspectionLayer.Annotation=!0,this.inspectionLayer.FeatureGroups.Polyline.SetProperty("Max. Visibility Distance",2e3),this.inspectionLayer.FeatureGroups.Polyline.SetProperty("Max. Show-Through Dist.",100),this.inspectionLayer.FeatureGroups.Polyline.SetProperty("Altitude Method",1),this.inspectionLayer.FeatureGroups.Polyline.SetProperty("Line Width",-3),this.inspectionLayer.FeatureGroups.Polyline.SetClassification("Line Color","<Classification FuncType='0'><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>10485759</Value></Class><Class><Condition>&lt;[Severity]=1&gt;</Condition><Value>65280</Value></Class><Class><Condition>&lt;[Severity]=2&gt;</Condition><Value>55551</Value></Class><Class><Condition>&lt;[Severity]=3&gt;</Condition><Value>33023</Value></Class><Class><Condition>&lt;[Severity]=4&gt;</Condition><Value>6183935</Value></Class><Class><Condition>&lt;[Severity]=5&gt;</Condition><Value>9780417</Value></Class><DefaultValue>255</DefaultValue></Classification>"),this.inspectionLayer.FeatureGroups.Annotation.DisplayAs=18,this.inspectionLayer.FeatureGroups.Annotation.SetClassification("Text",'<Classification FuncType="0"><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>[Title]</Value></Class><DefaultValue>[Index]</DefaultValue></Classification>'),this.inspectionLayer.FeatureGroups.Annotation.SetClassification("Text Color",'<Classification FuncType="0"><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>10485759</Value></Class><DefaultValue>16777215</DefaultValue></Classification>'),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Background Color",3158064),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Text Size",14),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Text Alignment",14),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Altitude Method",1),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Image File",abspath()+"/images/MarkerAnnotation.png"),this.inspectionLayer.FeatureGroups.Annotation.SetClassification("Scale",'<Classification FuncType="0"><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>0.07</Value></Class><DefaultValue>1</DefaultValue></Classification>'),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Max. Show-Through Dist.",100),this.inspectionLayer.FeatureGroups.Annotation.SetProperty("Tool Tip","[Title]"),this.inspectionLayer.FeatureGroups.Annotation.SetClassification("Image Color","<Classification FuncType='0'><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>10485759</Value></Class><Class><Condition>&lt;[Severity]=1&gt;</Condition><Value>5034287</Value></Class><Class><Condition>&lt;[Severity]=2&gt;</Condition><Value>55551</Value></Class><Class><Condition>&lt;[Severity]=3&gt;</Condition><Value>33023</Value></Class><Class><Condition>&lt;[Severity]=4&gt;</Condition><Value>6183935</Value></Class><Class><Condition>&lt;[Severity]=5&gt;</Condition><Value>9780417</Value></Class><DefaultValue>255</DefaultValue></Classification>"),this.inspectionLayer.FeatureGroups.Annotation.SetClassification("Image Opacity",'<Classification FuncType="0"><Class><Condition>&lt;[Severity]=0&gt;</Condition><Value>0</Value></Class><DefaultValue>100</DefaultValue></Classification>'))}catch(err){application.debug&&alert("inspections.js -> StyleInspectionLayer : "+err.message),this.EnableToolboxButtons(!1)}},Reset:function(FirstTime,FromMouseInputMode){if(inspections.featureCreated=!1,inspections.eventAttached&&(SGWorld.DetachEvent("OnLButtonDown",this.OnLButtonDown),SGWorld.DetachEvent("OnLButtonClicked",this.OnLButtonClicked),SGWorld.DetachEvent("OnLButtonUp",this.OnLButtonUp),SGWorld.DetachEvent("OnRButtonUp",this.OnRButtonUp),SGWorld.DetachEvent("OnFrame",this.OnFrame),SGWorld.DetachEvent("OnInputModeChanged",this.OnInputModeChanged),SGWorld.DetachEvent("OnObjectUnderCursorChanged",this.OnObjectUnderCursorChanged),inspections.eventAttached=!1),null!=inspections.CurrentFeature)try{inspections.CurrentFeature.Highlight=!1,inspections.CurrentFeature.Geometry.EndEdit()}catch(err){}this.DrawMode=0,this.highlightedFeature=null,$("#toolInspectionDraw0").removeClass("toolboxIconHighlight"),$("#toolInspectionDraw1").removeClass("toolboxIconHighlight"),$("#toolInspectionDraw2").removeClass("toolboxIconHighlight"),$("#toolInspectionSelect").removeClass("toolboxIconHighlight"),1!=FirstTime&&0==FromMouseInputMode&&(SGWorld.Window.SetInputMode(0),$(".PhotoWindowOpenSeaDragon").css("cursor","move")),inspections.UItoDrawingMode(!1)},Exit:function(){try{this.inspectionLayer.SaveAsync()}catch(err){}},EnableToolboxButtons:function(enable){$("#toolInspectionDraw0").prop("disabled",!enable),$("#toolInspectionDraw1").prop("disabled",!enable),$("#toolInspectionDraw2").prop("disabled",!enable),$("#toolInspectionSelect").prop("disabled",!enable),$("#toolInspectionShowList").prop("disabled",!enable),enable?($("#toolInspectionDraw0").removeClass("toolboxIconDisabled"),$("#toolInspectionDraw1").removeClass("toolboxIconDisabled"),$("#toolInspectionDraw2").removeClass("toolboxIconDisabled"),$("#toolInspectionSelect").removeClass("toolboxIconDisabled"),$("#toolInspectionShowList").removeClass("toolboxIconDisabled")):($("#toolInspectionDraw0").addClass("toolboxIconDisabled"),$("#toolInspectionDraw1").addClass("toolboxIconDisabled"),$("#toolInspectionDraw2").addClass("toolboxIconDisabled"),$("#toolInspectionSelect").addClass("toolboxIconDisabled"),$("#toolInspectionShowList").addClass("toolboxIconDisabled"))},PartlyEnableToolboxButtons:function(enable){1==enable?($("#toolInspectionDraw1").prop("disabled",!1),$("#toolInspectionDraw2").prop("disabled",!1),$("#InspectionDrawModeID").val(0),$("#InspectionDrawModeID").removeAttr("disabled"),$("#toolInspectionDraw1").removeClass("toolboxIconDisabled"),$("#toolInspectionDraw2").removeClass("toolboxIconDisabled")):(0==enable?($("#toolInspectionDraw1").prop("disabled",!0),$("#toolInspectionDraw2").prop("disabled",!0),$("#InspectionDrawModeID").val(3),$("#InspectionDrawModeID").attr("disabled","disabled")):($("#toolInspectionDraw1").prop("disabled",!1),$("#toolInspectionDraw2").prop("disabled",!1),$("#InspectionDrawModeID").val(0),$("#InspectionDrawModeID").removeAttr("disabled")),$("#toolInspectionDraw1").addClass("toolboxIconDisabled"),$("#toolInspectionDraw2").addClass("toolboxIconDisabled"))},UItoDrawingMode:function(drawMode){var id="#toolInspectionDraw"+inspections.featureType;$("#toolInspectionSelect").prop("disabled",drawMode),$("#toolReset").prop("disabled",drawMode),$("#toolBoxSelectPoint").prop("disabled",drawMode),$("#toolMultipleViewers").prop("disabled",drawMode),(drawMode?($("#toolInspectionDraw0").addClass("toolboxIconDisabled"),$("#toolInspectionDraw1").addClass("toolboxIconDisabled"),$("#toolInspectionDraw2").addClass("toolboxIconDisabled"),$("#toolInspectionSelect").addClass("toolboxIconDisabled"),$("#toolReset").addClass("toolboxIconDisabled"),$("#toolBoxSelectPoint").addClass("toolboxIconDisabled"),$("#toolMultipleViewers").addClass("toolboxIconDisabled"),$(id)):((1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?($("#toolInspectionDraw0").removeClass("toolboxIconDisabled"),$("#toolInspectionDraw1").removeClass("toolboxIconDisabled"),$("#toolInspectionDraw2")):$(id)).removeClass("toolboxIconDisabled"),$("#toolInspectionSelect").removeClass("toolboxIconDisabled"),$("#toolReset").removeClass("toolboxIconDisabled"),$("#toolBoxSelectPoint").removeClass("toolboxIconDisabled"),$("#toolMultipleViewers"))).removeClass("toolboxIconDisabled")},SelectInspectionLayer:function(){this.Init($("#InspectionListID").val())},Draw:function(newFeature,featureType){try{if(!(0==featureType&&$("#toolInspectionDraw0").prop("disabled")||1==featureType&&$("#toolInspectionDraw1").prop("disabled")||2==featureType&&$("#toolInspectionDraw2").prop("disabled"))&&(null!=inspections.inspectionLayerID&&""!=this.inspectionLayerID)){if(1==inspections.DrawMode||2==inspections.DrawMode)return inspections.featureType!=featureType?void 0:(inspections.Reset(!1,!1),void inspections.DeleteFeature());switch(inspections.featureType=featureType,inspections.UItoDrawingMode(!0),inspections.FeatureType=featureType,inspections.NewFeatureMode=newFeature,null==this.CurrentFeature&&(this.NewFeatureMode=!0),SGWorld.Window.SetInputMode(0),$("#toolInspectionDraw"+inspections.FeatureType).addClass("toolboxIconHighlight"),SGWorld.Window.ShowMessageBarText(SGLang.i18n("TextInspectionDrawInstructions"),1,3e3),inspections.AttachEvents(),inspections.FeatureType){case 0:this.DrawingStyle=settings.params.InspectionDrawMode;break;case 1:this.DrawingStyle=2;break;case 2:this.DrawingStyle=0}var cursor=2==inspections.FeatureType?abspath()+"/resources/cursor_dis.cur":abspath()+"/resources/cursor_d.cur";SGWorld.Window.SetInputMode(1,cursor,1!=this.DrawingStyle),$(".PhotoWindowOpenSeaDragon").css("cursor","default"),this.featureCountBeforeSave=inspections.inspectionLayer.Count,this.DrawMode=1}}catch(err){application.debug&&alert("inspections.js -> Draw: "+err.message)}},Select:function(show){$("#toolInspectionSelect").prop("disabled")||this.toolboxButtonsEnabled&&(3==inspections.DrawMode?inspections.Reset(!1,!1):(SGWorld.Window.SetInputMode(0),SGWorld.Window.SetInputMode(1,abspath()+"/resources/cursor_m.cur",!1),$(".PhotoWindowOpenSeaDragon").css("cursor","default"),$("#toolInspectionSelect").addClass("toolboxIconHighlight"),SGWorld.Window.ShowMessageBarText(SGLang.i18n("TextInspectionSelectInstructions"),1,3e3),inspections.AttachEvents(),inspections.DrawMode=3))},AttachEvents:function(){0==inspections.eventAttached&&(SGWorld.AttachEvent("OnLButtonDown",this.OnLButtonDown),SGWorld.AttachEvent("OnLButtonClicked",this.OnLButtonClicked),SGWorld.AttachEvent("OnLButtonUp",this.OnLButtonUp),SGWorld.AttachEvent("OnRButtonUp",this.OnRButtonUp),SGWorld.AttachEvent("OnFrame",this.OnFrame),SGWorld.AttachEvent("OnInputModeChanged",this.OnInputModeChanged),SGWorld.AttachEvent("OnObjectUnderCursorChanged",this.OnObjectUnderCursorChanged),inspections.eventAttached=!0)},EditFeature:function(featureID,feature,flyTo){try{null==featureID&&(featureID=feature.ID);try{inspections.CurrentFeature=SGWorld.Creator.GetObject(featureID)}catch(err){var polyFeatureID;null!=feature&&(polyFeatureID=feature.GetParam(65536),inspections.CurrentFeature=SGWorld.Creator.GetObject(polyFeatureID))}flyTo&&inspections.FlyToFeature(inspections.CurrentFeature.ID),inspections.Reset(!1,!0),inspections.ShowEditInspectionFeature(1)}catch(err){application.debug&&alert("inspections.js -> EditFeature: "+err.message)}},ShowEditInspectionFeature:function(mode){1==mode?(inspections.ShowAttributeValues(),$("#inspectionPropertiesDiv").show(),application.zIndex++,$("#inspectionPropertiesDiv").css("z-index",application.zIndex)):(0==mode&&inspections.UpdateAttributes(!0),$("#inspectionPropertiesDiv").hide(),TEF||inspections.SelectBIM(!0),$("#inspectionListDiv").is(":visible")&&this.BuildList(),application.RedrawInspectionsOnPhotos())},ShowAttributeValues:function(){try{if(null!=this.CurrentFeature){$("#inspectionPropertiesAttributes").html("");var htmlTxt="",attributesCount=this.CurrentFeature.FeatureAttributes.Count,index=1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&""!=this.CurrentFeature.FeatureAttributes.Item(0).Value?this.CurrentFeature.FeatureAttributes.Item(0).Value:"";for($("#InspectionPropertiesIndexID").html(index),i=0,i=1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?1:i;i<attributesCount;i++)htmlTxt+="<tr><td class='s9'> <label>"+this.CurrentFeature.FeatureAttributes.Item(i).Name+"</label> </td> ",2===i&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?1==inspections.inspectionLayer.GeometryType&&0==this.CurrentFeature.FeatureAttributes.Item(2).Value?htmlTxt+="<td class='s9'> <input id='InspectionAttrValue"+i+"' type='text' readonly size='17' /> </td></tr>":htmlTxt+="<td align='left'>            <select id='InspectionAttrValue"+i+"'  class='selectNew' onchange='inspections.UpdateAttributes(false)' >               <option value=1 >"+SGLang.i18n("TextSeverity1")+" - 1</option>               <option value=2 >"+SGLang.i18n("TextSeverity2")+" - 2</option>               <option value=3 >"+SGLang.i18n("TextSeverity3")+" - 3</option>               <option value=4 >"+SGLang.i18n("TextSeverity4")+" - 4</option>               <option value=5 >"+SGLang.i18n("TextSeverity5")+" - 5</option>           </select> </td> </tr>":htmlTxt+="<td class='s9'> <input id='InspectionAttrValue"+i+"' type='text' value='"+this.CurrentFeature.FeatureAttributes.Item(i).Value+"' size='17'/> </td></tr>";$("#inspectionPropertiesAttributes").append(htmlTxt);var severity;inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&(0==(severity=this.CurrentFeature.FeatureAttributes.Item(2).Value)?$("#InspectionAttrValue2").val(SGLang.i18n("TextSeverity0")):$("#InspectionAttrValue2").val(severity)),1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&0==this.CurrentFeature.FeatureAttributes.Item(2).Value||2==inspections.DrawingStyle?$("#InspectionPSRedrawID").hide():$("#InspectionPSRedrawID").show()}}catch(err){application.debug&&alert("inspections.js -> ShowAttributeValues: "+err.message)}},UpdateAttributes:function(needSave){if(null!=this.CurrentFeature)try{var attributeLen=this.CurrentFeature.FeatureAttributes.Count;for(i=0,i=1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?1:i;i<attributeLen;i++){try{this.CurrentFeature.FeatureAttributes.Item(i).Value=$("#InspectionAttrValue"+i).val()}catch(e){}1!=inspections.inspectionLayer.DataSourceInfo.Attributes.Item(i).Type&&2!=inspections.inspectionLayer.DataSourceInfo.Attributes.Item(i).Type||!isNaN($("#InspectionAttrValue"+i).val())||(this.CurrentFeature.FeatureAttributes.Item(i).Value=0),1==inspections.inspectionLayer.DataSourceInfo.Attributes.Item(i).Type&&(this.CurrentFeature.FeatureAttributes.Item(i).Value=parseInt(this.CurrentFeature.FeatureAttributes.Item(i).Value))}inspections.CreateBy=$("#InspectionAttrValue3").val(),this.featureCountBeforeSave=services.CountFeaturesInLayer(this.inspectionLayer),this.inspectionLayer.SaveAsync().OnResolve(function(){application.RedrawInspectionsOnPhotos()}).OnReject(function(){application.debug&&alert("inspections.js -> UpdateAttributes OnReject: "+err.message)})}catch(err){application.debug&&alert("inspections.js -> UpdateAttributes: "+err.message)}},DeleteFeature:function(){if(null!=this.CurrentFeature)try{confirm(SGLang.i18n("TextInspectionConfirmDelete"))&&((1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline:inspections.inspectionLayer.FeatureGroups.Polygon).RemoveFeature(this.CurrentFeature.ID),inspections.features,this.featureCountBeforeSave=services.CountFeaturesInLayer(this.inspectionLayer)-1,this.inspectionLayer.SaveAsync().OnResolve(function(){inspections.CurrentFeature=null,application.RedrawInspectionsOnPhotos(),inspections.ShowEditInspectionFeature(2)}).OnReject(function(){application.debug&&alert("inspections.js -> DeleteFeature OnReject: "+err.message)}))}catch(err){application.debug&&alert("inspections.js -> DeleteFeature: "+err.message)}},FlyToFeature:function(featureID){try{null==featureID&&null==this.CurrentFeature||(null==featureID&&(featureID=this.CurrentFeature.ID),SGWorld.Creator.GetObject(featureID),SGWorld.Navigate.FlyTo(featureID))}catch(err){application.debug&&alert("inspection.js -> FlyToFeature: "+err.message)}},ShowPhotosFeature:function(featureID,flyTo){try{var feature,annotationPosition;null==featureID&&null==this.CurrentFeature||(null==featureID&&(featureID=this.CurrentFeature.ID),feature=SGWorld.Creator.GetObject(featureID),annotationPosition=this.CalcAnnotationPosition(feature),application.SetMarkerPos(annotationPosition),flyTo&&this.FlyToFeature(featureID))}catch(err){application.debug&&alert("inspections.js -> ShowPhotosFeature: "+err.message)}},SelectBIM:function(forceClose){try{var BimFeature;""==settings.params.meshModelID||""==settings.params.BIMModelID?forceClose||alert(SGLang.i18n("TextInspectionNeedToSelectBIM")):forceClose||$("#InspectionPSSelectBIMID").hasClass("MenuButtonBlueShadow")?(SGWorld.ProjectTree.SetVisibility(settings.params.meshModelID,!0),SGWorld.ProjectTree.SetVisibility(settings.params.BIMModelID,!1),$("#InspectionPSSelectBIMID").removeClass("MenuButtonBlueShadow")):(SGWorld.ProjectTree.SetVisibility(settings.params.meshModelID,!1),SGWorld.ProjectTree.SetVisibility(settings.params.BIMModelID,!0),BimFeature=SGWorld.ProjectTree.GetNextItem(settings.params.BIMModelID,11),SGWorld.ProjectTree.SelectItem(BimFeature),SGWorld.Command.Execute(1070,null),$("#InspectionPSSelectBIMID").addClass("MenuButtonBlueShadow"))}catch(err){application.debug&&alert("inspections.js -> ShowPhotosFeature: "+err.message)}},OpenListInTE:function(){try{SGWorld.ProjectTree.SelectItem(inspections.inspectionLayerID,0,0),SGWorld.Command.Execute(1086,0)}catch(err){}},OnLButtonDown:function(flags,X,Y){try{var CursorCoord;return 0==inspections.DrawMode||1!=inspections.DrawingStyle?!1:null!=(CursorCoord=SGWorld.Window.PixelToWorld(X,Y,8401))&&void(1==inspections.DrawMode?inspections.CreateFeature(CursorCoord.Position):2==inspections.DrawMode&&inspections.AddWaypoint(CursorCoord.Position))}catch(err){application.debug&&alert(err.message)}},OnLButtonClicked:function(flags,X,Y){if(3!=inspections.DrawMode||null==inspections.highlightedFeature)return 0!=inspections.DrawMode&&1!=inspections.DrawingStyle&&null!=(X=SGWorld.Window.PixelToWorld(X,Y,8401))&&void(1==inspections.DrawMode?inspections.CreateFeature(X.Position):2==inspections.DrawMode&&inspections.AddWaypoint(X.Position));inspections.EditFeature(null,inspections.highlightedFeature,!1),inspections.Reset(!1,!1)},CreateFeature:function(pos,callAddPoint){try{var featureID,secondPos=pos.Move(.001,0,0),firstPoint=[pos.X,pos.Y,pos.Altitude,secondPos.X,secondPos.Y,secondPos.Altitude];this.insertIndex=1,3==inspections.DrawingStyle&&firstPoint.push(pos.X,pos.Y,pos.Altitude),1!=inspections.inspectionLayer.GeometryType&&firstPoint.push(pos.X,pos.Y,pos.Altitude),inspections.NewFeatureMode?(this.featureCountBeforeSave=services.CountFeaturesInLayer(inspections.inspectionLayer)+1,featureID=(1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline:inspections.inspectionLayer.FeatureGroups.Polygon).CreateFeature(firstPoint),inspections.CurrentFeature=SGWorld.Creator.GetObject(featureID),inspections.inspectionLayer.Streaming&&(SGWorld.AttachEvent("OnDataSourceFeatureIdChanged",this.SaveIdToAttributes),inspections.newFeatureIdAfterSave=inspections.CurrentFeature.DataSourceFeatureID)):(this.featureCountBeforeSave=inspections.inspectionLayer.Count,inspections.newFeatureIdAfterSave=inspections.CurrentFeature.DataSourceFeatureID,1==inspections.inspectionLayer.GeometryType?inspections.CurrentFeature.Geometry=SGWorld.Creator.GeometryCreator.CreateLineStringGeometry(firstPoint):inspections.CurrentFeature.Geometry=SGWorld.Creator.GeometryCreator.CreatePolygonGeometry(firstPoint)),inspections.DrawMode=2,inspections.saving=!0,this.inspectionLayer.SaveAsync().OnResolve(function(){inspections.saving=!1,inspections.inspectionLayer.Streaming&&(1==inspections.inspectionLayer.GeometryType?inspections.CurrentFeature=inspections.inspectionLayer.FeatureGroups.Polyline.ExecuteGetDataSourceFeatureIdQuery(inspections.newFeatureIdAfterSave):inspections.CurrentFeature=inspections.inspectionLayer.FeatureGroups.Polygon.ExecuteGetDataSourceFeatureIdQuery(inspections.newFeatureIdAfterSave)),inspections.CurrentFeature.Geometry.StartEdit(),inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Index")&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Severity")&&(inspections.CurrentFeature.FeatureAttributes.Item(2).Value=2==inspections.FeatureType?0:1,inspections.CurrentFeature.FeatureAttributes.Item(3).Value=inspections.CreateBy,inspections.CurrentFeature.FeatureAttributes.Item(0).Value=inspections.CurrentFeature.DataSourceFeatureID);inspections.CurrentFeature.Geometry;2==inspections.DrawingStyle&&inspections.FinishDrawFeature(1,0,0),application.RedrawInspectionsOnPhotos(),inspections.featureCreated=!0,callAddPoint&&inspections.AddWaypoint(pos)}).OnReject(function(err){application.debug&&alert("inspections.js -> CreateFeature OnReject: "+err.message)})}catch(err){application.debug&&alert("inspections.js -> CreateFeature: "+err.message)}},SaveIdToAttributes:function(ObjectID,oldFeatureId,newFeatureId){try{SGWorld.DetachEvent("OnDataSourceFeatureIdChanged",this.SaveIdToAttributes),inspections.newFeatureIdAfterSave=newFeatureId}catch(e){application.debug&&alert("inspections.js -> SaveInspectionLayer: "+err.message)}},AddWaypoint:function(pos){try{inspections.featureCreated&&2==inspections.DrawMode&&((6==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0).ExteriorRing:5==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0):1==inspections.inspectionLayer.GeometryType?inspections.CurrentFeature.Geometry:inspections.CurrentFeature.Geometry.ExteriorRing).Points.InsertPoint(this.insertIndex,pos.X,pos.Y,pos.Altitude),this.insertIndex++,application.RedrawInspectionsOnPhotos())}catch(err){}},OnFrame:function(){try{var cursor,CursorCoord;if(2==inspections.DrawMode)if(!inspections.saving)return cursor=SGWorld.Window.GetMouseInfo(),null!=(CursorCoord=SGWorld.Window.PixelToWorld(cursor.X,cursor.Y,8401))&&0!=CursorCoord.InsideScreenRect&&0!=CursorCoord.Position.X&&(!TEF||1!=application.mouseOverTool)&&void inspections.HandleWaypointOnFrame(CursorCoord.Position)}catch(err){application.debug&&alert("inspections.js OnFrame"+err.message)}},HandleWaypointOnFrame:function(position){try{var milliseconds,pointIndex;0==this.DrawMode||inspections.saving||50<(milliseconds=Date.now())-inspections.LastPointTimer&&(null==inspections.LastCursorPos||position.X!=inspections.LastCursorPos.X&&position.Y!=inspections.LastCursorPos.Y)&&(0==inspections.DrawingStyle||3==inspections.DrawingStyle?(pointIndex=this.insertIndex,6==inspections.CurrentFeature.Geometry.GeometryType?(inspections.CurrentFeature.Geometry.Item(0).ExteriorRing.Points.Item(pointIndex).X=position.X,inspections.CurrentFeature.Geometry.Item(0).ExteriorRing.Points.Item(pointIndex).Y=position.Y,inspections.CurrentFeature.Geometry.Item(0).ExteriorRing.Points.Item(pointIndex).Z=position.Altitude):5==inspections.CurrentFeature.Geometry.GeometryType?(inspections.CurrentFeature.Geometry.Item(0).Points.Item(pointIndex).X=position.X,inspections.CurrentFeature.Geometry.Item(0).Points.Item(pointIndex).Y=position.Y,inspections.CurrentFeature.Geometry.Item(0).Points.Item(pointIndex).Z=position.Altitude):1==inspections.inspectionLayer.GeometryType?(inspections.CurrentFeature.Geometry.Points.Item(pointIndex).X=position.X,inspections.CurrentFeature.Geometry.Points.Item(pointIndex).Y=position.Y,inspections.CurrentFeature.Geometry.Points.Item(pointIndex).Z=position.Altitude):(inspections.CurrentFeature.Geometry.ExteriorRing.Points.Item(pointIndex).X=position.X,inspections.CurrentFeature.Geometry.ExteriorRing.Points.Item(pointIndex).Y=position.Y,inspections.CurrentFeature.Geometry.ExteriorRing.Points.Item(pointIndex).Z=position.Altitude)):1==inspections.DrawingStyle&&(inspections.AddWaypoint(position),inspections.LastCursorPos=position.Copy(),inspections.LastPointTimer=milliseconds),application.RedrawInspectionsOnPhotos())}catch(err){application.debug&&alert("inspections HandleWaypointOnFrame "+err.message)}},IsThereEnoughPointsInTheGeometry:function(){var minNumOfPointsForGeo,numOfPoints;return 5==inspections.CurrentFeature.Geometry.GeometryType?(numOfPoints=inspections.CurrentFeature.Geometry.Geometry(0).Points.Count,minNumOfPointsForGeo=4,3==inspections.DrawingStyle&&(minNumOfPointsForGeo+=2)):1==inspections.inspectionLayer.GeometryType?(numOfPoints=inspections.CurrentFeature.Geometry.NumPoints,minNumOfPointsForGeo=4,3==inspections.DrawingStyle&&(minNumOfPointsForGeo+=2)):minNumOfPointsForGeo=(numOfPoints=6==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Geometry(0).ExteriorRing.Points.Count:inspections.CurrentFeature.Geometry.ExteriorRing.NumPoints,6),!(numOfPoints<minNumOfPointsForGeo)},FinishDrawFeature:function(Flags,X,Y){try{var numOfPointsInFeature;(1==Flags||2==inspections.DrawMode&&0!=inspections.DrawingStyle&&3!=inspections.DrawingStyle)&&(6==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0).ExteriorRing.Points.Count:5==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0).Points.Count:numOfPointsInFeature=(1==inspections.inspectionLayer.GeometryType?inspections.CurrentFeature.Geometry:inspections.CurrentFeature.Geometry.ExteriorRing).Points.Count,(0==inspections.DrawingStyle||3==inspections.DrawingStyle)&&2<numOfPointsInFeature&&(6==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0).ExteriorRing:5==inspections.CurrentFeature.Geometry.GeometryType?inspections.CurrentFeature.Geometry.Item(0):1==inspections.inspectionLayer.GeometryType?inspections.CurrentFeature.Geometry:inspections.CurrentFeature.Geometry.ExteriorRing).Points.DeletePoint(this.insertIndex),2==inspections.FeatureType&&(inspections.CurrentFeature.FeatureAttributes.Item(1).Value=inspections.CalculateDistance(inspections.CurrentFeature)),inspections.Reset(!1,!1),inspections.NewFeatureMode)&&inspections.ShowEditInspectionFeature(1)}catch(err){application.debug&&alert("inspections.js -> FinishDrawFeature: "+err.message)}},OnLButtonUp:function(Flags,X,Y){inspections.FinishDrawFeature(0,X,Y)},OnRButtonUp:function(Flags,X,Y){inspections.CurrentFeature&&(1==inspections.DrawMode||3==inspections.DrawMode?inspections.Reset(!1,!1):inspections.IsThereEnoughPointsInTheGeometry()&&(application.RedrawInspectionsOnPhotos(),2!=inspections.DrawMode||0!=inspections.DrawingStyle&&3!=inspections.DrawingStyle||inspections.FinishDrawFeature(1,0,0)))},OnInputModeChanged:function(Flags,X,Y){2!=Flags&&0!=inspections.DrawMode&&inspections.Reset(!1,!0)},OnObjectUnderCursorChanged:function(ObjectEntered,ObjectID){try{var featureObj;3==inspections.DrawMode&&(featureObj=(1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline:inspections.inspectionLayer.FeatureGroups.Polygon).GetFeatureByObjectID(ObjectID),inspections.highlightedFeature=null,featureObj.LayerID==inspections.inspectionLayerID&&(featureObj.Highlight=ObjectEntered))&&(inspections.highlightedFeature=featureObj)}catch(err){}},CalcAnnotationPosition:function(feature){try{var annotationPoint1,annotationPoint1Geometry,annotationPoint1Position,annotationPoint2Geometry=(6==feature.Geometry.GeometryType?(annotationPoint1=feature.Geometry.Geometry(0).ExteriorRing.NumPoints<=2?0:Math.floor(feature.Geometry.Geometry(0).ExteriorRing.NumPoints/2),annotationPoint1Geometry=feature.Geometry.Geometry(0).ExteriorRing.Points.Item(annotationPoint1),annotationPoint1Position=SGWorld.Creator.CreatePosition(annotationPoint1Geometry.X,annotationPoint1Geometry.Y,annotationPoint1Geometry.Z,3),feature.Geometry.Geometry(0).ExteriorRing):5==feature.Geometry.GeometryType?(annotationPoint1=feature.Geometry.Geometry(0).NumPoints<=2?0:Math.floor(feature.Geometry.Geometry(0).NumPoints/2),annotationPoint1Geometry=feature.Geometry.Geometry(0).Points.Item(annotationPoint1),annotationPoint1Position=SGWorld.Creator.CreatePosition(annotationPoint1Geometry.X,annotationPoint1Geometry.Y,annotationPoint1Geometry.Z,3),feature.Geometry.Geometry(0)):1==inspections.inspectionLayer.GeometryType?(annotationPoint1=feature.Geometry.NumPoints<=2?0:Math.floor(feature.Geometry.NumPoints/2),annotationPoint1Geometry=feature.Geometry.Points.Item(annotationPoint1),annotationPoint1Position=SGWorld.Creator.CreatePosition(annotationPoint1Geometry.X,annotationPoint1Geometry.Y,annotationPoint1Geometry.Z,3),feature.Geometry):(annotationPoint1=feature.Geometry.ExteriorRing.NumPoints<=2?0:Math.floor(feature.Geometry.ExteriorRing.NumPoints/2),annotationPoint1Geometry=feature.Geometry.ExteriorRing.Points.Item(annotationPoint1),annotationPoint1Position=SGWorld.Creator.CreatePosition(annotationPoint1Geometry.X,annotationPoint1Geometry.Y,annotationPoint1Geometry.Z,3),feature.Geometry.ExteriorRing)).Points.Item(annotationPoint1+1),annotationPoint2Position=SGWorld.Creator.CreatePosition(annotationPoint2Geometry.X,annotationPoint2Geometry.Y,annotationPoint2Geometry.Z,3);return annotationPoint1Position.Lerp(annotationPoint2Position,50)}catch(err){application.debug&&alert("inspections.js -> CalcAnnotationPosition "+err.message)}},CalcFeatureCenterPosition:function(feature){return SGWorld.Creator.CreatePosition((feature.Geometry.Envelope.Rings.Item(0).Points.Item(0).X+feature.Geometry.Envelope.Rings.Item(0).Points.Item(2).X)/2,(feature.Geometry.Envelope.Rings.Item(0).Points.Item(0).Y+feature.Geometry.Envelope.Rings.Item(0).Points.Item(2).Y)/2,feature.GetProperty("Altitude"),3,0,0,0)},CalcImageRatio:function(photo,feature,imageDimentions){var xMin=9999,yMin=9999,xMax=0,yMax=0;for(i=0;i<4;i++)var pos=SGWorld.Creator.CreatePosition(feature.Geometry.Envelope.Rings.Item(0).Points.Item(i).X,feature.Geometry.Envelope.Rings.Item(0).Points.Item(i).Y,feature.GetProperty("Altitude"),3,0,0,0),pos=services.PointToPixel(photo,pos),xMin=Math.min(xMin,pos[0]),xMax=Math.max(xMax,pos[0]),yMin=Math.min(yMin,pos[1]),yMax=Math.max(yMax,pos[1]);var heightPix=yMax-yMin;return Math.min(4,Math.max(Math.ceil((xMax-xMin)/imageDimentions[0]),Math.ceil(heightPix/imageDimentions[1])))},CalculateDistance:function(feature){var distance=0;try{for(i=0;i<feature.Geometry.NumPoints-1;i++){var pos1=SGWorld.Creator.CreatePosition(feature.Geometry.Points.Item(i).X,feature.Geometry.Points.Item(i).Y,feature.Geometry.Points.Item(i).Z,3),pos2=SGWorld.Creator.CreatePosition(feature.Geometry.Points.Item(i+1).X,feature.Geometry.Points.Item(i+1).Y,feature.Geometry.Points.Item(i+1).Z,3);distance+=pos1.DistanceTo(pos2)}}catch(err){application.debug&&alert(err.message)}var inches;return 0==settings.params.measurementUnit?(Math.round(100*distance)/100).toFixed(3)+" "+SGLang.i18n("TextMeters"):(inches=(39.3700787*distance).toFixed(2),Math.floor(inches/12)+"` "+(inches%=12).toFixed(2)+"``")},ShowList:function(show){$("#toolInspectionShowList").prop("disabled")||this.toolboxButtonsEnabled&&(show?(this.BuildList(),$("#inspectionListDiv").show(),application.zIndex++,$("#inspectionListDiv").css("z-index",application.zIndex)):$("#inspectionListDiv").hide())},BuildList:function(){try{var nullGeo=SGWorld.Creator.GeometryCreator.CreatePolygonGeometry(null);inspections.inspectionLayer.ExecuteQueryAsync("",1e3,"",nullGeo).OnResolve(function(features){if(0==features.Count)$("#ListNoFeaturesTR").show(),$("#InspectionListTableID").hide();else{if($("#ListNoFeaturesTR").hide(),$("#InspectionListTableID").show(),null!=inspections.InspectionListTable)try{inspections.InspectionListTable.rows().remove(),inspections.InspectionListTable.destroy()}catch(e){}var htmlTxt="";htmlTxt+="<th></th>",0==(attributeCount=features.Item(0).FeatureAttributes.Count)&&(htmlTxt+="<th><span class='fontBlack bold'></span></th>");for(var j=0;j<attributeCount;j++)htmlTxt+="<th><span class='fontBlack bold'>"+features.Item(0).FeatureAttributes.Item(j).Name+"</span></th>";$("#InspectionListTH").html(htmlTxt),inspections.InspectionListTable=$("#InspectionListTableID").DataTable({paging:!1,info:!1,order:[[1,"desc"]]});for(var i=0;i<features.Count;i++){var currentFeature=features.Item(i);if(3!=currentFeature.State){var attributeCount,htmlTxt="",rowData=[];rowData.push("<div style='width:5.5rem'><img onclick='inspections.FlyToFeature(\""+currentFeature.ID+"\")' class='link img16' title='"+SGLang.i18n("TextView")+"' src='images/FeatureView.png'> | <img onclick='inspections.EditFeature(\""+currentFeature.ID+"\",null,true)' class='link img16' title='"+SGLang.i18n("TextEdit")+"' src='images/FeatureEdit.png'>| <img onclick='inspections.ShowPhotosFeature(\""+currentFeature.ID+"\",true)' class='link img16' title='"+SGLang.i18n("TextInspectionShowPhotos")+"' src='images/FeaturePhotos.png'></div>"),0==(attributeCount=currentFeature.FeatureAttributes.Count)&&rowData.push("<span class='photoLine' ></span>");for(j=0;j<attributeCount;j++){var attributeValue=2==j&&1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?SGLang.i18n("TextSeverity"+currentFeature.FeatureAttributes.Item(j).Value):currentFeature.FeatureAttributes.Item(j).Value,attributeValue=currentFeature.FeatureAttributes.Item(j).Value.length<=8?attributeValue:attributeValue.substring(0,7)+"...";rowData.push("<span class='photoLine' >"+attributeValue+"</span>")}inspections.InspectionListTable.row.add(rowData).draw(!1)}}}}).OnReject(function(err){application.debug&&alert("inspection.js -> BuildList OnRejecdt: "+err.message)})}catch(err){application.debug&&alert("inspection.js -> BuildList: "+err.message)}},BuildReportPreparation:function(){try{var firstFeatureHeight,topLeftCornerPosition,bottomRightCornerPosition,bboxDistance,centerPosition,features=(1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline:inspections.inspectionLayer.FeatureGroups.Polygon).GetCurrentFeatures();0!=features.Count&&(firstFeatureHeight=(6==features.Item(0).Geometry.GeometryType?features.Item(0).Geometry.Geometry(0).ExteriorRing:5==features.Item(0).Geometry.GeometryType?features.Item(0).Geometry(0):1==inspections.inspectionLayer.GeometryType?features.Item(0).Geometry:features.Item(0).Geometry.ExteriorRing).Points.Item(0).Z,topLeftCornerPosition=SGWorld.Creator.CreatePosition(this.inspectionLayer.BBox.MinX,this.inspectionLayer.BBox.MinY,firstFeatureHeight,3,0,-70,0),bottomRightCornerPosition=SGWorld.Creator.CreatePosition(this.inspectionLayer.BBox.MaxX,this.inspectionLayer.BBox.MaxY,firstFeatureHeight,3,0,-70,0),bboxDistance=topLeftCornerPosition.DistanceTo(bottomRightCornerPosition),(centerPosition=topLeftCornerPosition.MoveToward(bottomRightCornerPosition,bboxDistance/2)).Pitch=-70,centerPosition.Distance=Math.max(50,3*bboxDistance),SGWorld.Navigate.JumpTo(centerPosition),SGWorld.ProjectTree.SetVisibility(application.photosLayerID,!1),SGWorld.AttachEvent("OnFrame",inspections.BuildReport))}catch(err){application.debug&&alert(err.message)}},BuildReport:function(){SGWorld.DetachEvent("OnFrame",inspections.BuildReport);for(var features,imageDimentions=[850,500],snapshotDimentions=[800,600],photos=[],report="<html> <head>        <meta name='viewport' content='initial-scale=1.0'>        <meta charset='UTF-8'>         <link rel='StyleSheet' href='"+abspath()+"/report.css' type='text/css' charset='UTF-8'>         <script src='"+abspath()+"/../jquery/jquery-3.6.0.min.js' type='text/javascript' charset='UTF-8'><\/script>         <script src='"+abspath()+"/../jquery/openseadragon-bin-2.4.2/openseadragon.js' charset='UTF-8'><\/script>         <script src='"+abspath()+"/../jquery/openseadragon-bin-2.4.2/openseadragon-canvas-overlay.js' charset='UTF-8'><\/script>         <script src='"+abspath()+"/report.js' charset='UTF-8'><\/script>         </head>         <body class='body' onload='initReport()'>         <button class='no-print MenuButtonWhiteMedium' onclick='window.print()'>"+SGLang.i18n("TextPrintSaveReport")+"</button>         <span class='no-print s8' >"+SGLang.i18n("TextPrintSaveReportHelp")+"</span> </br>",counter=(report+="<div class='frame'>        <p class='fontBlack s24'>"+SGLang.i18n("TextSettingsProjectName")+": "+settings.params.projectName+"</p>         <table class='styled-table'>        <tr><td>"+SGLang.i18n("TextSettingsProjectDescription")+"</td><td class='lineBreakable'>"+settings.params.projectDescription+"</td></tr>         <tr><td>"+SGLang.i18n("TextSettingsCreatedFor")+"</td><td> "+settings.params.createdFor+"</td></tr>         <tr><td>"+SGLang.i18n("TextSettingsAuthor")+"</td><td> "+settings.params.author+"</td></tr>         <tr><td>"+SGLang.i18n("TextInspectionReportDate")+"</td><td> "+services.GetDateString()+"</td></tr>         </table>",1==inspections.inspectionLayer.GeometryType?(features=inspections.inspectionLayer.FeatureGroups.Polyline.GetCurrentFeatures(),inspections.inspectionLayer.FeatureGroups.Polyline):(features=inspections.inspectionLayer.FeatureGroups.Polygon.GetCurrentFeatures(),inspections.inspectionLayer.FeatureGroups.Polygon),0),sortedFeatures=[],i=0;i<features.Count;i++)sortedFeatures.push(features.Item(i));if(sortedFeatures.sort(function(a,b){return a.DataSourceFeatureID-b.DataSourceFeatureID}),inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Severity")&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Index")){report+="<p class='fontBlack s24'>"+SGLang.i18n("TextInspectionReportIndex")+"</p>      <table class='styled-table'>";for(i=0;i<features.Count;i++)3!=(currentFeature=sortedFeatures[i]).State&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&0!=currentFeature.FeatureAttributes.Item(2).Value&&(counter%4==0&&(report+="<tr>"),report+="<td ><a  class='link' href='#inspection"+i+"'><img class='imgMiddle' src='"+abspath()+"/images/Severity"+currentFeature.FeatureAttributes.Item(2).Value+".png'>  "+currentFeature.FeatureAttributes.Item(0).Value+" : "+currentFeature.FeatureAttributes.Item(1).Value+"</a></td>",counter%4==3&&(report+="</tr>"),counter++);report+="</tr>"}report=(report+="</table>")+"<img src='"+SGWorld.Window.GetSnapShot(!0,snapshotDimentions[0],snapshotDimentions[1],"JPeg75",0)+"'  style='width: "+(snapshotDimentions[0]-100)+"px; height: "+(snapshotDimentions[1]-100)+"px; object-fit: none;'/></div>";for(var index=0,i=0;i<features.Count;i++){var currentFeature=sortedFeatures[i];if(1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&3!=currentFeature.State&&0!=currentFeature.FeatureAttributes.Item(2).Value||1!=inspections.inspectionLayer.GeometryType||!inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")){report+="<div class='frame' id='inspection"+i+"'>        <table class='styled-table'>";for(var j=0;j<currentFeature.FeatureAttributes.Count;j++){var attributeValue=2==j&&1==inspections.inspectionLayer.GeometryType&&inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")?SGLang.i18n("TextSeverity"+currentFeature.FeatureAttributes.Item(j).Value):currentFeature.FeatureAttributes.Item(j).Value;report+="<tr><td>"+currentFeature.FeatureAttributes.Item(j).Name+"  </td>                     <td>"+attributeValue+"</td></tr>"}for(var FeatureCenterPosition=inspections.CalcFeatureCenterPosition(currentFeature),photosList=application.showPhotosInPoint(FeatureCenterPosition,!0),centerPixel=[],AnnotationCenterPosition=[],AnnotationPixel=[],photoURL=[],inspectionLines=[],photoWidth=[],photoHeight=[],j=0;j<photosList.length;j++){centerPixel[j]=services.PointToPixel(photosList[j],FeatureCenterPosition),AnnotationCenterPosition[j]=inspections.CalcAnnotationPosition(currentFeature),AnnotationPixel[j]=services.PointToPixel(photosList[j],AnnotationCenterPosition[j]),photoURL[j]=photosList[j].photo.replace(/\\/g,"/"),photoWidth[j]=photosList[j].width,photoHeight[j]=photosList[j].height;var inspectionLine=[],inspectionInnerPolyline=[],inspectionInnerPolygon=[],isMultipolygon=!1,isMultipolyline=!1;if(5==currentFeature.Geometry.GeometryType)for(var isMultipolyline=!0,z=0;z<currentFeature.Geometry.NumGeometries;z++){var polylineGeometry=currentFeature.Geometry.Geometry(z),numOfPoints=polylineGeometry.Points.Count;for(k=0;k<numOfPoints;k++){var waypointPos=SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(k).X,polylineGeometry.Points.Item(k).Y,polylineGeometry.Points.Item(k).Z,3);waypointPixel=services.PointToPixel(photosList[j],waypointPos),inspectionInnerPolyline.push(waypointPixel)}inspectionLine.push(inspectionInnerPolyline),inspectionInnerPolyline=[]}else if(6==currentFeature.Geometry.GeometryType)for(isMultipolygon=!0,z=0;z<currentFeature.Geometry.NumGeometries;z++){var firstPointInPolygon,polygonGeometry=currentFeature.Geometry.Geometry(z),numOfPoints=polygonGeometry.ExteriorRing.Points.Count;for(k=0;k<numOfPoints;k++){var waypointPos=SGWorld.Creator.CreatePosition(polygonGeometry.ExteriorRing.Points.Item(k).X,polygonGeometry.ExteriorRing.Points.Item(k).Y,polygonGeometry.ExteriorRing.Points.Item(k).Z,3);waypointPixel=services.PointToPixel(photosList[j],waypointPos),0==k&&(firstPointInPolygon=waypointPixel),inspectionInnerPolygon.push(waypointPixel)}firstPointInPolygon&&inspectionInnerPolygon.push(firstPointInPolygon),inspectionLine.push(inspectionInnerPolygon),inspectionInnerPolygon=[]}else for(numOfPoints=1==inspections.inspectionLayer.GeometryType?currentFeature.Geometry.NumPoints:currentFeature.Geometry.ExteriorRing.Points.Count,k=0;k<numOfPoints;k++)waypointPos=1==inspections.inspectionLayer.GeometryType?SGWorld.Creator.CreatePosition(currentFeature.Geometry.Points.Item(k).X,currentFeature.Geometry.Points.Item(k).Y,currentFeature.Geometry.Points.Item(k).Z,3):SGWorld.Creator.CreatePosition(currentFeature.Geometry.ExteriorRing.Points.Item(k).X,currentFeature.Geometry.ExteriorRing.Points.Item(k).Y,currentFeature.Geometry.ExteriorRing.Points.Item(k).Z,3),waypointPixel=services.PointToPixel(photosList[j],waypointPos),inspectionLine.push(waypointPixel);inspectionLines.push(inspectionLine)}inspections.inspectionLayer.Annotation&&(report+="<tr><td>"+SGLang.i18n("TextInspectionCoordinate")+" </td><td>  "+FeatureCenterPosition.X.toFixed(8)+" , "+FeatureCenterPosition.Y.toFixed(8)+'</td></tr> "'),report+="<tr><td>"+SGLang.i18n("TextInspectionBestPhoto")+"           <button class='no-print MenuButtonWhiteMedium' onclick='PrevNextPhoto("+index+",-1)'><img src='"+abspath()+"/images/PrevPhoto.png'></button>           <button class='no-print MenuButtonWhiteMedium' onclick='PrevNextPhoto("+index+",1)'><img src='"+abspath()+"/images/NextPhoto.png'></button>           </td><td><span id='photoURL"+i+"'>"+photoURL[0]+"</span></td></tr>           </table>";for(var isExternalLayer=!!inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity"),lineColorGBRDecString=(1==inspections.inspectionLayer.GeometryType?inspections.inspectionLayer.FeatureGroups.Polyline:inspections.inspectionLayer.FeatureGroups.Polygon).GetProperty("Line Color"),lineColorGBRHexString=parseInt(lineColorGBRDecString,10).toString(16);lineColorGBRHexString.length<6;)lineColorGBRHexString="0"+lineColorGBRHexString;var lineColorGBRDecString=lineColorGBRHexString.substring(0,2),lineColorGBRDecString="#"+(lineColorGBRHexString.slice(-2)+lineColorGBRHexString.slice(2,lineColorGBRHexString.length-2)+lineColorGBRDecString),severity="",ind=(inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("severity")&&(severity=currentFeature.FeatureAttributes.Item(2).Value),""),title=(inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("index")&&(ind=currentFeature.FeatureAttributes.Item(0).Value),"");inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("title")&&(title=currentFeature.FeatureAttributes.Item(1).Value),photos.push({photo:photoURL,Index:ind,Description:title,Severity:severity,IsExternalLayer:isExternalLayer,LineColor:lineColorGBRDecString,Width:photoWidth,Height:photoHeight,viewer:null,CanvasOverlay:null,centerPixel:centerPixel,annotation:AnnotationPixel,overlays:inspectionLines,maxPhotos:photosList.length,photoIndex:0,isMultipolygon:isMultipolygon,isMultipolyline:isMultipolyline}),report+="<div  id='PhotoViewerDiv-"+index+"' style='width:"+imageDimentions[0]+"px; height:"+imageDimentions[1]+"px; border: 1px solid black;' style='display:inline;'></div>                  </div>",index++}}report+="<script >                 var isNativeInspectionLayer = "+inspections.inspectionLayer.DataSourceInfo.Attributes.IsAttributeExist("Severity")+";                 var photos = "+JSON.stringify(photos)+";                 var abspath = '"+abspath()+"';                 <\/script></body></html>";snapshotDimentions=SGWorld.SetParamEx(9929,"report.html",report),snapshotDimentions=SGWorld.Creator.CreatePopupMessage("Report",snapshotDimentions,0,0,950,900,-1);snapshotDimentions.AllowDrag=!0,snapshotDimentions.AllowResize=!0,SGWorld.Window.ShowPopup(snapshotDimentions),SGWorld.ProjectTree.SetVisibility(application.photosLayerID,!0)},populateInspectionLayerList:function(listElement){try{var layerList=[],nativeLayers=[],projectLayers=[],firstValue=(BuildObjectsList(SGWorld.ProjectTree.RootID,layerList,36),listElement.html(""),"<option selected='selected' > "+SGLang.i18n("TextSelect")+"</option>"),i=(listElement.append(firstValue),layerList.forEach(function(val){var layer=SGWorld.Creator.GetObject(val);1!=layer.GeometryType&&2!=layer.GeometryType||"AT Tiles"!=SGWorld.ProjectTree.GetItemName(val)&&(layer.DataSourceInfo.Attributes.IsAttributeExist("severity")?nativeLayers:projectLayers).push(val)}),0<nativeLayers.length&&listElement.append("<option disabled> "+SGLang.i18n("InspectionListGroup1")+"</option>"),0);nativeLayers.forEach(function(val){var parent=SGWorld.ProjectTree.GetNextItem(val,15),parent="&nbsp;&nbsp;"+(parentName=parent==SGWorld.ProjectTree.RootID?"":SGWorld.ProjectTree.GetItemName(parent))+"/"+SGWorld.ProjectTree.GetItemName(val),selected=0==i?" selected='selected' ":"";listElement.append("<option value="+val+selected+">"+parent+"</option>"),i++}),0<projectLayers.length&&listElement.append("<option disabled> "+SGLang.i18n("InspectionListGroup2")+"</option>"),projectLayers.forEach(function(val){var parent=SGWorld.ProjectTree.GetNextItem(val,15),parent="&nbsp;&nbsp;"+(parentName=parent==SGWorld.ProjectTree.RootID?"":SGWorld.ProjectTree.GetItemName(parent))+"/"+SGWorld.ProjectTree.GetItemName(val);listElement.append("<option value="+val+">"+parent+"</option>")}),null!=this.inspectionLayerID&&listElement.val(this.inspectionLayerID)}catch(err){application.debug&&alert("inspections.js -> populateInspectionLayerList: "+err.message)}},ShowCreateInspectionLayer:function(show){show?(this.ShowCreateAttributes(),$("#createInspectionLayerDiv").show(),application.zIndex++,$("#createInspectionLayerDiv").css("z-index",application.zIndex)):$("#createInspectionLayerDiv").hide()},ShowCreateAttributes:function(){$("#creatInspectionAttributesTable").html(""),this.attributeTemplate.forEach(function(val,index){var disabled="";val.manadatory&&(disabled="disabled='disabled'"),$("#creatInspectionAttributesTable").append("<tr>  <td class='s9'>   <input id='NewInspectionAttrName"+index+"' type='text' value='"+val.name+"' size='17' "+disabled+"  />         </td>          <td align='left'>              <select id='NewInspectionAttrType"+index+"'   "+disabled+" class='selectNew'>                  <option value=0 "+(0==val.type?"Selected":"")+" >"+SGLang.i18n("TextAttText")+"</option>                 <option value=1 "+(1==val.type?"Selected":"")+" >"+SGLang.i18n("TextAttInt")+"</option>                 <option value=2 "+(2==val.type?"Selected":"")+" >"+SGLang.i18n("TextAttDouble")+"</option>             </select>         </td> </tr>   ")})},CreateInspectionLayer:function(){var group,layer,layerName=$("#NewInspectionNameID").val();null===layerName||null!==layerName.match(/^ *$/)?alert(SGLang.i18n("TextInspectionNoName")):(group=SGWorld.ProjectTree.GetNextItem(application.photosLayerID,15),(layer=SGWorld.Creator.CreateNewFeatureLayer(layerName,LayerGeometryType.LGT_POLYLINE,"FileName=Inspection"+layerName+(new Date).getTime()+".gpkg;LayerName=inspection;TEPlugName=OGR;",group)).Streaming=!1,layer.Annotation=!0,layer.RefreshAsync().OnResolve(function(){inspections.attributeTemplate.forEach(function(val,index){""!=$("#NewInspectionAttrName"+index).val()&&" "!=$("#NewInspectionAttrName"+index).val()&&layer.DataSourceInfo.Attributes.CreateAttribute($("#NewInspectionAttrName"+index).val(),$("#NewInspectionAttrType"+index).val(),256,4)}),inspections.featureCountBeforeSave=0,layer.SaveAsync().OnResolve(function(){inspections.Init(layer.ID),inspections.StyleInspectionLayer(!0),settings.ShowCreateInspectionLayer(!1)}).OnReject(function(){application.debug&&alert(err.message)})}))},dummy:null};