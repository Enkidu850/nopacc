<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="initial-scale=1.0">
    <title>ToolTitle</title>
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <!--<meta http-equiv="Content-Type" content="text/html; charset=utf-8">-->
    <link rel="StyleSheet" href="../Style80.css" type="text/css">
    <script language="javascript" src="../jquery/jquery-3.1.1.min.js"></script>
    <script language="javascript" src="../ToolsCommon80.js"></script>
    </head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border: 0px" id="Body"  class="hideUntillTranslated" onunload="Reset(0, 0)">
    <!--oncontextmenu="return false;">  onclick="bHide=true;HideOptionsNow()" > -->
    <table border="0" width="100%" cellspacing="0" cellpadding="2" id="TopAreaTbl" style="display:none">
        <tr>
            <td class="ToolTopArea" id="TopAreaTD" width="100%" valign="middle" >
                <table border="0" width="100%" cellspacing="0" cellpadding="0">
                    <tr>
                        <td width="55px"><img style="margin-left:5px;" src="ToolIcon.png" alt="" /></td>
                        <td id="TitleTD" align="center" class="s12w i18n">ToolName</td>
                        <td align="right" id="CloseHelpTd"><img style="margin-right:5px;" alt="" src="../CommonImg/help.png" border="0" class="i18n" alt="help" title="help" onclick="DisplayHelpPopup6(SGLang.i18nFile('help.html'),SGLang.i18n('help'))" style="cursor: pointer;"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td  class="ToolTopSeperator"></td>
        </tr>   
                <td >
                </table>
    <table class="PropertiesSheet s8" cellspacing="0" cellpadding="2" >
        <tr class='TableOtherLine' id="compareTR" style="display:none;">
            <td class="" width="20%">
                <label for="Mode"  class="i18n">Text0</label>
            </td>
            <td align="left">
                &nbsp;<select id="CompareMode" onchange="ChangeMode();">
                    <option class="i18n" value="0" selected="selected">Text1</option>
                    <option class="i18n" value="1" >Text2</option>
                </select>
            </td>     
        </tr>
        <tr >
            <td class="">
                <label for="Mode"  class="i18n">Text10</label>
            </td>
            <td align="left">
                &nbsp;<select id="DensityID" >
                    <option class="i18n" value="1" selected="selected">Text11</option>
                    <option class="i18n" value="2" >Text12</option>
                </select>
            </td>     
        </tr>

        <tr id="ListTR"  class="CompareLayersDiv TableOtherLine" style="display:none; text-align: center;">
            <td class="" colspan="2" >
                <button style="padding: 2px 5px;" id="filterID0" class="MenuButtonSmallRoundOutline MenuButtonSmallRoundOutlineChecked i18n MaxWidth" onclick="setFiler(0);" >   <span class="i18n">Text68</span></button>
                <button style="padding: 2px 5px;" id="filterID1" class="MenuButtonSmallRoundOutline MenuButtonSmallRoundOutlineChecked i18n MaxWidth" onclick="setFiler(1);" >   <span class="i18n">Text69</span></button>
                <button style="padding: 2px 5px;" id="filterID2" class="MenuButtonSmallRoundOutline MenuButtonSmallRoundOutlineChecked i18n MaxWidth" onclick="setFiler(2);" >   <span class="i18n">Text70</span></button>
                <button style="padding: 2px 5px;" id="filterID3" class="MenuButtonSmallRoundOutline MenuButtonSmallRoundOutlineChecked i18n MaxWidth" onclick="setFiler(3);" >   <span class="i18n">Text71</span></button>
            </td>
        </tr>

        <tr class="CompareLayersDiv" style="display:none;">
            <td class="" valign="top">
             <label for="Layer1ID"  class="i18n" style="line-height: 22px; white-space: nowrap;">Text65</label> </br>
             <label for="Layer2ID"  class="i18n" style="line-height: 32px; white-space: nowrap;">Text66</label></br>
            </td>
            <td>

            &nbsp;<select id="Layer1ID" onchange="LayerOnSelect()"  style="width:100%;margin-bottom: 5px;" >     </select> </br>
            &nbsp;<select id="Layer2ID" onchange="LayerOnSelect()"  style="width:100%;margin-bottom: 5px;" >     </select> </br>
            &nbsp;&nbsp;<span id="refresh" onclick="RefreshList();" style="text-decoration:underline;cursor:pointer;" class="i18n">Refresh & Detect</span> 
            </td>
        </tr>

        
        <!-- <tr id="ListTR" class='TableOtherLine' style="display:none;"> <!--Select Elevation Layer -->
            <!-- <td class="">
                <label for="createAs"  class="i18n">Text5</label>
            </td>
            <td align="left"> -->
<!--          DO NOT REMOVE THE FOCUS CALL IN THE LIST BELOW!!
              This focus call  minimize the effect of a very strange bug. When you select an entry from the Viewshed list, click on the terrain and then ctrl-click on other list entry the HTML list control do not really recieve this additional selection (although you do see the new line highlighted).
-->
                <!-- &nbsp;<select id="ElevationsID" multiple="multiple" ondblclick="flyToElevation();" onmouseover="this.focus()"  >
                </select><br /> -->
                <!-- <span  class="i18n" style="text-decoration:underline;cursor:pointer;" onclick="RefreshElevationList();">Text37</span> -->
<!--                <span style="margin-left:40px;"></span>
                <span  class="i18n" style="text-decoration:underline;cursor:pointer;" onclick="SelectInView();">Text42</span>-->            
            <!-- </td>       -->
        </tr>
        <!-- </table> -->
        <tr class="s8">
            <td colspan="2"  align="center" class="ToolButtonsArea">
                <button id="lineButton" class="MenuButton" onclick="CreateObjects(1);"><img src="../commonimg/polyline.png" /><br />         <span class="i18n">Text33</span></button>
                <button id="groupButton" class="MenuButton" style="display:none" onclick="SelectGroupObjects()"><img src="../commonimg/group.png" /><br /><span class="i18n">Text35</span></button>
                <button id="clipboardButton" class="MenuButton MenuButtonLast" style="display:none" onclick="SelectClipboardObjects()"><img src="../commonimg/Clipboard.png" /><br /><span class="i18n" style="font:#2A4EA5">Text36</span></button>
            </td>
        </tr>
    </table>



<script language="JavaScript">
//** this is a global variables for the polyline/polygon drawings
var gPolygonText = SGLang.i18n("Text35");
var gPolylineText = SGLang.i18n("Text36");
var gDrawPolyClick = null;
var gEndDrawPoly = DrawPoly;
var gPopupCaption = "";
var gBaseTerrain = -999;
var gLayer1ID;
var gLayer2ID;
//**

var bInEdit;
var bFirstTime;
var bDontAskme;
///var gTotalHours;
var rootId;
var gDebug = false;
var gFilters = [true,true,true,true];
var gObjectTypes = [38,28,29,36]; //3D Mesh layer, point cloud, elevation layer, feature layer

var SGWorld = null;


Date.prototype.stdTimezoneOffset = function () {
    var jan = new Date(this.getFullYear(), 0, 1);
    var jul = new Date(this.getFullYear(), 6, 1);
    return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
}

Date.prototype.dst = function () {
    return this.getTimezoneOffset() < this.stdTimezoneOffset();
}

//--------------
// Init
function Init() {
    SGWorld = initSGWorld();
	
	if (!TEF){
        $("#compareTR").show();
        $("#groupButton").show();
        $("#clipboardButton").show();
        $("#TopAreaTbl").show();
    }
    $("#note").hide();
    if (GetParamValue("inSG", "") == "1") {
        $("#TopAreaTD").attr("height", "57");
        $("#TitleTD").attr("align", "left");
        $("#CloseHelpTd").attr("display", "none");
    }
    window.ondragstart = function() { return false; } 

    gDrawPolyAltitudeType = 3; // draw lines and polygon as absolute lines
    rootId = GetParamValue("rootId", SGWorld.ProjectTree.RootID);
    //RefreshElevationList();
    $("#CompareMode").val(0);
    RefreshList();
    Reset(1, 0);
}
//------------------
function setFiler (filterID) {
    gFilters[filterID] = !gFilters[filterID];
    if (gFilters[filterID])
        $("#filterID"+filterID).addClass ('MenuButtonSmallRoundOutlineChecked')
    else
        $("#filterID"+filterID).removeClass ('MenuButtonSmallRoundOutlineChecked')
    RefreshList();
}
// Reset
//------------------
function Reset(FirstTime, FromMouseInputMode) {

    try {
        if (gPolyObj != null)
            SGWorld.Creator.DeleteObject(gPolyObj.ID);
    } catch (e) { }

    gPolyObj = null;
    GroupID = null;

    bDontAskme = false;

    $("#lineButton").removeClass("MenuButtonHighlight");
    $("#areaButton").removeClass("MenuButtonHighlight");
    $("#groupButton").removeClass("MenuButtonHighlight");
    $("#clipboardButton").removeClass("MenuButtonHighlight");

    SGWorld.ProjectTree.EnableRedraw(1);
    SGWorld.Window.HideMessageBarText();

    if (bInEdit) {
    }
    bInEdit = false;

    if (FirstTime != 1 && FromMouseInputMode == 0)
        SGWorld.Window.SetInputMode(0);
}
//-------------------
function LayerOnSelect() {
    var CompareMode = $("#CompareMode").val();
    if (CompareMode != "1") 
        return;

    gLayer1ID = $('#Layer1ID').val();
    gLayer2ID = $('#Layer2ID').val();
    if(gLayer1ID == -1 || gLayer2ID == -1){ 
        $('#lineButton').prop('disabled', true);
         $('#groupButton').prop('disabled', true);
         $('#clipboardButton').prop('disabled', true);
    }
    else{
        $('#lineButton').prop('disabled', false);
        $('#groupButton').prop('disabled', false);
        $('#clipboardButton').prop('disabled', false);
    }

}
//-------------------
// ChangeMode
function ChangeMode() {
    var CompareMode = $("#CompareMode").val();
    if (CompareMode == "1"){ 
        $(".CompareLayersDiv").show();
        $("#groupButton").hide();
        $("#note").show();

        LayerOnSelect();
    }
    else{
        $(".CompareLayersDiv").hide();
        $("#groupButton").show();
        $("#note").hide();
        
        $('#lineButton').prop('disabled', false);
        $('#groupButton').prop('disabled', false);
        $('#clipboardButton').prop('disabled', false);
    }

}
//-------------------
// RefreshList
function RefreshList() {
    try {
        var viewedIndex = 0;
        var layer1 = gLayer1ID;
        var layer2 = gLayer2ID;
        $("#Layer1ID").html("");
        $("#Layer2ID").html("");
        var allLayers=[];
        //OT_POINT_CLOUD, OT_ELEVATION_LAYER, OT_FEATURE_LAYER, OT_3D_MESH_LAYER
        //BuildMultipleObjectsTypesList(SGWorld.ProjectTree.RootID, allLayers, [28,29,36,38]);
        for (var i = 0; i < gFilters.length ; i++){
            if (gFilters[i]) BuildObjectsList(SGWorld.ProjectTree.RootID, allLayers, gObjectTypes[i]); 
        }

        if(layer1 && allLayers.indexOf(layer1) == -1)
            layer1 = null;
        if(layer2 && allLayers.indexOf(layer2) == -1)
            layer2 = null;
        $("#Layer1ID").append("<option value=" + gBaseTerrain + ">" + SGLang.i18n("Text64") + "</option>");
        $("#Layer2ID").append("<option value=" + gBaseTerrain + ">" + SGLang.i18n("Text64") + "</option>");
        allLayers.forEach (function (val){
            if(IsGroundObjectLayer(val)){
                // Tries to identify layers in the current camera view 
                var layer1Selected="";
                var layer2Selected="";
    
                var Coord0 = SGWorld.Window.PixelToWorld(10, 10, -1 & ~(128|1024));
                var Coord1 = SGWorld.Window.PixelToWorld(SGWorld.Window.Rect.Width-10, 10, -1 & ~(128|1024));
                var Coord2 = SGWorld.Window.PixelToWorld(SGWorld.Window.Rect.Width-10, SGWorld.Window.Rect.Height-10, -1 & ~(128|1024));
                var Coord3 = SGWorld.Window.PixelToWorld(10, SGWorld.Window.Rect.Height-10, -1 & ~(128|1024));
                var ring = SGWorld.Creator.GeometryCreator.CreateLinearRingGeometry([Coord0.Position.X, Coord0.Position.Y, Coord0.Position.Altitude, Coord1.Position.X ,Coord1.Position.Y, Coord1.Position.Altitude, Coord2.Position.X, Coord2.Position.Y, Coord2.Position.Altitude,Coord3.Position.X, Coord3.Position.Y, Coord3.Position.Altitude]);
                var geometry = SGWorld.Creator.GeometryCreator.CreatePolygonGeometry (ring,ring);
                if (checkIntersaction (val,geometry))
                {
                    if (layer1 && layer1 != -999){
                        if(layer1 == val)
                            layer1Selected = " selected='selected' ";
                    }
                    else if (viewedIndex==0)
                        layer1Selected = " selected='selected' ";

                    if (layer2 && layer2 != -999){
                        if(layer2 == val)
                            layer2Selected = " selected='selected' ";
                    }
                    else if (viewedIndex==1)
                        layer2Selected = " selected='selected' ";

                    viewedIndex++;
                }
                var name = SGWorld.ProjectTree.GetItemName (val);
                $("#Layer1ID").append("<option value=" + val +layer1Selected+ ">" + name + "</option>");
                $("#Layer2ID").append("<option value=" + val +layer2Selected+ ">" + name + "</option>");
            }

        });
        //$("#Layer2ID").append("<option value=" + gBaseTerrain + ">" + SGLang.i18n("Text64") + "</option>");

        LayerOnSelect();
    }
    catch (err) { if (gDebug) alert("TerrainProfile.html -> RefreshList: " + err.message); } 
}
//-------------------
function IsGroundObjectLayer(layerId) {
    var layerObj = SGWorld.Creator.GetObject(layerId);
    //OT_FEATURE_LAYER
    if(layerObj.ObjectType == 36){
        if(layerObj.FeatureGroups.Polyline){
            var groundObjPolyline = layerObj.FeatureGroups.Polyline.GetProperty("Ground Object");
        }
        if(layerObj.FeatureGroups.Polygon){
            var groundObjPolygon = layerObj.FeatureGroups.Polygon.GetProperty("Ground Object");
        }

        if(groundObjPolyline == 1 || groundObjPolygon == 1)
            return true;
        return false;
    }

    //OT_POINT_CLOUD
    if(layerObj.ObjectType == 28){
        var groundObjPointCloud = layerObj.Terrain.GroundObject;

        if(groundObjPointCloud == 1)
            return true;
        return false;
    }

    //All other layers
    return true;
}
//-------------------
// RefreshElevationList
// function RefreshElevationList() {
//     $("#ElevationsID").html("");
//     BuildElevationsList(SGWorld.ProjectTree.RootID);
// }
//-------------------
// BuildElevationsList
// function BuildElevationsList(parentNode) {

//     try {
//         var node = SGWorld.ProjectTree.GetNextItem(parentNode, 11);
//         while (node != "") {

//             if (SGWorld.ProjectTree.IsGroup(node))
//                 BuildElevationsList(node);

//             else if (SGWorld.ProjectTree.IsLayer(node)) {
//             }
//             else {
//                 var a = SGWorld.ProjectTree.GetItemName(node);
//                 var Object = SGWorld.Creator.GetObject(node);
//                 if (Object != null) {
//                     if (Object.ObjectType == 29)
//                         AddElevationToList(Object);
//                 }
//             }
//             node = SGWorld.ProjectTree.GetNextItem(node, 13);
//         }
//     }
//     catch (err) { if(gDebug) alert ("TerrainProfile.html -> BuildElevationsList " + err.message); }
// }
//---------------
// checkIntersaction
function checkIntersaction (layer,geometry){
    try {
        var layerObj = SGWorld.Creator.GetObject(layer);
        if(layerObj.ObjectType == 29) {  // Elevation Layer
            layerGeometry = layerObj.Geometry;
        }
        else if (layerObj.ObjectType == 28) {  //Point Cloud
            var layerRing = SGWorld.Creator.GeometryCreator.CreateLinearRingGeometry([layerObj.Terrain.BBox.MinX, layerObj.Terrain.BBox.MaxY, 0, layerObj.Terrain.BBox.MaxX, layerObj.Terrain.BBox.MaxY, 0, layerObj.Terrain.BBox.MaxX, layerObj.Terrain.BBox.MinY, 0, layerObj.Terrain.BBox.MinX, layerObj.Terrain.BBox.MinY, 0]);
            var layerGeometry = SGWorld.Creator.GeometryCreator.CreatePolygonGeometry(layerRing, layerRing);
        }
        else if (layerObj.ObjectType == 36 || layerObj.ObjectType == 38){  //Feature Layer or 3DML
            var layerRing = SGWorld.Creator.GeometryCreator.CreateLinearRingGeometry([layerObj.BBox.MinX, layerObj.BBox.MaxY, 0, layerObj.BBox.MaxX, layerObj.BBox.MaxY, 0,layerObj.BBox.MaxX, layerObj.BBox.MinY, 0, layerObj.BBox.MinX, layerObj.BBox.MinY, 0]);
            var layerGeometry = SGWorld.Creator.GeometryCreator.CreatePolygonGeometry (layerRing,layerRing);
        }
        else
            return false;

        if (layerGeometry.SpatialRelation.Intersects(geometry) == false ) {
            return false;
        }

        return true;
    }
    catch (err) { if (gDebug) alert("TerrainProfile.html -> checkIntersaction: " + err.message); } 
}
//---------------
function SameLayerSelectedTwice(){
    var layer1ID = $('#Layer1ID').val();
    var layer2ID = $('#Layer2ID').val();
    var CompareMode = $("#CompareMode").val();
    if(CompareMode == 1 && layer1ID == layer2ID)
        return true;
    return false;
}

//--------------
// CreateObjects
//--------------
function CreateObjects(method) {
    if(SameLayerSelectedTwice()){
        alert(SGLang.i18n("Text73"));
        return;
    }
    if (!bInEdit) {
        bInEdit = true;
	
        if (drawing.drawingEditMode !=-1) {   // already in drawing . Reset everyting
            drawing.abort();
        }
        else {
            SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text16"));
            $("#lineButton").addClass("MenuButtonHighlight");

            drawing.drawPolyline ({
                style: {    
                    lineColor:"#ffffff",
                    lineWidth: 3,
                },
                altitudeMethod:3,   // altitudeMethod - use 2 of "OnTerrain" (drape on terrain) and 3 for "Absolute" (above mean sea level). Currently other methods are not supported
                deleteWhenExit: true, // 
                //parentGoupID: volumeGroup,
                saveOnExit: false,  // save the polyline/polygon when exiting the project. Default = false
                onFinish: DrawPoly,
                onAbort: Reset
            });
        }


    }
    else {
        //DrawPolyRButtonUp(0, 0, 0, 0); //throws an error
        drawing.abort();
    }
}
//-----------
// SelectGroupObjects
function SelectGroupObjects() {
    var node = SGWorld.ProjectTree.GetNextItem("", 10);
    if (node == 0 || !(SGWorld.ProjectTree.IsGroup(node) || SGWorld.ProjectTree.IsLayer(node))) {
        alert(SGLang.i18n("Text24"));
        return;
    }

    ShowPopup(1,0);
}
//-----------
// SelectClipboardObjects
function SelectClipboardObjects() {
    if(SameLayerSelectedTwice()){
        alert(SGLang.i18n("Text73"));
        return;
    }
    ShowPopup(2,0);
}

//-------------
// DrawPoly
function DrawPoly(geometry, type, altitudeType) {
    // create a polyline, under the hidden group, using this geometry and send the objID to the popup
    var lineGroup = SGWorld.ProjectTree.CreateGroup(SGLang.i18n("Text28"), SGWorld.ProjectTree.HiddenGroupID);       // SGWorld.ProjectTree.RootID
    var line = SGWorld.Creator.CreatePolyline(geometry, "#FC8220", 3, lineGroup, "ProfileLine");
    line.LineStyle.Width = -4;
    line.SetParam(5440, 1);

    ShowPopup(0, lineGroup);
    return true;

}


//----------------
//  ShowPopup 
function ShowPopup(ProfileType, ObjID) {
    if (!ValidateInput())
        return false;
    var Layer1ID = "";
    var Layer2ID = "";
    var Density = $("#DensityID").val();
    var CompareMode = $("#CompareMode").val();

    if (CompareMode == "1"){
        //check intersection with layers
        //check that both layers are not empty
        $("#Layer1ID option:selected").each(function () {
            Layer1ID = $(this).val();
        });
        $("#Layer2ID option:selected").each(function () {
            Layer2ID = $(this).val();
        });
        if (Layer1ID == "" ||
            Layer1ID == -1 || 
            Layer2ID == "" ||
            Layer2ID == -1
        ) {
            alert(SGLang.i18n("Text26"));
            if(ProfileType == 0)
                SGWorld.ProjectTree.DeleteItem(ObjID);
            Reset(0, 0);
            return;
        }
    }
    
    // Remove previos popup
    SGWorld.Window.RemovePopupByCaption(gPopupCaption);

    gPopupCaption = SGLang.i18n("Text14") + " " + Date().toString();
    var url = abspath() + "/TerrainProfilePopup.html?Type=" + ProfileType + "&CompareMode=" + CompareMode + "&ObjID=" + ObjID + "&Density=" + Density + "&Layer1ID=" + Layer1ID + "&Layer2ID=" + Layer2ID + "&Caption=" + gPopupCaption + "&lang=" + SGLang.getCode();
    //    var popupMsg = SGWorld.Creator.CreatePopupMessage(gPopupCaption, url, 1, SGWorld.Window.Rect.Height * 2 / 3, SGWorld.Window.Rect.Width - 2, SGWorld.Window.Rect.Height / 3 - 55, -1);
    if (TEF){
        parent.panel.addAndShow (1,url,gPopupCaption,null,'50%',parent.panel.state.heightRegular,false,1);
    }else {
        var popupMsg = SGWorld.Creator.CreatePopupMessage(gPopupCaption, url, 1, -1000, 100, 100, -1);
        popupMsg.Flags = 2 + 32;
        SGWorld.Window.ShowPopup(popupMsg);        
    }
    Reset(0, 0);
}


//---------------
// ValidateInput
function ValidateInput() {
    return true;
}
//--------------
// CheckNumberEx
function CheckNumberEx(field, defVal, MinNum, MaxNum) {
    try {
        field.value = validateNumber(field.value);

        if (field.value < MinNum)
            field.value = MinNum;
        if (field.value > MaxNum)
            field.value = MaxNum;
    }
    catch (err) { 
        if (gDebug) 
            alert("TerrainProfile.html -> RefreshList: " + err.message);
        field.value = defVal 
    } 
}

</script>

</body>
</html>
