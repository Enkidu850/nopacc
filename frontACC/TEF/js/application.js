function loadLangScript(scriptUrl,defaultURL,useDefaultURL){var script=document.createElement("script"),head=document.head||document.getElementsByTagName("head")[0];script.src=scriptUrl,script.onload=async()=>{useDefaultURL&&application.errorHandling(Lang.application.langErrorLoading,0),loadApplication()},script.onerror=function(){head.removeChild(script),defaultURL&&loadLangScript(defaultURL,void 0,!0)},head.insertBefore(script,head.firstChild)}async function loadApplication(){application.render(),$("#loadingText").text(Lang.application.initApplication),null==SGWorld&&(SGWorld=CreateSGWorld());var loginToSGSFailed=services.GetParamValue("loginSGSError",""),loginToSGSFailed=(""!=loginToSGSFailed&&(application.state.onLoadErrorMessage=decodeURIComponent(loginToSGSFailed).replace(/'/g,""),services.removeURLParameter("loginSGSError")),services.GetParamValue("loginSGSURL",""));""!=loginToSGSFailed&&(await application.connectByCookie(loginToSGSFailed).catch(()=>{}),services.removeURLParameter("loginSGSURL")),SGWorld.SGServer.ReconnectAsync().OnResolve(function(){application.state.connectedServer=SGWorld.SGServer.GetConnectedServer(),application.continueInitPage()}).OnReject(function(error){application.state.connectedServer="",application.continueInitPage()})}$(async function(){try{application.state.applicationPath=window.location.href.split("?")[0];var sgsConfig=services.GetParamValue("config","");application.state.projectPath=services.GetParamValue("project",""),Module.onRuntimeInitialized=async function(){var config=await application.getConfigFileFromTEF(sgsConfig).catch(err=>{throw new Error(err)});application.initCustomization(config),loadLangScript(`./lang/${application.state.langCode}/application.js`,"./lang/en/application.js",!1)}}catch(error){application.errorHandling(error.message,0),application.showStartPage()}});var application={state:{TEPLUS:!1,langCode:"",langCodeFromURL:!1,errorLog:[],projectPath:"",applicationPath:"",frameCounter:0,renderQuality:0,isPlanar:null,suppressMessages:!1,connectedServer:null,connectedUser:null,reloadAfterLogin:!1,openProjectsDialogAfterLogin:!1,messageBarTimeout:null,disabledMessageBar:!1,popupMessageTimeout:null,tooltipTimeout:null,isMessageDisplayed:!1,maxMessageTimeout:10,tooltipOpenTime:300,CameraPos:null,PointerPos:null,statusBarX:0,statusBarY:0,sevirityText:[],messageBarClass:["messageError","messageWarning","messageInfo"],errorsCount:0,serverConfig:{},isCustomAuth:!1,isMobile:!1,isChomium:!1,onLoadErrorMessage:"",treeItemIcons:{folder:"InfotreeGroupOp.bmp",object:"InfotreeObjectStatic.bmp",_19:"InfotreeLocation.bmp",_20:"InfotreeHotlink.bmp",_23:"InfotreeObjectDyn.bmp",_26:"InfotreeImageryLayer.bmp",_27:"InfotreeVideo.bmp",_28:"infoTreePointCloud.bmp",_29:"InfotreeRasterLayer.bmp",_30:"infoTreeModifyTerrain.bmp",_34:"InfotreePresentation.bmp",_35:"InfotreeLOS2.bmp",_36:"InfotreeMPV.bmp",_36_0:"LayerPointInfoTree.bmp",_36_1:"LayerPolylineInfoTree.bmp",_36_2:"LayerPolygonInfoTree.bmp",_36_3:"InfotreeMPV.bmp",_37:"InfotreeMPV.bmp",_38:"InfoTree3DMLMeshLayer.bmp",_40:"InfotreeKML.bmp",_41:"Infotree3DViewshed.bmp",_42:"infotreeContour.bmp",_43:"InfotreeSlope.bmp",_45:"InfotreeNetworkLink.bmp"},treeItemsWithoutCheckbox:[19,20,21,22,32,34,45,46],loginHeight:"17rem",last:null,hasLayerWithoutPermission:!1,blockSGSfromDifferentDomain:!1,enableContextMenu:!0},continueInitPage:async function(){if(await application.init().catch(err=>{throw new Error(err)})){let errorMessage="";try{parent&&parent.onTEFInit()}catch(err){}try{await application.authSGS()}catch(error){if(error&&"forceLogin"==error)return;errorMessage=Lang.application.loginFailed}application.renderPage(errorMessage)}},renderPage:function(errorMessage){startPage.render(function(){settings.getRecentProjects($("#startpageRecentProjectsDiv"))}),""==application.state.projectPath?application.showStartPage():errorMessage?application.showStartPage(errorMessage):application.openFly()},init:function(){return new Promise((resolve,reject)=>{try{if(!application.initDeviceState())return application.errorWhileLoading(Lang.application.browserNotSupported),void resolve(!1);settings.getRecentProjects($("#startpageRecentProjectsDiv")),application.state.sevirityText[0]=Lang.application.sevirityError,application.state.sevirityText[1]=Lang.application.sevirityWarning,application.state.sevirityText[2]="",application.state.isChomium&&$(document).tooltip({tooltipClass:"tetooltip"}),panel.init(),window.addEventListener("beforeunload",function(event){}),console.defaultError=console.error.bind(console),console.error=async function(){var a=Array.from(arguments);if(0<=a[0].indexOf('resultMessageCode":"NoPermissions"'))application.setLoginState(!1),application.errorHandling(Lang.application.mustLogin,1),""!=application.state.connectedServer&&null!=application.state.connectedServer&&await application.logout().catch(()=>{}),application.showLogin("reloadProject"),$("#errorLogin").show(),$("#errorLogin").text(Lang.application.mustLogin);else{if(application.state.suppressMessages&&(0<=a[0].indexOf('resultMessageCode":"UnknownProject"')||0<=a[0].indexOf("Failed to load FLY:")))return application.showStartPage(Lang.application.failedToLoadFly),!1;{if(0<=a[0].indexOf("Failed to load MPT:"))return application.showStartPage(Lang.application.failedToLoadTerrain),!1;0<=a[0].toLowerCase().indexOf("missing read permission")?(application.state.hasLayerWithoutPermission=!0,application.errorHandling(Lang.application.unsupportedLayersError,0)):application.errorHandling(arguments[0],1)}}},console.info=function(){application.errorHandling(arguments[0],-2)},console.warn=function(){application.errorHandling(arguments[0],-1)},null==window?attachEvent("onmessage",addContent.receiveMessage,!1):window.addEventListener("message",addContent.receiveMessage,!1),window.addEventListener("mousedown",event=>{1===event.button&&event.preventDefault()}),""!=application.state.onLoadErrorMessage&&application.openPopupDialog(0,application.state.onLoadErrorMessage,Lang.application.loginToSGS,300,150,-1),application.closeMessageBar()}catch(err){application.errorWhileLoading(err.message),resolve(!1)}resolve(!0)})},authSGS:function(){return new Promise((resolve,reject)=>{application.initCustomAuth().then(()=>{application.loginByTokenOrForceLogin().then(()=>{resolve()}).catch(err=>{reject(err)})})})},openFly:function(){$("#loadingText").text(Lang.application.loadingProject);try{SGWorld.AttachEvent("OnSGWorldMessage",application.OnSGWorldMessage),SGWorld.AttachEvent("OnMeasurementQueryResult",application.OnMeasurementQueryResult),SGWorld.AttachEvent("OnObjectUnderCursorChanged",application.OnObjectUnderCursorChanged),SGWorld.AttachEvent("OnInputModeChanged",application.OnInputModeChanged),SGWorld.AttachEvent("OnFrame",application.onFrame),SGWorld.AttachEvent("OnRenderQualityChanged",application.OnRenderQualityChanged),SGWorld.AttachEvent("OnLoadFinished",application.OnLoadFinished);var serverMatch=application.state.projectPath.match(/^(http[s]?:\/\/.+?)(\/([a-f0-9]{32}))?\/projects(\/|[?])/i);if(serverMatch&&(SGWorld.CoordServices.ShiftGridURL=serverMatch[1]+"/ProjData"),application.state.blockSGSfromDifferentDomain){var domainRegex=/^(?:https?:\/\/)?([^\/]+)/i,projectDomain=application.state.projectPath.match(domainRegex),applicationDomain=window.location.href.match(domainRegex);if(projectDomain[0]!=applicationDomain[0])return void application.showStartPage(Lang.application.blockSGSfromDifferentDomain)}application.state.suppressMessages=!0,SGWorld.Project.Open(this.state.projectPath)}catch(err){application.errorWhileLoading(Lang.application.LoadingError)}},OnLoadFinished:function(success){try{0==SGWorld.LicenseManager.GetPermission(2314,0)&&(application.state.TEPLUS=!0),$("#loadingDiv").hide(),$("#applicationDiv").show(),$("#toolbox").show(),toolbox.init(),settings.init(),analysis.init(),projectTree.init(),features.init(),navigate.init(),search.init(),addContent.init(),SGWorld.Command.IsChecked(1155,0),application.execute(1155,0),application.state.isPlanar=0!=SGWorld.Terrain.CoordinateSystem.IsPlanar(),application.setLoginState(!1),$("#LoginTitleDivID").show(),application.state.disabledMessageBar=!1,application.state.serverConfig&&application.state.serverConfig.startupScript&&eval(application.state.serverConfig.startupScript),services.loadAndRunScript("js/startupScript.js",!0);var script=services.GetParamValue("script",""),fullProjectName=(""!=script&&services.loadAndRunScript(""+script,!0),$("#applicationDiv").on("contextmenu",function(e){var menu;e.preventDefault(),!application.state.enableContextMenu||0!=SGWorld.Window.GetInputMode()&&2!=SGWorld.Window.GetInputMode()||(menu=application.buildContextMenu(),superCm.createMenu(menu,e))}),application.state.suppressMessages=!1,application.state.projectPath.split("/")),fullProjectName,projectName,projectName;1<fullProjectName.length&&(fullProjectName=fullProjectName[fullProjectName.length-1],projectName=fullProjectName.split("."),projectName=0<projectName.length?projectName[0]:fullProjectName,document.title="TerraExplorer: "+projectName);try{parent&&parent.onTEFProjectLoaded()}catch(err){}}catch(err){application.errorWhileLoading(err.message)}},buildContextMenu:function(){try{var menu=[];return menu.push({label:""+Lang.navigate.addLocation,submenu:null,disabled:!1,action:function(option,contextMenuIndex,optionIndex){superCm.destroyMenu(),navigate.createAndEditLocation(2,application.state.PointerPos)}}),menu}catch(err){return application.errorHandling(err.message,0),null}},render:function(){try{$("body").append(` 
         <div id="errorDiv" class="errorDiv" style="display:none">
             <img src="images/img/ErrorLoading.png"  class="errorImg">
             <span id="errorTextID" class="s18 i18n"></span>  
         </div>`),$("#applicationDiv").append('<canvas id="canvas" width="300px" height="300px"  tabindex="1" oncontextmenu="event.preventDefault()"></canvas>'),$("body").append('<div id="toolbox" class="toolbox boxShadowLarge" style="display:none"></div>'),$("#applicationDiv").append(`<div id="frameRateDiv" class="frameRate" style="display:none">
            <label for="pin" class="btns s9inv">${Lang.application.frameRate}:</label><label for="pin" class="btns s9inv" id="FR"></label>
       </div>`),$("#applicationDiv").append('<img class="logo"  src="logo.png" />'),$("#applicationDiv").append(`<div id="centerSignID" class="centerSign noEvents" style="display:none">
            <img class="imgSmall noEvents" src="images/icons/centerSign.svg">
       </div>`),$("#applicationDiv").append(`<div id="navigationButtons" class="navigationBarDiv boxShadowLarge" style="display:none">
            <img src="images/icons/north.svg" id="navigationButtonNorth" class="navigationButton link" onclick="navigate.north()">
            <img src="images/icons/ZoomIn.svg" class="navigationButton link" onclick="navigate.zoom(1)">
            <img src="images/icons/ZoomOut.svg" class="navigationButton link" onclick="navigate.zoom(-1)">
       </div>`),$("#applicationDiv").append(`<div id="statusBarID" class="statusBar" style="display:none">
             <div class="bufferingDivWrapper inlineBlock"><div id="bufferingID" class="bufferingDiv"></div></div>
             <div class="inlineBlock s9">
                <span id="statusCoordType"  > </span>: &nbsp;
                <span id="LonID" class=" link2"  onclick="search.inputFromCord(false)"></span> &nbsp;
                <span id="LatID" class=" link2" onclick="search.inputFromCord(false)"> </span> &nbsp;
                <span id="altitudeID" class=""></span> &nbsp;
                <span id="directionID" class=""></span> &nbsp;
                <span  id="MGRSID" class=" link2" style="display: none;"  onclick="search.inputFromCord(true)" class=""></span> &nbsp;
            </div>
            <div class="inlineBlock s9"> <span id="copyrightID" class="bold copyright"></span> </div>
        </tr> </table>
       </div>    `),$("body").append(`<div id="messageBar" class = "messageBar boxShadowLarge "  style="display:none">
            <div id="messageBarText" ></div>
        </div>`),$("body").append(` 
            <div id="LoginTitleDivID" class="LoginTitleDiv"  onclick="application.showLogin()" style="display:none">
                 <span class="s14w link LoginTitle" id="logInTitle" ></span> 
            </div>`),$("body").append(`
        <div id="logInContainer" class="logInContainer gridPadding" style="display:none;">
                <label id="serverURLLabel" class="" for="serverURL">${Lang.application.serverURL}:</label>
                <input class="mt12 w95 py3 px6" type="text" id="serverURL" oninput="" placeholder="${Lang.application.serverURLPlaceholder}" name="serverURL">
                <div id="loginErrorDiv" class="mt40">
                    <span class="s9 LoginError"  style="display:none" id="errorLogin"></span>
                </div>
                <button id="loginBtnNext" class="ButtonRound loginButtonRight" onclick="application.nextButtonLogin();">${Lang.application.next}<span style="display: none" id="loginSpinner" class="spinner"></span></button>
                <div id="logOutDiv" class="loggedInDetails" style="display: none">
                    <div id="loggedInDetailsCircleId" class="loggedInDetailsCircle"></div>
                    <div class="loggedInInfoDiv">
                        <div id="accountName"></div>
                        <div id="accountEmail"></div>
                        <div id="accountServerURL"></div>
                    </div>
                </div>
                <button id="logOut" class="ButtonRound loginButtonRight" onclick="application.logoutButton();">${Lang.application.logOut}</button>
        </div>`),$("body").append(`
        <div id="logInContainer-2" class="logInContainer gridPadding" style="display:none;">
                <label class="" for="userName">${Lang.application.userName}:</label>
                <input class="mt12 w95 py3 px6" type="text" id="userName" oninput="" placeholder="${Lang.application.userNamePlaceholder}" name="userName">
                <div class="mt12">
                    <label class="mt12" for="password">${Lang.application.password}:</label>
                </div>
                <input class="mt12 w95 py3 px6" type="password" id="password" oninput="" placeholder="${Lang.application.passwordPlaceholder}" name="password" onkeydown = 'if (event.keyCode === 13) {$("#SGSConnectBtn").click();}'>
                <div id="customAuthExtraButtons" class="spacerAbove" display="none">
                </div>
                <div class="mt12">
                    <span class="s9 LoginError"  style="display:none" id="errorLogin-2"></span>
                </div>
                <button id="SGSConnectBtn" class="ButtonRound loginButtonRight px12 py6" onclick="application.logInButton();" style="display: none">${Lang.application.logIn}</button>
        </div>`),$("body").append(`
        <div id="loginContainerIframe" title="" style="display:none; padding:0px; height: 500px">
            <iframe type="text/html" id="loginIframe" class="loginiframe h100 w100" src=""></iframe>
        </div>`),$("body").append(`
            <div id="dialogConfirmContainer" class="messagePopup dialogConfirmDiv s12" style="display:none;">
                <div id="dialogConfirmContent" class="messagePopupContent dialogConfirmContent"></div>
            </div>     `),$("body").append(`
            <div id="messagePopupContent" class="messagePopup"></div>`),$("body").append('<div id="toolTip" class = "toolTip boxShadowSmall"  style="display:none">            <span id="toolTipText" class="s9"></span>        </div>')}catch(err){application.errorWhileLoading(err.message)}},initDeviceState:function(){try{if(/Chrome|Edg/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)&&(application.state.isChomium=!0),/iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return!1;if(/Android|iPhone/i.test(navigator.userAgent)){if(""==services.GetParamValue("ct",""))return!1;var link=document.createElement("link");link.setAttribute("rel","stylesheet"),link.setAttribute("href","./css/mobile.css"),document.head.appendChild(link),application.state.isMobile=!0}return!0}catch(err){application.errorHandling(err.message,0)}},errorWhileLoading:function(errorText){try{$("#loadingDiv").hide(),$("#errorTextID").text(errorText),$("#errorDiv").show()}catch(err){application.errorHandling(err.message,0)}},errorHandling:function(message,sevirity){null!=message&&""!=message&&(0==Math.abs(sevirity)&&(application.state.errorsCount++,null!=arguments.callee.caller)&&""!=arguments.callee.caller.name&&(message=` ${message} (${arguments.callee.caller.name})`),0<=sevirity&&!application.state.suppressMessages&&!projectTree.state.inLoadMyData&&application.showMessageBar(application.state.sevirityText[Math.abs(sevirity)]+message,5,Math.abs(sevirity)),0<=sevirity&&sevirity<2&&application.state.errorLog.push([sevirity,message]),toolbox.showLoggerCount(application.state.errorsCount))},getErrorLogCount:function(message){try{return application.state.errorLog.length}catch(err){application.errorHandling(err.message,0)}},getCurrentSitePath:function(){var site=services.GetParamValue("site","");return site==site==""?"":("/"+site).replace("#","").replace(/\/$/,"")},getUrlPrefix:function(){var serverMatch=application.state.projectPath.match(/^(http[s]?:\/\/.+?)(\/([a-f0-9]{32}))?\/projects(\/|[?])/i);return serverMatch?serverMatch[1]:(serverMatch=(serverMatch=0==window.location.pathname.indexOf("/")?window.location.pathname.substring(1):window.location.pathname).substring(0,serverMatch.indexOf("/")),window.location.origin+"/"+serverMatch+application.getCurrentSitePath())},connectByCookie:function(SGSUrl){return new Promise(async(resolve,reject)=>{SGWorld.SGServer.ConnectByCookieAsync(SGSUrl,"__cookie__",!0).OnResolve(function(){resolve()}).OnReject(function(error){reject(error)})})},initCustomAuth:function(){return new Promise(async(resolve,reject)=>{var urlPrefix;(""==application.state.connectedServer||null==application.state.connectedServer)&&(urlPrefix=application.getUrlPrefix(),urlPrefix=await application.isCustomAuth(urlPrefix))&&"true"==urlPrefix.result?application.autoLogin(urlPrefix.scriptURL,(username,jwtToken)=>{try{SGWorld.SGServer.ConnectAsync(serverURL,"xxx","xxx",jwtToken).OnResolve(function(){application.setLoginState(!1),resolve()}).OnReject(function(error){$("#errorLogin-2").show(),$("#errorLogin-2").text(error.message)})}catch(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)}},fnErrorResult=>{resolve()}):resolve()})},isCustomAuth:function(serverURL){return new Promise((resolve,reject)=>{fetch(serverURL+"/isCustomAuth",{method:"GET"}).then(res=>res.json()).then(result=>{resolve(result)}).catch(error=>{resolve(error.toString())})})},autoLogin:function(scriptURL,fnSuccess,fnError){var script=document.createElement("script"),scriptURL=(script.src=scriptURL,script.addEventListener("load",()=>{"function"==typeof SkylineCustomAuth.autoLogin&&SkylineCustomAuth.autoLogin(fnSuccess,fnError)}),script.addEventListener("error",error=>{reject(error)}),script.setAttribute("customAuth-script","1"),document.querySelector('script[customAuth-script="1"]'));scriptURL&&scriptURL.remove(),document.body.appendChild(script)},getConfigFileFromTEF:function(name){return new Promise((resolve,reject)=>{var urlPrefix=application.getUrlPrefix(),name=services.GetParamValue("config","");application.state.serverConfig.serverURL=urlPrefix,fetch(urlPrefix+"/gettefconfig?name="+name,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}).then(res=>res.json()).then(result=>{1==result.result?(result=JSON.parse(result.Value),resolve(result)):resolve(JSON.parse("{}"))}).catch(error=>{resolve(JSON.parse("{}"))})})},initCustomization:function(data){var data="string"==typeof data?{}:data,data=(application.state.serverConfig={...application.state.serverConfig,...data},application.state.serverConfig.cssScript),head=document.head||document.getElementsByTagName("head")[0],style=document.createElement("style");head.appendChild(style),style.type="text/css",style.appendChild(document.createTextNode(data)),""!=(data=services.GetParamValue("css",""))&&(head=""+data+".css",(style=document.createElement("link")).setAttribute("rel","stylesheet"),style.setAttribute("href",head),document.head.appendChild(style)),application.state.langCode=services.GetParamValue("lang",""),""==application.state.langCode?(application.state.serverConfig.customLang&&""!=application.state.serverConfig.customLang?application.state.langCode=application.state.serverConfig.customLang:application.state.serverConfig.lang&&""!=application.state.serverConfig.lang&&(application.state.langCode=application.state.serverConfig.lang),application.state):application.state.langCodeFromURL=!0,""==application.state.langCode&&(application.state.langCode="en")},showStartPage:function(errorMessage){try{void 0!==errorMessage&&""!==errorMessage&&setTimeout(()=>{$("#startPageError").html(errorMessage),$("#startPageError").show(),application.state.errorLog.forEach(function(element){$("#startPageError").append("<br>"+element[1].replace(/^\s*TerraExplorer:\s*/,""))})},500),$("#loadingDiv").hide(),$("#LoginTitleDivID").addClass("startPageLogin"),application.setLoginState(!1),$("#startPageDiv").show()}catch(err){application.errorHandling(err.message,0)}},isValidURL:function(str){return!!new RegExp("^(https?:\\/\\/)?([^:\\/]+)(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(str)},isSGSVersionGreaterThanTargetVersion:function(sgsVersion,targetVersion){var versionParts=sgsVersion.split(".").map(Number),targetVersionParts=targetVersion.split(".").map(Number);for(let i=0;i<versionParts.length;i++){if(versionParts[i]>=targetVersionParts[i])return!0;if(versionParts[i]<targetVersionParts[i])return!1}return!1},loginByTokenOrForceLogin:function(){return new Promise(async(resolve,reject)=>{if(""==application.state.projectPath)resolve();else{var serverMatch,loginUrl="",token="",m=decodeURIComponent(application.state.projectPath).match(/^(http[s]?:\/\/.*)\/([a-f0-9]{32})\/projects\//i);if(m&&(token=m[2],loginUrl=m[1]+"?token="+token),m||(projectMatch=location.href.match(/[?&]project=(.*)/i))&&(serverMatch=decodeURIComponent(projectMatch[1]).match(/^(http[s]?:\/\/.*)\/projects\//i))&&(m=(m=decodeURIComponent(projectMatch[1]).match(/[?&]token=([a-f0-9]{32})/i))||location.href.match(/[?&]token=([a-f0-9]{32})/i))&&(token=m[1],loginUrl=serverMatch[1]+"?token="+token),""!=loginUrl)if(""!=application.state.connectedServer&&null!=application.state.connectedServer){var projectMatch=!1;try{projectMatch=SGWorld.SGServer.IsTokenLoggedIn(token)}catch{}if(projectMatch)resolve();else{await application.logout().catch(()=>{});try{SGWorld.SGServer.ConnectAsync(loginUrl,"","").OnResolve(function(){resolve()}),OnReject(function(error){reject()})}catch{resolve()}}}else try{SGWorld.SGServer.ConnectAsync(loginUrl,"","").OnResolve(function(){resolve()}).OnReject(function(error){reject()})}catch{resolve()}else if(application.state.serverConfig&&application.state.serverConfig.loginMode)if("force"==application.state.serverConfig.loginMode&&""==application.state.connectedServer)application.state.forceLoginMode=!0,application.showLogin(),reject("forceLogin");else if("token"==application.state.serverConfig.loginMode)try{SGWorld.SGServer.ConnectAsync(this.state.serverConfig.serverURL+"?token="+application.state.serverConfig.token,"","").OnResolve(function(){resolve()}).OnReject(function(error){resolve()})}catch{resolve()}else resolve();else resolve()}})},reloadPage:function(){try{application.state.projectPath=$("#enterProjectURL").val(),""!=application.state.projectPath&&this.isValidURL(application.state.projectPath.trim())?application.reloadPageURL(application.state.projectPath):application.showStartPage(Lang.application.failedToLoadFly)}catch(err){application.errorHandling(err.message,0)}},reloadPageURL:function(projectURL){try{var newLocation=(newLocation=location.href).substring(0,newLocation.indexOf(".html")+5),lang=application.state.langCodeFromURL?"&lang="+application.state.langCode:"";window.location=newLocation+"?project="+projectURL+lang}catch(err){application.errorHandling(err.message,0)}},openDemoProjectURL:function(projectURL){try{var newLocation=location.origin+location.pathname,newSearch="",newSearch=null!=location.search.match(/([?&])project=[^&]*/)?location.search.replace(/([?&])project=[^&]*/,"$1project="+projectURL):(""==newSearch?"?":"&")+"project="+projectURL,lang=application.state.langCodeFromURL?"&lang="+application.state.langCode:"";window.location=""+newLocation+newSearch+lang}catch(err){application.errorHandling(err.message,0)}},openInTED:function(){try{window.open(this.state.projectPath,"_blank")}catch(err){application.errorHandling(err.message,0)}},OnRenderQualityChanged:function(quality){try{application.state.renderQuality=quality}catch(err){application.errorHandling(err.message,0)}},onFrame:function(success){try{var altitudeTypeRequest,cursor,coordPoint,YSign,XSign,digits,MGRS,rotate;application.state.frameCounter%12==0&&($("#bufferingID").width(application.state.renderQuality),altitudeTypeRequest=0==settings.state.altitudeType?0:3,application.state.CameraPos=SGWorld.Navigate.GetPosition(altitudeTypeRequest),cursor=SGWorld.Window.GetMouseInfo(),application.state.PointerPos=SGWorld.Window.PixelToWorld(cursor.X,cursor.Y,-1153).Position,application.state.PointerPos.ChangeAltitudeType(altitudeTypeRequest),application.state.PointerPos.Distance=400,application.state.PointerPos.Pitch=application.state.CameraPos.Pitch,application.state.PointerPos.Yaw=application.state.CameraPos.Yaw,application.state.PointerPos.Distance=application.state.PointerPos.DistanceTo(application.state.CameraPos),0==settings.state.statusBarCoordinateMode?(coordPoint=application.state.CameraPos,$("#statusCoordType").text(Lang.application.viewer),$("#directionID").text(coordPoint.Yaw.toFixed(digits)+"°")):(0==(coordPoint=application.state.PointerPos).X&&0==coordPoint.Y?(coordPoint=SGWorld.Window.PixelToWorld(SGWorld.Window.Rect.Width/2,SGWorld.Window.Rect.Height/2,-1153).Position,$("#statusCoordType").text(Lang.application.center)):$("#statusCoordType").text(Lang.application.pointer),$("#directionID").text("")),application.state.statusBarX=coordPoint.X,application.state.statusBarY=coordPoint.Y,YSign=0<coordPoint.Y?Lang.application.coordNorth:Lang.application.coordSouth,XSign=0<coordPoint.X?Lang.application.coordEast:Lang.application.coordWest,digits=application.state.isPlanar?1:6,$("#LatID").text(coordPoint.Y.toFixed(digits)+" "+YSign),$("#LonID").text(coordPoint.X.toFixed(digits)+" "+XSign),application.state.isMobile&&settings.state.showMGRS?$("#altitudeID").text(""):$("#altitudeID").text(settings.formatDistance(coordPoint.Altitude,1)+" "+settings.state.altitudeTypeString),settings.state.showMGRS)&&(MGRS=SGWorld.CoordServices.ConvertCoordinateToMGRS(coordPoint.X,coordPoint.Y),application.state.isMobile?$("#MGRSID").text(MGRS):$("#MGRSID").text(Lang.application.coordMGRS+":"+MGRS)),application.state.frameCounter%3==0&&(rotate=360-SGWorld.Navigate.GetPosition(0).Yaw,$("#navigationButtonNorth").css({"-webkit-transform":"rotate("+rotate+"deg)","-moz-transform":"rotate("+rotate+"deg)",transform:"rotate("+rotate+"deg)"}))}catch(err){}application.state.frameCounter++},execute:function(id,param){try{SGWorld.Command.Execute(id,param)}catch(err){application.errorHandling(err.message,0)}},isCommandChecked:function(id,param){try{return SGWorld.Command.IsChecked(id,param)}catch(err){return application.errorHandling(err.message,0),!1}},OnSGWorldMessage:function(MessageID,SourceObjectID){try{var content="",width=400,height=400;if("MessageBarText"==SourceObjectID)return application.state.disabledMessageBar?void 0:(analysis.state.queryOn?analysis.showQueryHover(services.clearHTMLString(MessageID)):application.state.suppressMessages||projectTree.state.inLoadMyData||application.showMessageBar(services.clearHTMLString(MessageID),5,2),!0);var message=SGWorld.Creator.GetObject(MessageID),messageType=0;if(32==message.ObjectType&&(""!=message.Src?(content=message.Src,messageType=1):content=services.clearHTMLString(""==message.InnerHTML?message.InnerText:message.InnerHTML),0==(8192&message.Flags)?(width=Math.max(400,message.Width),height=Math.max(400,message.Height)):width=height=-1,application.openPopupDialog(messageType,content,message.Caption,width,height,message.Timeout)),22==message.ObjectType)switch(message.Type){case 0:switch(content=services.clearHTMLString(message.Text),message.TargetPosition){case 3:application.showMessageBar(content,5,2);break;case 4:window.open(content,"_blank").focus();break;default:application.openPopupDialog(messageType,content,"Message",-1,-1,-1)}break;case 1:window.open(message.URL,"_blank").focus();break;case 3:0<=message.Text.indexOf("<DOCTITLE>")?application.showXMLMessage(message.Text,SourceObjectID):application.activateScriptMessage(message.Text,SourceObjectID)}}catch(err){application.errorHandling(err.message,0)}return!0},showXMLMessage:function(message,sourceObjectID){try{var xslName,xmlString=(xmlString=message.substring(message.indexOf("<"))).substring(0,xmlString.lastIndexOf(">")+1),xml=(new DOMParser).parseFromString(xmlString,"text/xml"),title="Attributes"==xml.firstChild.attributes.name.value?(xslName="Message.xsl",Lang.application.attributes):(xslName="linksMessage.xsl",Lang.application.message),xslFile=services.abspath()+"/TerraExplorerApp.Emscripten.Resources/"+xslName,xsl=services.loadXMLDoc(xslFile),html=services.convertXmlToHtml(xml,xsl);application.openPopupDialog(0,html,title,-1,-1,-1)}catch(err){application.errorHandling(err.message,0)}},activateScriptMessage:function(script,sourceObjectID){try{if(null==script.split(">")[1])application.errorHandling(Lang.application.noVBScript,1);else{var a=script.split(">")[1].split("<")[0],a=a.replace(/\\n/g,"");if(a=a.replace(/\t/g,""),""!=sourceObjectID&&"0_0"!=sourceObjectID)try{var object=SGWorld.Creator.GetObject(sourceObjectID),This=This70=This71=This72=This73=This74=This80=This81=This82=object}catch(err){}var SGWorld70=SGWorld71=SGWorld72=SGWorld73=SGWorld74=SGWorld80=SGWorld81=SGWorld82=SGWorld;eval(a)}}catch(err){application.errorHandling(err.message,0)}},showMessageBar:function(text,timeout,sevirity){try{$("#messageBarText").html(""+text),$("#messageBar").removeClass(),$("#messageBar").addClass("messageBar boxShadowLarge s9 "+application.state.messageBarClass[sevirity]),$("#messageBar").show(),$("#messageBar").css("opacity","1"),$("#messageBar").css("height","max-content"),$("#messageBar").css("max-height","max-content"),clearTimeout(application.state.messageBarTimeout),timeout=Math.min(application.state.maxMessageTimeout,timeout),application.state.messageBarTimeout=setTimeout("application.closeMessageBar()",1e3*timeout)}catch(err){application.errorHandling(err.message,0)}},closeMessageBar:function(){try{$("#messageBar").hide(),$("#messageBar").css("max-height","0.67rem"),$("#messageBar").css("opacity","0"),$("#messageBar").css("height","0.67rem")}catch(err){application.errorHandling(err.message,0)}},OnObjectUnderCursorChanged:function(inObject,objectID){try{if(1==inObject){var text="",object=null;try{object=SGWorld.Creator.GetObject(objectID)}catch(err){}null!=object&&(33==object.ObjectType?text=object.GetProperty("Tool Tip"):null!=object.Tooltip&&(text=object.Tooltip.Text),""!=text)&&(text=(text=services.clearHTMLString(text)).replace(/'/g,"&#39;"),application.state.tooltipTimeout=setTimeout(`application.openToolTip ('${text}',10);`,application.state.tooltipOpenTime))}else clearTimeout(application.state.tooltipTimeout),application.closeToolTip()}catch(err){application.errorHandling(err.message,0)}},OnInputModeChanged:function(mode){try{0==mode&&analysis.state.queryOn&&(panel.close(!1),analysis.stopQuery())}catch(err){application.errorHandling(err.message,0)}},openToolTip:function(text){try{$("#toolTipText").html(text);var cursor=SGWorld.Window.GetMouseInfo();0<=cursor.X&&0<=cursor.Y?($("#toolTip").css("left",cursor.X+"px"),$("#toolTip").css("top",cursor.Y+"px")):($("#toolTip").css("left","50%"),$("#toolTip").css("top","50%")),$("#toolTip").show()}catch(err){application.errorHandling(err.message,0)}},closeToolTip:function(){try{$("#toolTip").hide()}catch(err){application.errorHandling(err.message,0)}},OnMeasurementQueryResult:function(result,objectID){try{analysis.showQueryMessage(result)}catch(err){application.errorHandling(err.message,0)}},openPopupDialog:function(messageType,message,title,width,height,timeout){try{var content;navigate.state.isPresentationToolboxOpen||(-1==width&&(width=panel.state.widthSmall),-1==height&&(height=panel.state.heightLarge),application.isMessageDisplayed&&panel.back(),""===title&&(title=Lang.application.message),content="",content=0==messageType?($("#messagePopupContent").html(message),"messagePopupContent"):message,panel.addAndShow(messageType,content,title,application.onCloseMessage,width,height,!1,1),application.isMessageDisplayed=!0,clearTimeout(application.state.popupMessageTimeout),0<timeout&&(application.state.popupMessageTimeout=setTimeout("application.closePopupDialog()",timeout)))}catch(err){application.errorHandling(err.message,0)}},resizePopupDialog:function(that){try{panel.setDimentions($($("#messagePopup")[0]).find("iframe")[0].contentWindow.document.body.scrollHeight+50,$($("#messagePopup")[0]).find("iframe")[0].contentWindow.document.body.scrollWidth+10)}catch(err){}},openPopupDialogURL:function(src,title,width,height,timeout){try{application.openPopupDialog(1,src,title,width,height,timeout)}catch(err){application.errorHandling(err.message,0)}},closePopupDialog:function(){try{application.isMessageDisplayed&&panel.back()}catch(err){application.errorHandling(err.message,0)}},onCloseMessage:function(){try{application.isMessageDisplayed=!1,clearTimeout(application.state.popupMessageTimeout),$("#messagePopupContent").html("")}catch(err){application.errorHandling(err.message,0)}},openConfirmationPopupDialog:function(message,title,width,height,buttonOneName,buttonOneFunction,buttonTwoName,buttonTwoFunction){try{$("#dialogConfirmContent").html(message),$("#dialogConfirmContainer").dialog({title:title,height:-1==height?"auto":height,width:-1==width?"auto":width,modal:!0,buttons:[{text:buttonOneName,id:"btnOK",class:"ButtonRound py6 px12",click:buttonOneFunction},{text:buttonTwoName,class:" py6 px12",click:buttonTwoFunction}],close:function(){$(this).dialog("close")}})}catch(err){application.errorHandling(err.message,0)}},isValidServer:function(serverURL){return new Promise((resolve,reject)=>{fetch(serverURL,{method:"GET"}).then(response=>{response.status<400?resolve(!0):resolve(!1)}).catch(error=>{resolve(!1)})})},getSGSVersion:function(serverURL){return new Promise((resolve,reject)=>{fetch(serverURL+"/api/v1/version",{method:"GET"}).then(res=>res.json()).then(result=>{resolve(result)}).catch(error=>{resolve(error.toString())})})},showLogin:function(actionAfterLogin,options){try{switch($("#loginBtnNext").prop("disabled",!1),actionAfterLogin){case"reloadProject":application.state.reloadAfterLogin=!0;break;case"openProjectsDialogFromServer":application.state.openProjectsDialogAfterLogin=!0}$("#serverURL").off("keypress").on("keypress",function(event){13===event.keyCode&&(event.preventDefault(),event.stopPropagation(),$("#loginBtnNext").trigger("click"))});var projectMatch,serverMatch,titleName="";application.setLoginState(!1),titleName=null===application.state.connectedServer||""===application.state.connectedServer?((projectMatch=location.href.match(/[?&]project=(.*)/i))?(serverMatch=decodeURIComponent(projectMatch[1]).match(/^(http[s]?:\/\/.*)\/projects\//i),$("#serverURL").val(serverMatch[1])):(serverMatch=decodeURIComponent(location.href).match(/^(https?:\/\/[^\/]+\/[^\/]+)/i))?$("#serverURL").val(serverMatch[1]):$("#serverURL").val(location.href),Lang.application.logIn):""+Lang.application.account,panel.addAndShow(0,"logInContainer",titleName,application.closeLogin,panel.state.widthMedium,application.state.loginHeight,!0,0)}catch(err){application.errorHandling(err.message,0)}},nextButtonLogin:async function(){if($("#errorLogin").hide(),services.validURL($("#serverURL").val().trim())){if(""!=(serverURL=$("#serverURL").val()))if($("#loginBtnNext").prop("disabled",!0),$("#loginSpinner").css("display","block"),await application.isValidServer(serverURL)){var isCustomAuth=await application.isCustomAuth(serverURL);if(isCustomAuth&&"true"==isCustomAuth.result)application.autoLogin(isCustomAuth.scriptURL,(username,jwtToken)=>{try{SGWorld.SGServer.ConnectAsync(serverURL,"xxx","xxx",jwtToken).OnResolve(function(){application.setLoginState(!1)}).OnReject(function(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)})}catch(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)}},fnErrorResult=>{application.state.isCustomAuth=!0,"function"==typeof SkylineAuthentication.getExtraButtons&&SkylineAuthentication.getExtraButtons(imageButtons=>{imageButtons.forEach(element=>{var a=$(`<a href="#"><img src=${element.imageUrl} width="48" height="48"></a>`);a.click(function(){return element.onClick(()=>{try{SGWorld.SGServer.ConnectAsync(serverURL,"xxx","xxx",jwtToken).OnResolve(function(){application.setLoginState(!1)}).OnReject(function(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)})}catch(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)}},errorMessage=>{$("#errorLogin-2").show(),$("#errorLogin-2").text(errorMessage)}),!1}),$("#customAuthExtraButtons").append(a)}),$("#customAuthExtraButtons").show()},errorMessage=>{$("#errorLogin-2").show(),$("#errorLogin-2").text(errorMessage)}),$("#loginSpinner").css("display","none"),$("#loginBtnNext").prop("disabled",!1),$("#logInContainer").hide(),panel.addAndShow(0,"logInContainer-2",Lang.application.logIn,application.closeLogin,panel.state.widthMedium,application.state.loginHeight,!1,0)});else{application.state.isCustomAuth=!1;try{var encodedRedirectURL,SGSVersion=await application.getSGSVersion(serverURL);SGSVersion&&"success"==SGSVersion.result&&1==application.isSGSVersionGreaterThanTargetVersion(SGSVersion.data,"8.0.0.0")?(encodedRedirectURL=encodeURIComponent((parent&&parent.loginRedirectHelper?parent.location:location).href),$("#loginIframe").attr("src",serverURL+"/Admin/telogin.aspx?fusionRedirectURL="+encodedRedirectURL),$("#loginSpinner").css("display","none"),$("#loginBtnNext").prop("disabled",!1),$("#logInContainer").hide(),panel.addAndShow(0,"loginContainerIframe",Lang.application.logIn,application.closeLogin,panel.state.widthMedium,application.state.loginHeight,!1,0)):($("#loginSpinner").css("display","none"),$("#loginBtnNext").prop("disabled",!1),$("#logInContainer").hide(),panel.addAndShow(0,"logInContainer-2",Lang.application.logIn,application.closeLogin,panel.state.widthMedium,application.state.loginHeight,!1,0))}catch(err){application.errorHandling(err.message,0)}}}else $("#errorLogin").show(),$("#errorLogin").text(Lang.application.serverURLInvalid),$("#loginBtnNext").prop("disabled",!1),$("#loginSpinner").css("display","none")}else $("#errorLogin").show(),$("#errorLogin").text(Lang.application.serverURLInvalid)},logoutButton:function(){application.state.isCustomAuth&&"function"==typeof SkylineAuthentication.Logout?(application.state.isCustomAuth=!1,SkylineAuthentication.Logout(result=>{},errorMessage=>{$("#errorLogin-2").show(),$("#errorLogin-2").text(errorMessage)})):(application.state.isCustomAuth=!1,application.logout())},backButtonLogin:function(){application.state.isCustomAuth=!1,$("#customAuthExtraButtons").empty(),$("#customAuthExtraButtons").hide(),$("#logInContainer-2").hide(),$("#logInContainer").show()},logInButton:function(){application.state.isCustomAuth&&"function"==typeof SkylineAuthentication.Login?SkylineAuthentication.Login((username,jwtToken)=>{try{SGWorld.SGServer.ConnectAsync(serverURL,"xxx","xxx",jwtToken).OnResolve(function(){application.setLoginState(!1),application.closeLogin()}).OnReject(function(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)})}catch(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message)}},errorMessage=>{$("#errorLogin-2").show(),$("#errorLogin-2").text(errorMessage)}):application.login()},closeLogin:function(){try{if(application.state.forceLoginMode&&(""==SGWorld.SGServer.GetConnectedUser()||null==SGWorld.SGServer.GetConnectedUser()?application.showLogin():application.state.forceLoginMode=!1),$("#errorLogin-2").text(""),$("#customAuthExtraButtons").empty(),$("#customAuthExtraButtons").hide(),application.state.isCustomAuth)return!1}catch(err){application.errorHandling(err.message,0)}},validateField:function(){try{var disabled=0==$("#serverURL").val().length||0==$("#userName").val().length||0==$("#password").val().length||!services.validURL($("#serverURL").val().trim());return $("#SGSConnectBtn").prop("disabled",disabled),disabled}catch(err){application.errorHandling(err.message,0)}},login:function(){try{null!==event&&event.preventDefault();var objectData={request:"login",username:$("#userName").val(),password:$("#password").val(),isPersistent:!0},match=(JSON.stringify(objectData),(serverURL=document.getElementById("serverURL").value.trim()).match(/^(.+)\/terraexplorerweb(\/|\?|$)/i)),serverURL=serverURL.replace(/\/+$/g,"")+"/",loginUrl=null==match?serverURL:match[1];null===match&&(serverURL+="terraexplorerweb"),null!==loginUrl.match(/^http[s]?:\/\/[^\/]+\/*$/i)&&(loginUrl+="sg"),SGWorld.SGServer.ConnectAsync(loginUrl,objectData.username,objectData.password,!0).OnResolve(function(){application.setLoginState(!1),application.closeLogin(),application.state.reloadAfterLogin?(application.state.reloadAfterLogin=!1,SGWorld.Project.Open(this.state.projectPath)):application.state.openProjectsDialogAfterLogin?(application.state.openProjectsDialogAfterLogin=!1,addContent.loadLayer("TerraExplorerProjectDesktop",0)):"force"==application.state.serverConfig.loginMode&&application.renderPage()}).OnReject(function(error){$("#errorLogin-2").show(),$("#errorLogin-2").text(error),application.errorHandling(error,1)})}catch(e){$("#errorLogin-2").show(),$("#errorLogin-2").text(e.message),application.errorHandling(e.message,1)}},OnLoginAjaxError:function(e){$("#errorLogin-2").show(),e.responseJSON?$("#errorLogin-2").text(e.responseJSON.resultMessageDescription):$("#errorLogin-2").text(Lang.application.errorNoServer)},logout:function(){return new Promise(async(resolve,reject)=>{try{SGWorld.SGServer.DisconnectAsync().OnResolve(function(){application.setLoginState(!1),panel.close(!1),resolve()}).OnReject(function(e){application.errorHandling(e.message,0),reject(e)})}catch(e){application.errorHandling(e.message,0)}})},setLoginState:function(fromOpen){try{var userDisplayName,fullNameArray,firstLetterFirstName,firstLetterFamilyName;application.state.connectedServer=SGWorld.SGServer.GetConnectedServer(),""!=application.state.connectedServer&&null!=application.state.connectedServer?(application.state.connectedUser=SGWorld.SGServer.GetConnectedUser(),firstLetterFirstName=(fullNameArray=(userDisplayName=SGWorld.SGServer.GetUserDisplayName()).toUpperCase().split(" "))[0]?fullNameArray[0][0]:"",firstLetterFamilyName=1<fullNameArray.length?fullNameArray[1][0]:fullNameArray[0][1],$("#logInTitle").text(firstLetterFirstName+firstLetterFamilyName),$("#logInTitle").prop("title",`${Lang.application.loggedIn}: ${SGWorld.SGServer.GetUserDisplayName()} , `+application.state.connectedServer),$("#LoginTitleDivID").addClass("LoginTitleOn"),$("#LoginTitleDivID").addClass("startPageNoLogin-no-hover"),$("#loggedInDetailsCircleId").text(firstLetterFirstName+firstLetterFamilyName),$("#accountName").text(userDisplayName),$("#accountEmail").text(application.state.connectedUser!==userDisplayName?application.state.connectedUser:""),$("#accountServerURL").text(application.state.connectedServer),$("#serverURLLabel").hide(),$("#errorLogin").text(""),$("#errorLogin-2").text(""),$("#serverURL").hide(),$("#userName").hide(),$("#password").val(""),$("#loginErrorDiv").hide(),$("#loginBtnNext").hide(),$("#logOutDiv").show(),$("#logOut").prop("disabled",!1),$("#logOut").show()):(application.state.connectedServer=null,application.state.connectedUser=null,$("#logInTitle").text(""),$("#logInTitle").prop("title",Lang.application.clickToLogin),$("#LoginTitleDivID").removeClass("LoginTitleOn"),$("#LoginTitleDivID").removeClass("startPageNoLogin-no-hover"),$("#loginErrorDiv").show(),$("#serverURLLabel").show(),$("#serverURL").show(),$("#serverURL").val(""),$("#serverURL").prop("disabled",!1),$("#userName").val(""),$("#userName").prop("disabled",!1),$("#logOut").prop("disabled",!0),$("#SGSConnectBtn").show(),$("#loginBtnNext").show(),$("#logOut").hide(),$("#logOutDiv").hide(),$("#loggedInDetailsCircleId").text(""),$("#accountName").text(""),$("#accountEmail").text(""),$("#accountServerURL").text(""))}catch(err){application.errorHandling(err.message,0)}},dummy:null};