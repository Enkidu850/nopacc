var analysis={state:{},initState:function(){try{analysis.state={queryOn:!1,sunOn:!1,shadowOn:!1,cloudsOn:!1,contourOn:!1,slopeOn:!1,toolLastDiv:null,toolURLOpened:!1,tools:[{id:"distanceBtn",name:""+Lang.analysis.distance,title:""+Lang.analysis.distanceMeasurement,icon:"./images/icons/distanceMeasurement.svg",action:`analysis.openAnalysisToolURL('./Tools/DistanceMeasurement/distanceMeasurement.html','${Lang.analysis.distanceMeasurement}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"areaBtn",name:""+Lang.analysis.area,title:""+Lang.analysis.areaMeasurement,icon:"./images/icons/areaMeasurement.svg",action:`analysis.openAnalysisToolURL('./Tools/AreaMeasurement/AreaMeasurement.html','${Lang.analysis.areaMeasurement}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"volumeBtn",name:""+Lang.analysis.volume,title:""+Lang.analysis.volumeMeasurement,icon:"./images/icons/volume.svg",action:`analysis.openAnalysisToolURL('./Tools/Volume/Volume.html','${Lang.analysis.volumeMeasurement}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"profileBtn",name:""+Lang.analysis.profile,title:""+Lang.analysis.terrainProfile,icon:"./images/icons/profile.svg",action:`analysis.openAnalysisToolURL('./Tools/TerrainProfile/TerrainProfile.html','${Lang.analysis.terrainProfile}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"viewshedBtn",name:""+Lang.analysis.viewshed,title:""+Lang.analysis.viewshed,icon:"./images/icons/viewshed.svg",url:"",action:"analysis.startViewshed()"},{id:"swipeCompareBtn",name:""+Lang.analysis.compare,title:""+Lang.analysis.swipeComparison,icon:"./images/icons/swipeCompare.svg",action:`analysis.openAnalysisToolURL('./Tools/ImageComparison/MeshComparisonPopup.html','${Lang.analysis.swipeComparison}',true,panel.state.widthMedium,panel.state.heightSmall)`}],toolsPlus:[{id:"photoInspectorBtn",name:""+Lang.analysis.photoInspector,title:""+Lang.analysis.photoInspectorTitle,icon:"./images/icons/photoInspector.svg",action:`analysis.openPhotoInspectorTool('${Lang.analysis.photoInspector}',true,panel.state.widthMedium,panel.state.heightXLarge)`},{id:"clearPathBtn",name:""+Lang.analysis.clearPath,title:""+Lang.analysis.clearPathTitle,icon:"./images/icons/clearPath.svg",action:`analysis.openAnalysisToolURL('./Tools/clearPath/clearPath.html?type=0','${Lang.analysis.clearPath}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"HighLowBtn",name:""+Lang.analysis.highLow,title:""+Lang.analysis.highLowTitle,icon:"./images/icons/highLow.svg",action:`analysis.openAnalysisToolURL('./Tools/clearPath/clearPath.html?type=1','${Lang.analysis.highLow}',true,panel.state.widthSmall,panel.state.heightMedium)`},{id:"CrossSectionBtn",name:""+Lang.analysis.crossSection,title:""+Lang.analysis.crossSection,icon:"./images/icons/crossSection.svg",action:`analysis.openAnalysisToolURL('./Tools/crossSection/crossSection.html','${Lang.analysis.crossSection}',true,panel.state.widthSmall,panel.state.heightMedium)`}],toolsCount:0,tabs:3,inViewshedEditing:!1,viewshedHiddenColor:"#ff0000",viewshedVisibileColor:"#00ff00",photoInspectorViewerMode:!1,last:null}}catch(err){application.errorHandling(err.message,0)}},init:function(){try{analysis.initState(),analysis.render(),analysis.state.tools.forEach(function(item){analysis.addAnalysisTool(item)}),application.state.TEPLUS&&analysis.state.toolsPlus.forEach(function(item){analysis.addAnalysisTool(item)}),analysis.showTab(0);var hour=new Date(SGWorld.DateTime.FixedLocalTime).getHours();$("#timeSlider").val(hour),analysis.setTime(hour),SGWorld.DateTime.DisplaySun&&this.setSun(),SGWorld.AttachEvent("OnObjectAction",analysis.OnObjectAction)}catch(err){application.errorHandling(err.message,0)}},render:function(){try{$("body").append(`
        <div id="QueryMain" class="queryResultGrid" style="display:none">
            <div id="queryHelper" class="queryClickResult helper"> ${Lang.analysis.queryHelp}</div>
            <div id="queryClickResult" class="queryClickResult s9"></div>
            <div id="queryHoverResult" class="queryHoverResult s9"></div>
        </div>`),$("body").append(`  
        <div id="analysisMain" class="panelContent" style="display:none">
        <div class="grid3 tabs">
            <div class="gridCenter tab tabSelected i18n" id="analysisTabButton0" onclick="analysis.showTab(0)">${Lang.analysis.tools} </div>
            <div class="gridCenter tab  i18n" id="analysisTabButton1" onclick="analysis.showTab(1)">${Lang.analysis.environment} </div>
            <div class="gridCenter tab  i18n" id="analysisTabButton2" onclick="analysis.showTab(2)">${Lang.analysis.maps} </div>
        </div>

        <div id="analysisTbl0" class="grid3 gridCenter ">     </div>

            <div id="analysisTbl1" class="grid3 gridPadding gridCenter " > 
                <div id="sunBtnDiv"> <button id="sunBtn" class=" ButtonLarge  i18n" onclick="analysis.setSun()" title="${Lang.analysis.turnSunlight}"><img src="./images/icons/Sun.svg"><br><span>${Lang.analysis.light}</span></button></div>
                <div id="shadowBtnDiv"> <button id="shadowBtn" class=" ButtonLarge  i18n" onclick="analysis.setShadow()" title="${Lang.analysis.turnShadow}"><img src="./images/icons/Shadow.svg"><br><span>${Lang.analysis.shadow}</span></button></div>
                <div id="cloudsBtnDiv"> <button id="cloudsBtn" class=" ButtonLarge  i18n" onclick="analysis.setClouds()" title="${Lang.analysis.turnClouds}"><img src="./images/icons/Clouds.svg"><br><span>${Lang.analysis.clouds}</span></button></div>
                <div id="timeSliderHeaderDiv" class="gridDouble propertiesTitle spacerAbove"><img class="imgSmall" src="./images/icons/timeSlider.svg" />${Lang.analysis.timeSlider}</div>
                <div id="timeSliderHourDiv" class="gridRight"><span id="timeSliderText">0:00</span>h </div>
                <div id="timeSliderDiv" class="gridTriple gridSlider"> <input id="timeSlider"  oninput="analysis.setTime(this.value)" type="range" min="0" max="23"> </div>
                <div id="fodHeaderDiv" class="gridTriple propertiesTitle"><img class="imgSmall" src="./images/icons/fog.svg" />${Lang.analysis.fog}</div>
                <div id="fodDiv" class="gridTriple gridSlider"> <input id="fogSlider"  oninput="analysis.setFog(this.value)" type="range" min="0" max="100" value="0"> </div>
            </div>
                           
            <div id="analysisTbl2" class="grid3 gridCenter " > 
                <div id="contourBtnDiv"> <button id="contourBtn" class=" ButtonLarge i18n" onclick="analysis.setContour()" title="${Lang.analysis.showContour}"><img src="./images/icons/contour.svg"><br><span>${Lang.analysis.contour}</span></button> </div>
                <div id="slopeBtnDiv"> <button id="slopeBtn" class=" ButtonLarge i18n" onclick="analysis.setSlope()" title="${Lang.analysis.showSlope}"><img src="./images/icons/slope.svg"><br><span>${Lang.analysis.slope}</span></button> </div>
            </div>
        </div>`)}catch(err){application.errorHandling(err.message,0)}},showTab:function(tabIndex){try{for(var i=0;i<analysis.state.tabs;i++)i==tabIndex?($("#analysisTbl"+i).show(),$("#analysisTbl"+i).css("opacity","1"),$("#analysisTabButton"+i).addClass("tabSelected")):($("#analysisTbl"+i).hide(),$("#analysisTbl"+i).css("opacity","0"),$("#analysisTabButton"+i).removeClass("tabSelected"))}catch(err){application.errorHandling(err.message,0)}},addAnalysisTool:function(item){try{analysis.state.toolsCount++;var button=$(`<div id="${item.id}Div"><button id="${item.id}" class=" inlineBlock ButtonLarge i18n" onclick="${item.action}" title="${item.title}"><img src="${item.icon}"><br><span>${item.name}</span></button></div>`);$("#analysisTbl0").append(button)}catch(err){application.errorHandling(err.message,0)}},openPhotoInspectorTool:function(toolName,backButton,width,height){try{application.state.isMobile&&(height=panel.state.heightLarge);var url,photosLayer=analysis.GetParamValue("photosLayer","").replace(/%20/g," "),inspectionLayer=analysis.GetParamValue("inspectionLayer","").replace(/%20/g," "),photosLayerID="",inspectionLayerID="";""!=photosLayer&&(photosLayerID=SGWorld.ProjectTree.FindItem(photosLayer)),""!=inspectionLayer&&(inspectionLayerID=SGWorld.ProjectTree.FindItem(inspectionLayer)),url=""!=photosLayer?`./Tools/photoInspector/Photo.html?photosLayer=${photosLayerID}&inspectionLayer=${inspectionLayerID}&photoInspectorViewer=`+analysis.state.photoInspectorViewerMode:`./Tools/photoInspector/photoInspector.html?${document.location.href.split("?")[1]}&photoInspectorViewer=`+analysis.state.photoInspectorViewerMode,analysis.openAnalysisToolURL(url,toolName,backButton,width,height,!0)}catch(err){application.errorHandling(err.message,0)}},GetParamValue:function(findParam,defaultValue){var arr=document.location.href.split("?");if(!(arr.length<=1))for(var arr=arr[1].split("&"),i=0;i<arr.length;i++)if(0==arr[i].indexOf(findParam)&&arr[i].indexOf("=")==findParam.length)return(arr=arr[i].split("="))[1];return defaultValue},openAnalysisToolURL:function(url,toolName,backButton,width,height,expandMode){try{analysis.closeViewshed(),null==backButton&&(backButton=!0);var sign=-1==url.indexOf("?")?"?":"&",url=url+sign+`lang=${Lang.code}&root=`+projectTree.getMyDataGroup();panel.addAndShow(1,url,toolName,analysis.closeAnalysisTool,width,height,!backButton,expandMode),analysis.state.toolURLOpened=!0}catch(err){application.errorHandling(err.message,0)}},closeAnalysisTool:function(){try{analysis.state.toolURLOpened=!1,analysis.closeViewshed(),projectTree.refreshMyData()}catch(err){application.errorHandling(err.message,0)}},closeByTool:function(){try{analysis.state.toolURLOpened&&panel.back()}catch(err){application.errorHandling(err.message,0)}},setSun:function(){try{analysis.state.sunOn=!analysis.state.sunOn,services.highlightButton("sunBtn",analysis.state.sunOn),analysis.state.sunOn||analysis.state.shadowOn&&this.setShadow(),SGWorld.DateTime.DisplaySun=analysis.state.sunOn}catch(err){application.errorHandling(err.message,0)}},setShadow:function(){try{analysis.state.shadowOn=!analysis.state.shadowOn,application.execute(2118,0),services.highlightButton("shadowBtn",analysis.state.shadowOn),!analysis.state.shadowOn||analysis.state.sunOn||this.setSun()}catch(err){application.errorHandling(err.message,0)}},setClouds:function(){try{analysis.state.cloudsOn=!analysis.state.cloudsOn,application.execute(1154,analysis.state.cloudsOn),services.highlightButton("cloudsBtn",analysis.state.cloudsOn)}catch(err){application.errorHandling(err.message,0)}},startQuery:function(){try{analysis.state.queryOn=!0,$("#queryHelper").show(),$("#queryClickResult").html(""),$("#queryHoverResult").html(""),application.execute(1023,0)}catch(err){application.errorHandling(err.message,0)}},stopQuery:function(){try{analysis.state.queryOn=!1,application.isCommandChecked(1023,0)&&application.execute(1023,0)}catch(err){application.errorHandling(err.message,0)}},showQueryMessage:function(message){try{var xmlString=(xmlString=message.substring(message.indexOf("<"))).substring(0,xmlString.lastIndexOf(">")+1),xml=(new DOMParser).parseFromString(xmlString,"text/xml"),xslFile=services.abspath()+"/TerraExplorerApp.Emscripten.Resources/ObjectQueryInfo.xsl",xsl=services.loadXMLDoc(xslFile),html=services.convertXmlToHtml(xml,xsl);if($("#queryHelper").hide(),$("#queryClickResult").html(html),$("#queryClickResult").html(analysis.translateString($("#queryClickResult").html())),null!=settings.state.DisplayEPSG&&!isNaN(settings.state.DisplayEPSG))try{var coordSys=SGWorld.CoordServices.CreateCoordinateSystem(""),digits=(coordSys.InitFromEPSG(settings.state.DisplayEPSG),4326==settings.state.DisplayEPSG?6:1),coord=($("#queryClickResult").append(`<div class="propertiesTitle">${Lang.analysis.coordinateSystem} : ${settings.state.DisplayCS}</div>`),SGWorld.CoordServices.ReprojectEx(SGWorld.Terrain.CoordinateSystem,coordSys,application.state.PointerPos.X,application.state.PointerPos.Y,application.state.PointerPos.Altitude));$("#queryClickResult").append(`<table class='queryTbl'><tr><td><b>${Lang.analysisReplace.Longitude}</b></td><td> ${coord.X.toFixed(digits)} </td></tr><tr><td><b>${Lang.analysisReplace.Latitude}</b></td><td> ${coord.Y.toFixed(digits)} </td></tr></table> `)}catch(err){return!0}try{var objectName,cursor=SGWorld.Window.GetMouseInfo(),objectID=SGWorld.Window.PixelToObjects(cursor.X,cursor.Y,-1).Item(0).ID;SGWorld.ProjectTree.GetNextItem(objectID,15)!=projectTree.getMyDataGroup()&&SGWorld.ProjectTree.GetNextItem(objectID,15)!=projectTree.getDrawingObjectsGroup()||(objectName=SGWorld.ProjectTree.GetItemName(objectID),panel.close(!1),analysis.stopQuery(),projectTree.openPropertiesSheet(objectID,Lang.projectTree.properties+": "+objectName,"projectTree.state.style"))}catch(err){}}catch(err){application.errorHandling(err.message,0)}},showQueryHover:function(message){try{0<=message.indexOf("N/A")&&(message=""),message=services.clearHTMLString(message),message=analysis.translateString(message),$("#queryHoverResult").html("<div class='seperator'></div>"+message)}catch(err){application.errorHandling(err.message,0)}},translateString:function(str){try{return Object.keys(Lang.analysisReplace).forEach(element=>{str=str.replace(new RegExp(element,"g"),Lang.analysisReplace[element])}),str}catch(err){application.errorHandling(err.message,0)}},setContour:function(){try{analysis.state.contourOn=!analysis.state.contourOn,services.highlightButton("contourBtn",analysis.state.contourOn),analysis.state.contourOn&&analysis.state.slopeOn&&this.setSlope(),application.execute(2216,0)}catch(err){application.errorHandling(err.message,0)}},setSlope:function(){try{analysis.state.slopeOn=!analysis.state.slopeOn,services.highlightButton("slopeBtn",analysis.state.slopeOn),analysis.state.slopeOn&&analysis.state.contourOn&&this.setContour(),application.execute(2217,0)}catch(err){application.errorHandling(err.message,0)}},setTime:function(sliderVal){try{var dateTime=new Date;dateTime.setHours(sliderVal,0,0),SGWorld.DateTime.FixedLocalTime=dateTime,$("#timeSliderText").text(Math.floor(sliderVal).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1})+":00")}catch(err){application.errorHandling(err.message,0)}},setFog:function(sliderVal){try{sliderVal<5?application.execute(2208,0):(application.execute(2208,1),application.execute(2204,+sliderVal))}catch(err){application.errorHandling(err.message,0)}},startViewshed:function(){try{analysis.state.inViewshedEditing?analysis.closeViewshed():(analysis.state.inViewshedEditing=!0,application.errorHandling(Lang.analysis.viewshedAdd,2),application.execute(2117,0),services.highlightButton("viewshedBtn",!0))}catch(err){application.errorHandling(err.message,0)}},closeViewshed:function(){try{analysis.state.inViewshedEditing&&(SGWorld.Window.SetInputMode(0),analysis.state.inViewshedEditing=!1,services.highlightButton("viewshedBtn",!1))}catch(err){application.errorHandling(err.message,0)}},viewshedFOVChange:function(itemID){try{var viewshed=SGWorld.Creator.GetObject(itemID);119<viewshed.FieldOfViewX&&viewshed.Distance<=2e3?(viewshed.FieldOfViewX=360,viewshed.FieldOfViewY=180):viewshed.FieldOfViewY=Math.max(5,.67*viewshed.FieldOfViewX)}catch(err){application.errorHandling(err.message,0)}},startViewshedQuery:function(itemID){try{var url="./Tools/viewshedQuery/viewshedQuery.html?itemID="+itemID;analysis.openAnalysisToolURL(url,Lang.analysis.viewshedQuery,!0,null,null)}catch(err){application.errorHandling(err.message,0)}},OnObjectAction:function(ObjectID,Action){try{var viewshed;analysis.state.inViewshedEditing&&(31==Action.Code&&((viewshed=SGWorld.Creator.GetObject(ObjectID)).FieldOfViewY=viewshed.FieldOfViewX,viewshed.Quality=1,viewshed.TreeItem.Name=Lang.analysis.viewshed,viewshed.Distance=Math.min(viewshed.Distance,8e3),SGWorld.ProjectTree.SetParent(ObjectID,projectTree.getMyDataGroup()),projectTree.openPropertiesSheet(ObjectID,Lang.projectTree.edit,"projectTree.state.style"),viewshed.HiddenAreaColor=SGWorld.Creator.CreateColor(services.hexToRgb(analysis.state.viewshedHiddenColor).r,services.hexToRgb(analysis.state.viewshedHiddenColor).g,services.hexToRgb(analysis.state.viewshedHiddenColor).b,100),viewshed.VisibleAreaColor=SGWorld.Creator.CreateColor(services.hexToRgb(analysis.state.viewshedVisibileColor).r,services.hexToRgb(analysis.state.viewshedVisibileColor).g,services.hexToRgb(analysis.state.viewshedVisibileColor).b,100)),15!=Action.Code&&31!=Action.Code||analysis.closeViewshed())}catch(err){application.errorHandling(err.message,0)}},dummy:null};